<!doctype html><html lang=en><head><title>Мikrotik RouterOS Configuration Management с помощью скриптов и какой-то там матери :: Админская фамилия</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Жизненный цикл сети часто переживает закономерный рост. В это время начинают появляться десятки и сотни устройств, конфигурация которых однотипна. Например, это могут быть маршрутизаторы в филиалах, которые имеют одинаковые настройки и отличаются только IP адресами, паролями на VPN и Wi-Fi. Внесение даже незначительных изменений на десяток устройств потребует значительного времени и концентрации.
Для управления сотнями и тысячами устройств весь цивилизованный мир уже давно использует специальные системы менеджмента конфигураций: Ansible, Chef, Puppet."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://bubnovd.net/blogger/mikrotik-routeros-configuration-management-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B2-%D0%B8-%D0%BA%D0%B0%D0%BA%D0%BE%D0%B9-%D1%82%D0%BE-%D1%82%D0%B0%D0%BC-%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8/><link rel=stylesheet href=https://bubnovd.net/assets/style.css><link rel=stylesheet href=https://bubnovd.net/assets/blue.css><link rel=apple-touch-icon href=https://bubnovd.net/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://bubnovd.net/img/favicon/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Мikrotik RouterOS Configuration Management с помощью скриптов и какой-то там матери"><meta property="og:description" content="Жизненный цикл сети часто переживает закономерный рост. В это время начинают появляться десятки и сотни устройств, конфигурация которых однотипна. Например, это могут быть маршрутизаторы в филиалах, которые имеют одинаковые настройки и отличаются только IP адресами, паролями на VPN и Wi-Fi. Внесение даже незначительных изменений на десяток устройств потребует значительного времени и концентрации.
Для управления сотнями и тысячами устройств весь цивилизованный мир уже давно использует специальные системы менеджмента конфигураций: Ansible, Chef, Puppet."><meta property="og:url" content="https://bubnovd.net/blogger/mikrotik-routeros-configuration-management-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B2-%D0%B8-%D0%BA%D0%B0%D0%BA%D0%BE%D0%B9-%D1%82%D0%BE-%D1%82%D0%B0%D0%BC-%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8/"><meta property="og:site_name" content="Админская фамилия"><meta property="og:image" content="https://bubnovd.net/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2017-11-20 09:56:00 +0000 UTC"></head><body class=blue><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=https://bubnovd.net/><div class=logo>Terminal</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://bubnovd.net/blogger/mikrotik-routeros-configuration-management-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B2-%D0%B8-%D0%BA%D0%B0%D0%BA%D0%BE%D0%B9-%D1%82%D0%BE-%D1%82%D0%B0%D0%BC-%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8/>Мikrotik RouterOS Configuration Management с помощью скриптов и какой-то там матери</a></h1><div class=post-meta><span class=post-date>2017-11-20</span>
<span class=post-author>:: map[name:devi1 uri:https://www.blogger.com/profile/05777499482649623616]</span>
<span class=post-reading-time>:: 7 min read (1342 words)</span></div><span class=post-tags>#<a href=https://bubnovd.net/tags/configuration-management/>configuration management</a>&nbsp;
#<a href=https://bubnovd.net/tags/routeros/>routeros</a>&nbsp;
#<a href=https://bubnovd.net/tags/mikrotik/>Mikrotik</a>&nbsp;
#<a href=https://bubnovd.net/tags/script/>script</a>&nbsp;</span><div class=post-content><div><p>Жизненный цикл сети часто переживает закономерный рост. В это время начинают появляться десятки и сотни устройств, конфигурация которых однотипна. Например, это могут быть маршрутизаторы в филиалах, которые имеют одинаковые настройки и отличаются только IP адресами, паролями на VPN и Wi-Fi. Внесение даже незначительных изменений на десяток устройств потребует значительного времени и концентрации.</p><p>Для управления сотнями и тысячами устройств весь цивилизованный мир уже давно использует специальные системы менеджмента конфигураций: <a href=https://www.ansible.com/>Ansible</a>, <a href=https://www.chef.io/chef/>Chef</a>, <a href=https://puppet.com/>Puppet</a>. Каждая из них имеет свои плюсы и минусы.</p><p>Но для десяти-двадцати устройств не каждый захочет выделять отдельный сервер с такой системой. Поэтому в ход идут скрипты, SSH, FTP и куча матов, когда всё это поделие роняет сразу все филиалы.</p><p>Видео для привлечения внимания<br>Это визуализация запросов от роутеров к системе, о которой идет речь в этом посте.</p><p>Я тоже накостылил подобную систему в соответствии со своими потребностями и расскажу о ней.</p><p>Мои требования к системе централизованного управления:</p><ul><li>Надежность.  Система должна работать независимо от скорости соединения или после месячного оффлайна</li><li>Приемлемая скорость актуализации конфигурации. Если девайс месяц не включался, то свежий конфиг он должен применить за обозримое время</li><li>Низкая нагрузка на каналы связи и ресурсы сервера. Обновление конфигурации не должно положить интернет в ЦОДе и процессор машины</li><li>Масштабируемость. Систему можно увеличить в 5-10 раз</li><li>Разделение устройств по группам. Применение разных настроек к разным группам</li><li>Обратная связь о применении конфигурации </li><li>Постараться не использовать Flash память микротика по причине её износа</li></ul><p>Из требований родились идеи к реализации:</p><ul><li>Чтобы обеспечить применение всех изменений, роутер должен сам обращаться за конфигурацией</li><li>Актуализация обеспечивается за счет опроса сервера раз в час</li><li>Чтобы не нагружать ресурсы и каналы, роутеры должны обращаться за обновлениями в разное время</li><li>Для оповещений использовать Telegram</li><li>Следование принципу <a href=https://ru.wikipedia.org/wiki/KISS_(%D0%BF%D1%80%D0%B8%D0%BD%D1%86%D0%B8%D0%BF)>KISS</a></li></ul><p>Для работы системы понадобится только web сервер. В моем случае apache. Как его <a href=http://www.bubnovd.net/2011/03/debian.html>установить</a> и <a href=http://www.bubnovd.net/2011/08/linux-server-2-iptables.html>настроить</a> я <a href=http://www.bubnovd.net/2011/10/blog-post.html>рассказывать</a> не буду, к тому же необязательно это должен быть апач.</p><p>Логика такая: на веб сервере лежат RouterOS скрипты, с определенным именованием. Имя скрипта указывает на его версию и группу устройств, для которой должна примениться конфигурация. Маршрутизаторы с периодичностью раз в час обращаются к серверу за новым конфигом. Если новый конфиг есть, то он скачивается на роутер и выполняется. Если конфига нет - ничего не скачивается, что позволяет не дергать лишний раз быстроубиваемую память.</p><p>Чтобы начать применять подобную систему, надо привести конфиги всех роутеров к одному стандарту. К примеру, не так давно в RouterOS появилась новая фича: Interface List. Теперь можно одним правилом в фаерволе заменить несколько правил, если их надо применить к разным интерфейсам. Наш скрипт должен добавить в интерфейс-лист интерфейс, который &ldquo;смотрит&rdquo; к провайдеру. На одном роутере это может быть eth1, на другом PPPoE, на третьем - вообще wlan1.</p><p>Как в таком случае поступить? Надо как-то выделить внешние интерфейсы. Например, добавить к ним комментарий &ldquo;WAN&rdquo;.<br>Также стОит привести к одному виду фаервол, Queues - вообще всё, что есть на роутерах. И создать отдельную учетную запись,  с правами которой будут выполняться скрипты. Как создать скрипт для быстрой настройки роутеров я расскажу в следующем посте.</p><p>Принцип именования скриптов: A000, где А - группа устройств, а номер - версия скрипта.</p><p>Каждому роутеру в планировщик добавляем такие строки:</p><pre tabindex=0><code>/system scheduler  
/tool fetch url=&#34;http://rbconf.bubnovd.net/A001&#34; user=mikrotik-ninja password=mikrotik-ninja.ru  
  
/import A001  
</code></pre><p>Это задание скачивает с сервера скрипт и выполняет его. Для обеспечения хоть какой-то безопасности, доступ к серверу только по паролю, который указан в задании.</p><p>Сами скрипты лежат на сервере и выглядят примерно так:</p><pre tabindex=0><code>/log info message=&#34;.....................Autoconfiguration started.....................&#34;  
#Версия внедряемой конфигурации  
#Описание задачи, которую выполняет скрипт: Удаление пользователя  
#Первая часть скрипта нужна для только для определения  версии конфига, который нужно применить следующим  
:local ver  
:set $ver A001  
#Версия следующей конфигурации  
:local verNext  
#Версия предыдущей конфигурации  
:local verPrev  
:set $verNext (&#34;A&#34; . \[tostr (\[tonum \[pick $ver 1 4\]\] + 1)\])  
:set $verPrev (&#34;A&#34; . \[tostr (\[tonum \[pick $ver 1 4\]\] - 1)\])  
#Добавляем нули, если надо  
        if (\[:len $verNext\] =2) do={  
                :set $verNext (\[pick $verNext 0 1\] . &#34;00&#34; . \[pick $verNext (\[len $verNext\] -1) (\[len $verNext\])\])} else={  
                if (\[:len $verNext\] =3) do={  
                        :set $verNext (\[pick $verNext 0 1\] . &#34;0&#34; . \[pick $verNext (\[len $verNext\] -2) (\[len $verNext\])\])} else={}}  
  
        if (\[:len $verPrev\] =2) do={  
                :set $verPrev (\[pick $verPrev 0 1\] . &#34;00&#34; . \[pick $verPrev (\[len $verPrev\] -1) (\[len $verPrev\])\])} else={  
                if (\[:len $verPrev\] =3) do={  
                        :set $verPrev (\[pick $verPrev 0 1\] . &#34;0&#34; . \[pick $verPrev (\[len $verPrev\] -2) (\[len $verPrev\])\])} else={}}  
\# Вторая часть скрипта - наша рабочая конфигурация  
#####  
#####Тут код конфигурации  
#####  
if (\[len \[/user find name=&#34;prosvirnin&#34;\]\]&gt;0) do={/user remove \[find name=&#34;prosvirnin&#34;\]} else={/log info message=&#34;User not exist&#34;}  
#####  
#/log info message=&#34;Creating script $ver&#34;  
#/system script add name=$ver source=&#34;/log info message=done&#34;  
#/log info message=&#34;Script $ver created. Starting&#34;  
#/system script run $ver  
#/log info message=&#34;Removing script $ver&#34;  
#/system script remove $ver  
\##### Или в скрипте выше  
\# Третья часть - настройка планировщика для следующего изменения, оповещение и чистка файлов  
/system scheduler set autoconf on-event=&#34;/tool fetch url=\\&#34;http://rbconf.bubnovd.net/$verNext\\&#34; user=mikrotik-ninja password=mikrotik-ninja.ru\\r\\n  
/import $verNext&#34;  
/log info message=&#34;...................Autoconfiguration complete...................&#34;  
/delay 3  
#Удаляем остатки предыдущих скриптов, если не удалились  
if (\[:len \[/file find name~&#34;sendMessage&#34;\]\] &gt;0) do={/file remove \[/file find name~&#34;sendMessage&#34;\]} else={/log info message=&#34;No item for delete&#34;}  
if (\[:len \[/file find name=&#34;$verPrev&#34;\]\] &gt;0) do={/file remove \[/file find name=&#34;$verPrev&#34;\]} else={/log info message=&#34;No item for delete&#34;}  
/delay 3  
#Отправляем уведомление о выполнении  
:local name \[/system identity get name\]  
/tool fetch keep-result=no url=&#34;https://api.telegram.org/bot-nomer-bota:tut-vasha-ssylka/sendMessage\\?chat\_id=-12345678&amp;text=$ver is complete on $name&#34;  
/delay 3  
if (\[:len \[/file find name~&#34;sendMessage&#34;\]\] &gt;0) do={/file remove \[/file find name~&#34;sendMessage&#34;\]} else={/log info message=&#34;No item for delete&#34;}  
/delay 3  
/file remove $ver  
</code></pre><p>Сначала описывается версия конфига и каким будет следующая версия. Затем после комментария &ldquo;#####Тут код конфигурации&rdquo; перечисляются команды, которые должен выполнить роутер. Иногда роутер должен выполнить сложный скрипт. На этот случай есть закомментированный блок кода со скриптом. Сам сложный скрипт нужно описать в поле <code>source="tut\_sam\_script"</code></p><p>После выполнения команд меняется задание в планировщике - указываем следующую версию скрипта, который надо применить. С этого момента роутер будет пытаться скачать его с сервера. Дальше шлём уведомление и удаляем файлы, которые могли создастся в ходе выполнения задания. Как слать оповещения в Telegram описано на <a href=https://1spla.ru/blog/telegram_bot_for_mikrotik>бескрайних</a> <a href=https://habrahabr.ru/post/314108/>просторах</a> интернета и повторяться я не буду.</p><p>Очень важно предусмотреть в скрипте всё возможное и невозможное и каждая команда должна начинаться с проверки <code>if (...) do={</code> , а заканчиваться <code>} else={/log info message="User not exist"}</code> . У одного из моих роутеров был баг, из-за которого не отображался wireless интерфейс. И без проверки его существования, скрипт просто вываливался с ошибкой. А значит, не менялась запись в планировщике и следующий скрипт тоже не выполнялся.</p><p>Перед применением конфигурации на всю сеть нужно проверить правильность написания скрипта - даже опытный скриптописатель может чего-то не учесть и хорошо, если это какая-то мелочь и она не положит всю сеть. Поэтому перед созданием нового файла конфигурации, я проверяю  команды на работающем в продакшене роутере. А затем использую отдельную группу из 20 разнотипных роутеров (в основном это разный тип подключения к сети, остальные настройки везде идентичны) для тестирования скрипта. Эти роутеры опрашивают сервер чаще, чем остальные и после применения настроек я какое-то время наблюдаю за их поведением, а затем распространяю нововведения на остальную сеть.</p><p>Чего не хватает в моём подходе:</p><ul><li><strong>Безопасность</strong>. Хоть доступ на сервер со скриптами ограничен паролем, но этот пароль в открытом виде хранится на роутерах. Вся конфигурация передается по сети в открытом виде. У меня всё это летает внутри шифрованного VPN и я запрещаю вам использовать это на нешифрованных публичных каналах! Внутреннего нарушителя тоже никто не отменял и внутри VPN это не очень безопасно. Можно Нужно! использовать https вместо http.</li><li><strong>Информативные оповещения</strong>. При возникновении ошибки, неплохо было бы сообщать о ней</li><li><strong>Возможны только изменения</strong>. Хочется ещё и читать конфиги и выделять места, отличные от стандарта. Но это задача уже другого класса систем</li></ul><p>Через полгода после внедрения этой системы, на <a href=https://mum.mikrotik.com/2016/RU/agenda/EN>встрече пользователей Mikrotik</a> Михаил Москалев   рассказал об аналогичном подходе. Михаил продвинулся дальше и применил модульный подход к конфигурации. Его презентацию можно посмотреть по <a href=https://mum.mikrotik.com//presentations/RU16/presentation_3759_1475646696.pdf>ссылке</a>.<br>Такой же подход использует система блокировки рекламы для Mikrotik <a href=https://stopad.cgood.ru/>https://stopad.cgood.ru/</a> . <br>Постоянный докладчик нашей <a href=https://sysadminka.org/>#Sysadminka</a> написал свою систему управления конфигурациями. Она доступна на <a href=https://github.com/xoma9/ops-tool>github</a>. Посмотреть можно на <a href="https://www.youtube.com/watch?v=ZOOsY4r6qks">YouTube</a>.</p><p>В следующем посте я опишу ещё один свой скриптик с использованием Excel, который помогает младшим админам настраивать первичную конфигурацию роутеров без вникания в WinBox и настройки RouterOS.</p><p>P.S.: Видео в посте создано с помощью <a href=http://www.bubnovd.net/2017/06/grep.html>grep</a> и <a href=http://logstalgia.io/>logstalgia</a>.</p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bubnovd-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://bubnovd.net/assets/main.js></script>
<script src=https://bubnovd.net/assets/prism.js></script></div></body></html>