<!doctype html><html lang=en><head><title>Автоопределение прокси в домене Windows :: Админская фамилия</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Автоматизация - дело хорошее. И автоматизирование всего и вся поможет улучшить жизнь системного администратора если не в текущий момент, то в обозримом будущем точно. Для этого решил я настроить автоконфигурирование настроек прокси-сервера на клиентских машинах.
Имеется апдейт!
Как прокси мы используем Usergate (будь он неладен. На человеческие прокси пока не могу уломать начальство). В нем есть свой DHCP сервер с нужной нам функцией. Но в качестве DHCP мы используем стандартные средства Windows Server, поэтому простой вариант с одной галочкой нам не подходит."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://bubnovd.net/blogger/%D0%B0%D0%B2%D1%82%D0%BE%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8-%D0%B2-%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%B5-windows/><link rel=stylesheet href=https://bubnovd.net/assets/style.css><link rel=stylesheet href=https://bubnovd.net/assets/blue.css><link rel=apple-touch-icon href=https://bubnovd.net/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://bubnovd.net/img/favicon/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Автоопределение прокси в домене Windows"><meta property="og:description" content="Автоматизация - дело хорошее. И автоматизирование всего и вся поможет улучшить жизнь системного администратора если не в текущий момент, то в обозримом будущем точно. Для этого решил я настроить автоконфигурирование настроек прокси-сервера на клиентских машинах.
Имеется апдейт!
Как прокси мы используем Usergate (будь он неладен. На человеческие прокси пока не могу уломать начальство). В нем есть свой DHCP сервер с нужной нам функцией. Но в качестве DHCP мы используем стандартные средства Windows Server, поэтому простой вариант с одной галочкой нам не подходит."><meta property="og:url" content="https://bubnovd.net/blogger/%D0%B0%D0%B2%D1%82%D0%BE%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8-%D0%B2-%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%B5-windows/"><meta property="og:site_name" content="Админская фамилия"><meta property="og:image" content="https://bubnovd.net/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2013-09-13 04:39:00 +0000 UTC"></head><body class=blue><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=https://bubnovd.net/><div class=logo>Terminal</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://bubnovd.net/blogger/%D0%B0%D0%B2%D1%82%D0%BE%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8-%D0%B2-%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%B5-windows/>Автоопределение прокси в домене Windows</a></h1><div class=post-meta><span class=post-date>2013-09-13</span>
<span class=post-author>:: map[name:devi1 uri:https://www.blogger.com/profile/05777499482649623616]</span>
<span class=post-reading-time>:: 3 min read (621 words)</span></div><span class=post-tags>#<a href=https://bubnovd.net/tags/dns/>DNS</a>&nbsp;
#<a href=https://bubnovd.net/tags/windows/>windows</a>&nbsp;
#<a href=https://bubnovd.net/tags/wpad/>WPAD</a>&nbsp;
#<a href=https://bubnovd.net/tags/proxy/>proxy</a>&nbsp;</span><div class=post-content><div><p>Автоматизация - дело хорошее. И автоматизирование всего и вся поможет улучшить жизнь системного администратора если не в текущий момент, то в обозримом будущем точно. Для этого решил я настроить автоконфигурирование настроек прокси-сервера на клиентских машинах.<br>Имеется апдейт!</p><p>Как прокси мы используем Usergate (будь он неладен. На человеческие прокси пока не могу уломать начальство). В нем есть свой DHCP сервер с нужной нам функцией. Но в качестве DHCP мы используем стандартные средства Windows Server, поэтому простой вариант с одной галочкой нам не подходит.<br> Тут нам на помощь приходит протокол автонастройки прокси (<a href=https://en.wikipedia.org/wiki/Web_Proxy_Autodiscovery_Protocol>WPAD</a>). Смысл его работы в следующем:</p><ol><li>Клиент ищет в сети сервер с именем wpad.domain.local (domain.local тут - имя нашего домена), если такой сервер не находится клиент идет выше - wpad.local (в этом кстати заключается брешь этого протокола, о которой говорили на одной из blackhat-конференций).</li><li>Если сервер найден, клиент пытается прочитать файл wpad.dat, лежащий в корневом каталоге.</li><li>Из этого файла берутся настройки, исходя из которых клиент понимает, в каких случаях нужно идти в сеть через прокси, а в каких напрямую.</li></ol><p>Пример простейшего файла wpad.dat:</p><pre tabindex=0><code>function FindProxyForURL(url, host)  
{  
    return &#34;PROXY 192.168.0.254:3128&#34;;  
}  
</code></pre><p>Здесь мы видим, что в качестве адреса прокси-сервера клиенты получают <code>192.168.0.254:3128</code>. Настройки можно кастомизировать, у файла может быть огромное количество опций. Их вы можете найти в <a href="http://www.google.ru/search?q=wpad+example">поисковике</a>.</p><p>Итак, будем считать, что файл настроек создан. Нужно положить его в корневую директорию веб-сервера и настроить сам веб-сервер, чтобы он умел отдавать этот файл. У нас используется Apache под виндой, поэтому привожу его конфигурацию: в httpd.conf в секции <code>&lt;IfModule mime\_module></code> нужно добавить строку <code>AddType application/x-ns-proxy-autoconfig .dat</code></p><p>Следующий этап - настройка DNS-сервера. Нужно внести запись типа CNAME в зону прямого просмотра, указывающую, что под именем <code>wpad.domain.local</code> будет пониматься ваш веб-сервер. На этом натыкаемся на проблему - винда не разрешает использовать имя wpad. Об этом вам ничего не скажет, но найти сервер по имени wpad в сети вы не сможете. Нужно выполнить в командной строке <code>dnscmd /config /enableglobalqueryblocklist 0</code> (подробнее <a href=http://technet.microsoft.com/ru-ru/library/cc441517.aspx>здесь</a>).</p><p>Очищаем кэш ДНС или просто идем курить пить кофе. Выставляем в браузере автонастройку прокси-сервера и получаем счастье. Теперь, если изменится адрес или порт прокси, или просто добавится сервер, на который нужно ходить в обход прокси, то настройки делаются в одном месте, а до клиентов доходят сами.</p><p>Спасибо <a href=http://it-blojek.ru/19/>ит-бложику</a> за наводку.</p><p>UPD 24.12.2013<br>Описание параметров в файле wpad.dat производится на языке JavaScript, т.е. можно построить довольно сложную конфигурацию. Вот пример моего файла, проверяющего соответствие IP-адресов и закомментированными сообщениями для дебага (строки, начинающиеся с var и ниже проверяют, находится ли адрес в диапазоне 192.168.100.65 - 192.168.100.240):</p><pre tabindex=0><code>function FindProxyForURL(url, host)  
{  
// If specific URL needs to bypass proxy, send traffic direct.  
if (shExpMatch(host,&#34;\*subd.domain.local\*&#34;) ||  
shExpMatch(host,&#34;\*subd.domain1.local\*&#34;) ||  
shExpMatch(host,&#34;192.168.\*&#34;) ||  
shExpMatch(host,&#34;127.\*&#34;) ||  
dnsDomainIs(host,&#34;.subd.domain.local&#34;) ||  
dnsDomainIs(host,&#34;.subd.domain1.local&#34;) ||  
isPlainHostName(host))  
return &#34;DIRECT&#34;;  
  
// All other traffic uses below proxies, in fail-over order.  
//debug=&#34;host=&#34; + host + &#34;\\n&#34; + &#34;url=&#34; + url + &#34;\\n&#34; + &#34;MyIP=&#34; + myIpAddress() +  &#34;\\n&#34;;  
var myip = myIpAddress();  // Set a variable for the local IP address.  
var myAddrArray = myip.split(&#34;.&#34;);  // Split that IP address var into an array.  
var mysubnet3=parseInt(myAddrArray\[2\]);  // Convert array element #2 into a number and store it in a new variable  
var mysubnet4=parseInt(myAddrArray\[3\]);  
//debug += &#34;Subnet=&#34; + mysubnet3 + &#34;.&#34; + mysubnet4 + &#34;\\n&#34;;  
if ((mysubnet3 == 100) &amp;&amp; (mysubnet4 &gt;=65) &amp;&amp; (mysubnet4 &lt;= 240)) {  
return &#34;PROXY 192.168.100.14:8080&#34;;}  
else {  
return &#34;DIRECT&#34;;}  
}  
</code></pre><p>В качестве веб-сервера для этой системы очень удобно использовать <code>tinyhttpd</code>, если нет уже работающих серверов. tynihttpd очень маленький и удобный, не нужно делать ничего лишнего - только <code>index.html</code>, <code>wpad.dat</code> и запустить экзешник из cmd.<br>Ещё DNS сервер Windows не дает разрешить доменные имена wpad и isatap, поэтому с ним нужно поколдовать: в командной строке пишем <code>dnscmd /config /globalqueryblocklist</code> и будет счастье.</p><p><code>**UPD 01.09.2014**</code><br><code>**[Здесь](https://securelist.ru/analysis/obzor/242/pac-fajl-avtokonfiguratsii-problem/) интересная статейка по этой теме.**</code><br><code>**UPD 08.08.2016**</code><br><strong><a href=https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/pbp-final-with-update.pdf>О безопасности при использовании WPAD</a></strong></p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bubnovd-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://bubnovd.net/assets/main.js></script>
<script src=https://bubnovd.net/assets/prism.js></script></div></body></html>