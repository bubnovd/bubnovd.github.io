<!doctype html><html lang=en><head><title>IPSec over L2TP между RouterOS и Apple iOS 10 :: Bubnovd</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="В 10 версии iOS команда Apple наконец-то выпилила PPTP, чем сподвигла весь (не)цивилизованный ИТ-мир срочно учиться поднимать IPSec на своих бордерах. В том числе и меня.
&amp;ldquo;Поднять IPSec - что там сложного&amp;rdquo; - подумал я. Но не тут то было. По мануалам, хабрам и прочим ресурсам все отлично поднимается и работает между двумя микротиками, между микротиком и виндой, между микротиком и андроид. Но вот с iOS 10 ни в какую не хочет."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://bubnovd.github.io/blogger/ipsec-over-l2tp-%D0%BC%D0%B5%D0%B6%D0%B4%D1%83-routeros-%D0%B8-apple-ios-10/><link rel=stylesheet href=https://bubnovd.github.io/assets/style.css><link rel=stylesheet href=https://bubnovd.github.io/assets/blue.css><link rel=apple-touch-icon href=https://bubnovd.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://bubnovd.github.io/img/favicon/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="IPSec over L2TP между RouterOS и Apple iOS 10"><meta property="og:description" content="В 10 версии iOS команда Apple наконец-то выпилила PPTP, чем сподвигла весь (не)цивилизованный ИТ-мир срочно учиться поднимать IPSec на своих бордерах. В том числе и меня.
&amp;ldquo;Поднять IPSec - что там сложного&amp;rdquo; - подумал я. Но не тут то было. По мануалам, хабрам и прочим ресурсам все отлично поднимается и работает между двумя микротиками, между микротиком и виндой, между микротиком и андроид. Но вот с iOS 10 ни в какую не хочет."><meta property="og:url" content="https://bubnovd.github.io/blogger/ipsec-over-l2tp-%D0%BC%D0%B5%D0%B6%D0%B4%D1%83-routeros-%D0%B8-apple-ios-10/"><meta property="og:site_name" content="Bubnovd"><meta property="og:image" content="https://bubnovd.github.io/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2016-10-10 03:23:00 +0000 UTC"></head><body class=blue><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=https://bubnovd.github.io/><div class=logo>Terminal</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://bubnovd.github.io/blogger/ipsec-over-l2tp-%D0%BC%D0%B5%D0%B6%D0%B4%D1%83-routeros-%D0%B8-apple-ios-10/>IPSec over L2TP между RouterOS и Apple iOS 10</a></h1><div class=post-meta><span class=post-date>2016-10-10</span>
<span class=post-author>:: map[name:devi1 uri:https://www.blogger.com/profile/05777499482649623616]</span></div><span class=post-tags>#<a href=https://bubnovd.github.io/tags/ios10/>ios10</a>&nbsp;
#<a href=https://bubnovd.github.io/tags/apple/>apple</a>&nbsp;
#<a href=https://bubnovd.github.io/tags/ios/>ios</a>&nbsp;
#<a href=https://bubnovd.github.io/tags/routeros/>routeros</a>&nbsp;
#<a href=https://bubnovd.github.io/tags/l2tp/>l2tp</a>&nbsp;
#<a href=https://bubnovd.github.io/tags/mikrotik/>Mikrotik</a>&nbsp;
#<a href=https://bubnovd.github.io/tags/iphone/>iphone</a>&nbsp;
#<a href=https://bubnovd.github.io/tags/ipsec/>ipsec</a>&nbsp;</span><div class=post-content><div><p>В 10 версии iOS команда Apple наконец-то выпилила PPTP, чем сподвигла весь (не)цивилизованный ИТ-мир срочно учиться поднимать IPSec на своих бордерах. В том числе и меня.</p><p>&ldquo;Поднять IPSec - что там сложного&rdquo; - подумал я. Но не тут то было. По мануалам, хабрам и прочим ресурсам все отлично поднимается и работает между двумя микротиками, между микротиком и виндой, между микротиком и андроид. Но вот с iOS 10 ни в какую не хочет. Путем долгих ковыряний и трехэтажных словосочетаний, выяснил, что изменения для IPSec нужно применять в КОНСОЛИ! Не в графическом интерфейсе, а именно в консоли - ssh или встроенная в WinBox - без разницы. Но факт в том, что идентичные настройки в WinBox не позволяли поднять VPN между Mikrotik RouterOS и IPhone (по крайней мере в моем случае с RB751 на RouterOS 6.37.1 в связке с IPhone 6).</p><p>Привожу настройки L2TP и IPSec текстом и скрины из WinBox что должно получиться:</p><p>L2TP сервер</p><pre tabindex=0><code>/interface l2tp-server server  
set authentication=mschap2 default-profile=default enabled=yes  
</code></pre><p><a href=https://2.bp.blogspot.com/-_4MPqiOY7dM/V_tkhkfGTGI/AAAAAAAAAxc/iUs3UlAZQCMHEWNAoQqQbCrCU7hH586CQCLcB/s1600/1_l2tp.PNG><img src=https://2.bp.blogspot.com/-_4MPqiOY7dM/V_tkhkfGTGI/AAAAAAAAAxc/iUs3UlAZQCMHEWNAoQqQbCrCU7hH586CQCLcB/s320/1_l2tp.PNG alt></a></p><p>L2TP server</p><p>PPP профили дефолтные</p><pre tabindex=0><code>\&gt; ppp profile print   
Flags: \* - default   
 0 \* name=&#34;default&#34; use-mpls=default use-compression=default   
     use-encryption=default only-one=default change-tcp-mss=yes   
     use-upnp=default address-list=&#34;&#34; on-up=&#34;&#34; on-down=&#34;&#34;   
  
 1 \* name=&#34;default-encryption&#34; use-mpls=default use-compression=default   
     use-encryption=yes only-one=default change-tcp-mss=yes use-upnp=default   
     address-list=&#34;&#34; on-up=&#34;&#34; on-down=&#34;&#34;  
</code></pre><p><a href=https://2.bp.blogspot.com/-4j6jmkS_1zM/V_tlNc9yazI/AAAAAAAAAxk/nnkmtuOYXDQtuOicW1Gb4wKXzSNpe_ohwCLcB/s1600/2_ppp-profile.PNG><img src=https://2.bp.blogspot.com/-4j6jmkS_1zM/V_tlNc9yazI/AAAAAAAAAxk/nnkmtuOYXDQtuOicW1Gb4wKXzSNpe_ohwCLcB/s320/2_ppp-profile.PNG alt></a></p><p>ppp profile</p><p>Пользователь L2TP тоже ничем не отличается от простого L2TP/PPTP и иже с ними без айписека</p><pre tabindex=0><code>/ppp secret

add local-address=192.168.222.16 name=user1 password=l2tppassword profile=default-encryption remote-address=192.168.222.18 service=l2tp
</code></pre><p><a href=https://2.bp.blogspot.com/-ruLmJPDInsM/V_tl5BDgwQI/AAAAAAAAAxo/jYPxZzvOKTEO7ZPh7XGp7jQpwTOLlvrfwCLcB/s1600/3_user.PNG><img src=https://2.bp.blogspot.com/-ruLmJPDInsM/V_tl5BDgwQI/AAAAAAAAAxo/jYPxZzvOKTEO7ZPh7XGp7jQpwTOLlvrfwCLcB/s320/3_user.PNG alt></a></p><p>L2TP secret</p><p>Приступаем к IPSec. Все, что я делал с IPSec - делал через консоль. Из винбокса не заработало. что именно сделалось не так - не проверял. Можете проверить методом исключения.</p><p>Добавляем группу (дефолтная работает криво - особенность RouterOS):</p><pre tabindex=0><code>/ip ipsec policy group  
add name=l2tp
</code></pre><p><a href=https://3.bp.blogspot.com/-J0qbeMyCGsE/V_tm3ZmyyGI/AAAAAAAAAx4/qkVDbLAHMnYiRGtyTh4gHMbAbRXwmClHgCLcB/s1600/4_group.PNG><img src=https://3.bp.blogspot.com/-J0qbeMyCGsE/V_tm3ZmyyGI/AAAAAAAAAx4/qkVDbLAHMnYiRGtyTh4gHMbAbRXwmClHgCLcB/s320/4_group.PNG alt></a></p><p>IPSec group</p><p>Корректируем proposal и добавляем новый:</p><pre tabindex=0><code>/ip ipsec proposal
set \[ find default=yes \] enc-algorithms=aes-256-cbc,aes-128-cbc
add enc-algorithms=aes-256-cbc,aes-128-cbc name=L2TP pfs-group=none
</code></pre><p><a href=https://4.bp.blogspot.com/-V5leQjYiI90/V_tnS-HkCRI/AAAAAAAAAx8/Es4LO8wuR8cMHJoDJJz3JKpaR7JprFvzwCLcB/s1600/5_proposal.PNG><img src=https://4.bp.blogspot.com/-V5leQjYiI90/V_tnS-HkCRI/AAAAAAAAAx8/Es4LO8wuR8cMHJoDJJz3JKpaR7JprFvzwCLcB/s320/5_proposal.PNG alt></a></p><p>IPSec proposal</p><p>Добавляем пира:</p><pre tabindex=0><code>/ip ipsec peer
add enc-algorithm=aes-256,aes-192,aes-128,3des exchange-mode=main-l2tp generate-policy=port-strict passive=yes policy-template-group=l2tp secret=RouterOS
</code></pre><p><a href=https://4.bp.blogspot.com/-g2hwHl6Dboc/V_toMc017GI/AAAAAAAAAyI/Ml-pWpj0oXQ5J-BZ99i7PI0TsvjKX1FWgCLcB/s1600/6_peer.PNG><img src=https://4.bp.blogspot.com/-g2hwHl6Dboc/V_toMc017GI/AAAAAAAAAyI/Ml-pWpj0oXQ5J-BZ99i7PI0TsvjKX1FWgCLcB/s320/6_peer.PNG alt></a></p><p>IPSec peer</p><p>Добавляем шаблон политики:</p><pre tabindex=0><code>/ip ipsec policy
add dst-address=0.0.0.0/0 group=l2tp proposal=L2TP src-address=0.0.0.0/0 template=yes
</code></pre><p><a href=https://1.bp.blogspot.com/-BREipqX5fhY/V_toquFtKXI/AAAAAAAAAyQ/I5njzVpQlLcE8jdqW6IrYTJVAWT8zN6VwCLcB/s1600/7_policy.PNG><img src=https://1.bp.blogspot.com/-BREipqX5fhY/V_toquFtKXI/AAAAAAAAAyQ/I5njzVpQlLcE8jdqW6IrYTJVAWT8zN6VwCLcB/s320/7_policy.PNG alt></a></p><p>IPSec policy</p><p><a href=https://2.bp.blogspot.com/-KrcYxMQcPgM/V_toqs6DMsI/AAAAAAAAAyM/-48BTpkfmbE4XnCjflmwOwE-7lAGOcVgQCLcB/s1600/8_policy.PNG><img src=https://2.bp.blogspot.com/-KrcYxMQcPgM/V_toqs6DMsI/AAAAAAAAAyM/-48BTpkfmbE4XnCjflmwOwE-7lAGOcVgQCLcB/s320/8_policy.PNG alt></a></p><p>IPSec policy action</p><p>Ну и настройка IPhone:</p><p><a href=https://2.bp.blogspot.com/-XZYGv6-IFL4/V_trrzjAp5I/AAAAAAAAAyg/0tyDmiUx3NEBF9J8E3ns3yLX6Se5hrlFwCLcB/s1600/0_iphone.PNG><img src=https://2.bp.blogspot.com/-XZYGv6-IFL4/V_trrzjAp5I/AAAAAAAAAyg/0tyDmiUx3NEBF9J8E3ns3yLX6Se5hrlFwCLcB/s320/0_iphone.PNG alt></a></p><p>IPhone</p><p>Спасибо <a href=https://www.vasilevkirill.com/>Кириллу Васильеву</a> за наводку</p><p>UPD: если имеются проблемы с подключением, попробуйте в /ip ipsec peer generate-policy установить port-override вместо port-strict </p><p>UPD: как советуют в комментариях</p><p><a href=https://vk.com/eugene_fesko>Евгений</a><a href="http://www.bubnovd.net/2016/10/ipsec-over-l2tp-routeros-apple-ios-10.html?showComment=1508055431990#c7669898995946448842">15.10.2017, 1:17</a></p><p>В общем как ни странно вопрос решён, действительно помогло. А значит тем, кто кроме меня столкнулся с такой же проблемой, но не хочет прошиваться на релиз-кандидаты прошивок и ждёт официальную - им поможет отключение UPNP в роутере (в принципе его есть смысл юзать в домашнем варианте использования роутера, но и по работе в некоторых случаях он бывает полезен, в таком случае решение - только прошиваться на 6.41rc38)</p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bubnovd-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://bubnovd.github.io/assets/main.js></script>
<script src=https://bubnovd.github.io/assets/prism.js></script></div></body></html>