<!doctype html><html lang=en><head><title>Скрипт для выявления порта свитча по маку. Опрос по SNMP :: Админская фамилия</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Допилил предыдущий скрипт . Необходимо знать аплинки каждого из свитчей. В моем случае, все они подключены к одному корневому (RootSwitch). Скрипт вытягивает по SNMP FDB таблицу корневого свитча, ищет в ней заданный MAC, сверяет его по заранее заданной таблице аплинков до свитчей доступа, переходит на следующий свитч и с него так же забирает FDB таблицу, а в ней уже ищет необходимый MAC. Информация выводится следующим образом &amp;ldquo;MAC, vlan, port корневого свитча; MAC, vlan, port конечного свитча&amp;rdquo;."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://bubnovd.net/blogger/%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82-%D0%B4%D0%BB%D1%8F-%D0%B2%D1%8B%D1%8F%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BF%D0%BE%D1%80%D1%82%D0%B0-%D1%81%D0%B2%D0%B8%D1%82%D1%87%D0%B0-%D0%BF%D0%BE-%D0%BC%D0%B0%D0%BA%D1%83.-%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%BF%D0%BE-snmp/><link rel=stylesheet href=https://bubnovd.net/assets/style.css><link rel=stylesheet href=https://bubnovd.net/assets/blue.css><link rel=apple-touch-icon href=https://bubnovd.net/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://bubnovd.net/img/favicon/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Скрипт для выявления порта свитча по маку. Опрос по SNMP"><meta property="og:description" content="Допилил предыдущий скрипт . Необходимо знать аплинки каждого из свитчей. В моем случае, все они подключены к одному корневому (RootSwitch). Скрипт вытягивает по SNMP FDB таблицу корневого свитча, ищет в ней заданный MAC, сверяет его по заранее заданной таблице аплинков до свитчей доступа, переходит на следующий свитч и с него так же забирает FDB таблицу, а в ней уже ищет необходимый MAC. Информация выводится следующим образом &amp;ldquo;MAC, vlan, port корневого свитча; MAC, vlan, port конечного свитча&amp;rdquo;."><meta property="og:url" content="https://bubnovd.net/blogger/%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82-%D0%B4%D0%BB%D1%8F-%D0%B2%D1%8B%D1%8F%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BF%D0%BE%D1%80%D1%82%D0%B0-%D1%81%D0%B2%D0%B8%D1%82%D1%87%D0%B0-%D0%BF%D0%BE-%D0%BC%D0%B0%D0%BA%D1%83.-%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%BF%D0%BE-snmp/"><meta property="og:site_name" content="Админская фамилия"><meta property="og:image" content="https://bubnovd.net/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2015-02-27 00:32:00 +0000 UTC"></head><body class=blue><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=https://bubnovd.net/><div class=logo>Terminal</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://bubnovd.net/blogger/%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82-%D0%B4%D0%BB%D1%8F-%D0%B2%D1%8B%D1%8F%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BF%D0%BE%D1%80%D1%82%D0%B0-%D1%81%D0%B2%D0%B8%D1%82%D1%87%D0%B0-%D0%BF%D0%BE-%D0%BC%D0%B0%D0%BA%D1%83.-%D0%BE%D0%BF%D1%80%D0%BE%D1%81-%D0%BF%D0%BE-snmp/>Скрипт для выявления порта свитча по маку. Опрос по SNMP</a></h1><div class=post-meta><span class=post-date>2015-02-27</span>
<span class=post-author>:: map[name:devi1 uri:https://www.blogger.com/profile/05777499482649623616]</span>
<span class=post-reading-time>:: 3 min read (483 words)</span></div><span class=post-tags>#<a href=https://bubnovd.net/tags/snmp/>SNMP</a>&nbsp;
#<a href=https://bubnovd.net/tags/powershell/>PowerShell</a>&nbsp;
#<a href=https://bubnovd.net/tags/%D0%BA%D0%BE%D0%BC%D0%BC%D1%83%D1%82%D0%B0%D1%82%D0%BE%D1%80/>коммутатор</a>&nbsp;
#<a href=https://bubnovd.net/tags/l2/>L2</a>&nbsp;
#<a href=https://bubnovd.net/tags/%D0%BA%D0%BE%D0%BC%D0%BC%D1%83%D1%82%D0%B0%D1%86%D0%B8%D1%8F/>коммутация</a>&nbsp;
#<a href=https://bubnovd.net/tags/%D0%B0%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/>Автоматизация</a>&nbsp;
#<a href=https://bubnovd.net/tags/%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82/>скрипт</a>&nbsp;</span><div class=post-content><div><p>Допилил предыдущий скрипт . Необходимо знать аплинки каждого из свитчей. В моем случае, все они подключены к одному корневому (RootSwitch). Скрипт вытягивает по SNMP FDB таблицу корневого свитча, ищет в ней заданный MAC, сверяет его по заранее заданной таблице аплинков до свитчей доступа, переходит на следующий свитч и с него так же забирает FDB таблицу, а в ней уже ищет необходимый MAC. Информация выводится следующим образом &ldquo;MAC, vlan, port корневого свитча; MAC, vlan, port конечного свитча&rdquo;.Для работы с SNMP необходимо подключить модуль SharpSNMP.Из неожиданностей в OID  MAC адреса хранятся в десятичном формате, пришлось их переводить в шестнадцатеричный. Простым способом вернуть несколько значений из функции невозможно. Пришлось городить хэш-таблицу, в которой хранились бы три массива (MAC, vlan, port)В OID информация хранится следующим образом:OID                                                                                   Data&mdash;                                                                                       &mdash;-.1.3.6.1.2.1.17.7.1.2.1.1.2.1                                               223.1.3.6.1.2.1.17.7.1.2.1.1.2.41                                              63.1.3.6.1.2.1.17.7.1.2.1.1.2.4026                                         222.1.3.6.1.2.1.17.7.1.2.2.1.2.1.144.2.166.50.206.43                3.1.3.6.1.2.1.17.7.1.2.2.1.2.1.144.2.166.50.206.63                6.1.3.6.1.2.1.17.7.1.2.2.1.2.1.144.2.166.50.206.126              4.1.3.6.1.2.1.17.7.1.2.2.1.2.41.0.21.100.59.187.78                26.1.3.6.1.2.1.17.7.1.2.2.1.2.4026.0.9.136.173.129.150          26.1.3.6.1.2.1.17.7.1.2.2.1.3.4026.232.64.241.24.239.215      3.1.3.6.1.2.1.17.7.1.2.2.1.3.4026.232.64.241.24.242.213      3Первые три строки (может быть больше или меньше, в зависиомсти от количества vlan&rsquo;ов): последняя цифра - номер vlan&rsquo;а, data - количество MAC-адресов в этом влане в FDB-таблице.Далее следуют строки с перечислением MAC-адресов, сгруппированные по vlan&rsquo;ам: после символов .1.3.6.1.2.1.17.7.1.2.2.1.2. идет номер vlan (1, 41, 4026 в нашем случае), а за ним MAC адрес в десятичном формате. В поле Data - порт с найденным MAC-ом.Далее следуют строки, начинающиеся на .1.3.6.1.2.1.17.7.1.2.2.1.3. Они содержат информацию, о способе получения MAC-адреса. Если параметр 3 - MAC получен методом learning (опрос порта), 4 - MAC коммутатора, с которого взяли FDB.Мы будем обрабатывать строки из второго блока. Сначала отсекаем ненужную нам часть OID, затем разбиваем на подстроки и запоминаем данные. Полученные данные выводим по порядку в 3 массива - MAC, port, vlan.Собственно скрипт:function findonswitch ([string]$ip) {$oid=".1.3.6.1.2.1.17.7.1.2.2.1.2."$mas = Invoke-SnmpWalk $ip &ldquo;.1.3.6.1.2.1.17.7.1.2&rdquo; #vlans$i=0$vlan=@()$mac=@()$port=@()foreach ($pt in $mas){ if ($pt.OID -like &ldquo;<em>$oid</em>&rdquo;) { $pt.OID = $pt.OID.remove(0,28) $vlan += $pt.OID.Substring(0, $pt.OID.IndexOf(".")) $temp = $pt.OID.Substring($pt.OID.IndexOf(".") + 1, $pt.OID.Length - $pt.OID.IndexOf(".")-1) ###перевод из Dec в Hex $mas=$temp.split(".") $nmac=@() foreach ($sdec in $mas) { $dec = [int]$sdec $nmac += &lsquo;{0:X2}&rsquo; -f $dec } $str=$nmac -join &ldquo;-" ### $mac += $str $port += $pt.Data } }$return= @{}$return.vlan=$vlan$return.mac=$mac$return.port=$portreturn $return}####################################################################$rootIP = &ldquo;192.168.0.21&rdquo;$sport = (&ldquo;1&rdquo;, &ldquo;2&rdquo;, &ldquo;5&rdquo;, &ldquo;12&rdquo;, &ldquo;13&rdquo;, &ldquo;14&rdquo;, &ldquo;43&rdquo;, &ldquo;44&rdquo;, &ldquo;65&rdquo;, &ldquo;66&rdquo;, &ldquo;74&rdquo;, &ldquo;107&rdquo;)$swDB = (&ldquo;192.168.0.42&rdquo;, &ldquo;192.168.0.44&rdquo;, &ldquo;192.168.0.61&rdquo;, &ldquo;192.168.0.52&rdquo;, &ldquo;192.168.0.51&rdquo;, &ldquo;192.168.0.12&rdquo;, &ldquo;192.168.0.33&rdquo;, &ldquo;192.168.0.32&rdquo;, &ldquo;192.168.0.41&rdquo;, &ldquo;192.168.0.43&rdquo;, &ldquo;192.168.0.11&rdquo;, &ldquo;192.168.0.34&rdquo;)function findinarr ($array, $value) {    for ($i=0; $i -lt $array.count;$i++) {         if($array[$i] -eq $value){$i}    }}$res=findonswitch $rootIP$dataMACRoot = $res.mac$dataPortRoot = $res.port$dataVlanRoot = $res.vlan$mac = Read-Host &ldquo;Enter MAC&rdquo;if ($mac.indexof(&rdquo;:") -ne 0){ $mac=$mac.replace(":", &ldquo;-&rdquo;)}$i=0$flag=0foreach ($S in $dataMACRoot){ if ($mac -eq $s) { $portRoot = $dataPortRoot[$i] $vlanRoot = $dataVlanRoot[$i] Write-Host $mac on $portRoot &lsquo;in vlan&rsquo; $vlanRoot on RootSwitch if ($flag -eq 0) { $portRoot1 = $dataPortRoot[$i] } $flag++ } $i++}$A = findinarr $sport $portRoot1$res=findonswitch $swDB[$A]$dataMAC = $res.mac$dataPort = $res.port$dataVlan = $res.vlan$i=0foreach ($S in $dataMAC){ if ($mac -eq $s) { $port = $dataPort[$i] $vlan = $dataVlan[$i] Write-Host $mac on $port &lsquo;in vlan&rsquo; $vlan on &lsquo;switch&rsquo; $swDB[$A] } $i++}Работа второй части скрипта (после ###########) описана в предыдущем посте. Тут она претерпела некоторые изменения, в связи с входящей информацией из массива, а не из csv-файла, но логика не изменилась.</p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bubnovd-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://bubnovd.net/assets/main.js></script>
<script src=https://bubnovd.net/assets/prism.js></script></div></body></html>