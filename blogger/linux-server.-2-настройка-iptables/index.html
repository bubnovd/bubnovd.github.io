<!doctype html><html lang=en><head><title>Linux Server. 2 Настройка iptables :: Админская фамилия</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Займёмся правильной настройкой фаервола. На самом деле пакетный фильтр в Linux носит имя netfilter. А iptables - утилита для его настройки. Правильная настройка любого фаервола ведется по правилу: &amp;ldquo;Что не разрешено - то запрещено&amp;rdquo;. То есть сначала нужно закрыть всё.Все действия выполняются из под суперпользователя. sudo suЗакрываем всё:iptables -P INPUT DROPiptables -P FORWARD DROPiptables -P OUTPUT DROPЕсли нужно, чтобы на машину ходили пинги, нужно разрешить icmp-пакеты:iptables -A INPUT -p icmp -j ACCEPTiptables -A OUTPUT -p icmp -j ACCEPTВ этом случае пинги будут ходить отовсюду."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://bubnovd.net/blogger/linux-server.-2-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-iptables/><link rel=stylesheet href=https://bubnovd.net/assets/style.css><link rel=stylesheet href=https://bubnovd.net/assets/blue.css><link rel=apple-touch-icon href=https://bubnovd.net/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://bubnovd.net/img/favicon/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Linux Server. 2 Настройка iptables"><meta property="og:description" content="Займёмся правильной настройкой фаервола. На самом деле пакетный фильтр в Linux носит имя netfilter. А iptables - утилита для его настройки. Правильная настройка любого фаервола ведется по правилу: &amp;ldquo;Что не разрешено - то запрещено&amp;rdquo;. То есть сначала нужно закрыть всё.Все действия выполняются из под суперпользователя. sudo suЗакрываем всё:iptables -P INPUT DROPiptables -P FORWARD DROPiptables -P OUTPUT DROPЕсли нужно, чтобы на машину ходили пинги, нужно разрешить icmp-пакеты:iptables -A INPUT -p icmp -j ACCEPTiptables -A OUTPUT -p icmp -j ACCEPTВ этом случае пинги будут ходить отовсюду."><meta property="og:url" content="https://bubnovd.net/blogger/linux-server.-2-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-iptables/"><meta property="og:site_name" content="Админская фамилия"><meta property="og:image" content="https://bubnovd.net/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2011-08-25 01:49:00 +0000 UTC"></head><body class=blue><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=https://bubnovd.net/><div class=logo>Terminal</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://bubnovd.net/blogger/linux-server.-2-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-iptables/>Linux Server. 2 Настройка iptables</a></h1><div class=post-meta><span class=post-date>2011-08-25</span>
<span class=post-author>:: map[name:devi1 uri:https://www.blogger.com/profile/05777499482649623616]</span>
<span class=post-reading-time>:: 3 min read (573 words)</span></div><span class=post-tags>#<a href=https://bubnovd.net/tags/linux-server/>Linux Server</a>&nbsp;
#<a href=https://bubnovd.net/tags/ubuntu/>ubuntu</a>&nbsp;
#<a href=https://bubnovd.net/tags/iptables/>iptables</a>&nbsp;
#<a href=https://bubnovd.net/tags/debian/>debian</a>&nbsp;</span><div class=post-content><div><p>Займёмся правильной настройкой фаервола. На самом деле пакетный фильтр в Linux носит имя netfilter. А iptables - утилита для его настройки. Правильная настройка любого фаервола ведется по правилу: &ldquo;Что не разрешено - то запрещено&rdquo;. То есть сначала нужно закрыть всё.Все действия выполняются из под суперпользователя. sudo suЗакрываем всё:iptables -P INPUT DROPiptables -P FORWARD DROPiptables -P OUTPUT DROPЕсли нужно, чтобы на машину ходили пинги, нужно разрешить icmp-пакеты:iptables -A INPUT -p icmp -j ACCEPTiptables -A OUTPUT -p icmp -j ACCEPTВ этом случае пинги будут ходить отовсюду. Чтобы разрешить пинг только с конкретных ip/подсетей, пишем следующее (предыдущее не пишем):iptables -A INPUT -s 192.168.0.100 -p icmp -j ACCEPTiptables -A OUTPUT -d 192.168.0.100 -p icmp -j ACCEPTВ этом случае 192.168.0.100 - ip машины, с которой можно пинговать. Чтобы задать подсеть, достаточно написать 192.168.0.0/24, где 24 - маска подсети (можно писать 255.255.255.0).Открытие портов производим по такому же принципу. Если конкретный адрес/подсеть не указаны, порты откроются для всех. Не забываем, что если в цепочке INPUT указывается s (source), то в OUTPUT - d (destination), и наоборот. Откроем 22 порт для 192.168.0.100:iptables -A INPUT -s 192.168.0.100 -p tcp &ndash;dport 22 -j ACCEPTiptables -A OUTPUT -d 192.168.0.100 -p tcp &ndash;sport 22 -j ACCEPTНе забываем открыть DNS порты, иначе сами сможем ходить в нет только по айпишникам:iptables -A INPUT -p udp &ndash;sport 53 -j ACCEPTiptables -A OUTPUT -p udp &ndash;dport 53 -j ACCEPTПроброс портов:Задача:при попытке соединения с сервером (192.168.0.104) из локальной сети  (c IP 192.168.0.100) на порт RDP (3389) - соединять клиента с Windows-сервером (192.168.0.21).Тут нужен NAT. Сначала нужно включить его поддержкуecho net.ipv4.ip_forward=1 > /etc/sysctl.confПерезагружаемся.Теперь пишем правила:iptables -t nat -A PREROUTING &ndash;dst 192.168.0.104 -p tcp &ndash;dport 3389 -j DNAT &ndash;to-destination 192.168.0.21Этой командой мы говорим фаерволу, чтобы он добавил в таблицу nat в цепочку PREROUTING правило, которое в пакетах, идущих к машине с фаерволом (192.168.0.104) на порт 3389, заменял адрес назначения пакетов с 192.168.0.104 на 192.168.0.21.iptables -t nat -A POSTROUTING -p tcp &ndash;dst 192.168.0.21 &ndash;dport 3389 -j SNAT &ndash;to-source 192.168.0.104Это пишем уже в цепочку POSTROUTING (т.е. после принятия решения о маршрутизации) таблицы nat, в котором говорим, что пакеты, идущие от нас (192.168.0.104) к 192.168.0.21 меняли адрес отправителя на наш (192.168.0.104). Так как сейчас у них адрес отправителя (192.168.0.100 или адрес той машины, с которой мы хотим подключиться к RDP).Ещё два правила в таблицу filter:iptables -A FORWARD &ndash;dst 192.168.0.21 &ndash;src 192.168.0.0/24 -p tcp &ndash;dport 3389  -j ACCEPTiptables -A FORWARD &ndash;src 192.168.0.0/24 &ndash;dst 192.168.0.21 -p tcp &ndash;dport 3389  -j ACCEPTЭти правила разрешают прохождение пакетов из локалки 192.168.0.0/24 на Windows-сервер (192.168.0.21) на порт 3389 и обратно.Пока что у меня в фаерволе следующие правила:Chain INPUT (policy DROP)target     prot opt source               destinationACCEPT     icmp &ndash;  anywhere               anywhereACCEPT     udp  &ndash;  anywhere               anywhere            udp spt:domainACCEPT     tcp  &ndash;  192.168.0.100        anywhere            tcp dpt:sshACCEPT     tcp  &ndash;  anywhere                anywhere            tcp spt:wwwACCEPT     tcp  &ndash;  192.168.0.100        anywhere            tcp dpt:wwwChain FORWARD (policy DROP)target     prot opt source               destinationACCEPT     tcp  &ndash;  192.168.0.0/24       192.168.0.21        tcp dpt:3389ACCEPT     tcp  &ndash;  192.168.0.21         192.168.0.0/24      tcp spt:3389Chain OUTPUT (policy DROP)target     prot opt source               destinationACCEPT     icmp &ndash;  anywhere             anywhereACCEPT     udp  &ndash;  anywhere             anywhere              udp dpt:domainACCEPT     tcp  &ndash;  anywhere             192.168.0.100       tcp spt:sshACCEPT     tcp  &ndash;  anywhere             anywhere               tcp dpt:wwwACCEPT     tcp  &ndash;  anywhere             192.168.0.100       tcp spt:wwwChain PREROUTING (policy ACCEPT)target     prot opt source               destinationDNAT       tcp  &ndash;  anywhere             192.168.0.104       tcp dpt:3389 to:192.168.0.21Chain OUTPUT (policy ACCEPT)target     prot opt source               destinationChain POSTROUTING (policy ACCEPT)target     prot opt source               destinationSNAT       tcp  &ndash;  anywhere             192.168.0.21        tcp dpt:3389 to:192.168.0.104Мануалы:<a href=http://easylinux.ru/node/190/>http://easylinux.ru/node/190/</a><a href=http://www.opennet.ru/docs/RUS/iptables/>http://www.opennet.ru/docs/RUS/iptables/</a><a href="http://www.it-simple.ru/?p=2250">http://www.it-simple.ru/?p=2250</a>UPD: Для совсем начинающих: можете задать вопросы в комментах или в личку. Обязательно отвечу и постараюсь помочь с простыми решениями (в сложных сам не шарю)UPD2: Недавно здесь выложили ещё один мануал</p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bubnovd-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://bubnovd.net/assets/main.js></script>
<script src=https://bubnovd.net/assets/prism.js></script></div></body></html>