+++
title = "Mikrotik autoconfig"
date = 2016-09-13T07:03:00Z
updated = 2016-09-13T07:03:24Z
draft = true
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

РАБОЧИЙ<br /><br />/log info message=".....................Autoconfiguration started....................."<br />#Версия внедряемой конфигурации<br />#Внедрение правил фаервола для Hotspot<br />:local ver<br />:set $ver v001<br />#Версия следующей конфигурации<br />:local verNext<br />:set $verNext ("v" . [tostr ([tonum [pick $ver 1 4]] + 1)])<br />#Добавляем нули, если надо<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>if ([:len $verNext] =2) do={<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>:set $verNext ([pick $verNext 0 1] . "00" . [pick $verNext ([len $verNext] -1) ([len $verNext])])} else={<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>if ([:len $verNext] =3) do={<br /><span class="Apple-tab-span" style="white-space: pre;">   </span>:set $verNext ([pick $verNext 0 1] . "0" . [pick $verNext ([len $verNext] -2) ([len $verNext])])} else={}}<br /><br />#/log info message="Creating script $ver"<br />#####Тут код конфигурации<br />#####<br />#####<br />#/system script add name=$ver source="/log info message=done"<br />##### Или в скрипте выше<br />#/log info message="Script $ver created. Starting"<br />#/system script run $ver<br />#/log info message="Removing script $ver"<br />#/system script remove $ver<br />/system scheduler set autoconf on-event="/tool fetch url=\"http://192.168.32.84/$verNext\"<br />/import $verNext"<br />/log info message="...................Autoconfiguration complete..................."<br />/file remove $ver<br /><br /><br /><br /><br /><br />ftch.rsc<br /><br />/log info message=".....................Autoconfiguration started....................."<br />#Версия внедряемой конфигурации<br />:local ver<br />:set $ver v018<br />#Версия предыдущей конфигурации<br />:local verBefore<br />#Версия первой пропущенной конфигурации<br />:global verNext<span class="Apple-tab-span" style="white-space: pre;">  </span><br />:set $verNext 0<br />:global verFtch<br />:set $verFtch $ver<br />#Проверка существования скриптов<br />/log info message="BEGIN"<br />if ([:len [/system script find]] &gt;0 ) do={:set verBefore [/system script get [find name~"v"] name]} else={:set $verBefore $ver}<br />/log info message="Creating script $ver"<br />/system script add name=$ver source="<br />:local ver $ver<br />#Проверка версионности. Если разница версий &gt;1, то скачать и выполнить пропущенные<br />if (([tonum [pick $ver 1 4]] - [tonum [pick $verBefore 1 4]]) &gt;1 ) do={<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>#Пропустили что-то<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>#ИД скрипта, котрый выполнить перед текущим<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>:global verNext<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>:set \$verNext (\"v\" . [tostr ([tonum [pick $verBefore 1 4]] + 1)])<br /><br /><span class="Apple-tab-span" style="white-space: pre;"> </span>#Добавляем нули, если надо<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>if ([:len \$verNext] =2) do={<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>:set \$verNext ([pick \$verNext 0 1] . \"00\" . [pick \$verNext ([len \$verNext] -1) ([len \$verNext])])} else={<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>if ([:len \$verNext] =3) do={<br /><span class="Apple-tab-span" style="white-space: pre;">   </span>:set \$verNext ([pick \$verNext 0 1] . \"0\" . [pick \$verNext ([len \$verNext] -2) ([len \$verNext])])} else={}}<br /><br /><span class="Apple-tab-span" style="white-space: pre;"> </span>##################Код для запуска отсутсвующей конфигурации<span class="Apple-tab-span" style="white-space: pre;">  </span><br /><span class="Apple-tab-span" style="white-space: pre;"> </span>:put AAAAAA<br />} else={<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>#По порядку или первый<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>######################################Код новых изменений<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>:put vot<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>#Удаляем предыдущий скрипт<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>if (([:len [/system script find]] &gt;0) and ([tonum [pick $ver 1 4]] != [tonum [pick $verBefore 1 4]])) do={/system script remove $verBefore} else {}<br />}<br />:put ABRAGYLH!!<br />"<br />/log info message="Script $ver created. Starting"<br />/system script run $ver<br />/delay 1<br />#Если необходимо конфигурирование до предыдущей версии<br />if ($verNext != 0) do={<br />/log info message="Uncomplete configuration. Download script $verNext"<br />/tool fetch url="http://192.168.32.84/$verNext"<br />/import $verNext<br />} else={<br />/file remove ftch.rsc}<br />/log info message="...................Autoconfiguration complete..................."<br /><br /><br /><br /><br /><br /><br /><br /><br />v015 &nbsp; Выполненный конф. Который, возможно, не выполнился на микротике<br /><br /><br />/log info message=".....................Missed autoconfig script started....................."<br />#Версия внедряемой конфигурации<br />:local ver<br />:set $ver v015<br />:global verNext<span class="Apple-tab-span" style="white-space: pre;"> </span><br />:global verFtch<br /><br />#Версия предыдущей конфигурации<br />:local verBefore<br />:set $verBefore ([pick $verNext 0 1] . "0" . [tostr ([tonum [pick $verNext 1 4]] - 1)])<br />:put $verBefore<br />/log info message="Creating script $ver"<br /><br />#####Тут код конфигурации из предыдущего ftch.rsc<br />/system script add name=$ver source="/log info message=done"<br />##### Или в скрипте выше<br /><br />/log info message="Script $ver created. Starting"<br />/system script run $ver<br />/log info message="Removing old script $verBefore"<br />/system script remove $verBefore<br />/log info message=".....................Missed autoconfig script $ver complete....................."<br />/system script remove $verFtch<br />/delay 5<br />/import ftch.rsc<br />/file remove $ver
