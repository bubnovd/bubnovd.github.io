+++
title = "Mikrotik, hotspot и СМС"
date = 2017-11-12T07:49:00Z
updated = 2017-11-12T07:49:16Z
draft = true
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Hotspot. Очень многие сейчас интересуются этим. На нем можно заработать самые настоящие деньги. Необходимо только сначала донести до бизнеса, зачем ему нужен хотспот. О том, что такое хотспот, его возможности и различные реализации описаны в интернете более, чем подробно. И заниматься большим нетехническим писательством я тут не буду - кому интересно, тот сам найдет всю необходимую информацию. Скажу лишь, что Mikrotik - не единственное решение. HotWiFi, SaiWiFi, CleverWiFi<br /><div><br /></div><div>Итак, хостпот. Это система, позволяющая получить доступ к какой-либо сети (Интернет и не только), пройдя авторизацию (пароль, билет, СМС, авторизация/репост в соцсетях и так далее - на что хватит фантазии).</div><div>Более того, в страницы, открываемые пользователем, можно инжектировать свой код (для ресторанов это кнопка вызова официанта или меню, для автомоек - видео процесса мойки и так далее). Таким образом, хотспот даёт огромные возможности для бизнеса и сервиса для клиента.</div><div><br /></div><div>Как развернуть систему хотспот на Mikrotik RouterOS написано много. Но по теме авторизации нет открытой информации, готовой к использованию. Я немного покопался в этом направлении и нарукожопил свою авторизацию посредством СМС, которую предлагаю вашему вниманию.</div><div><br /></div><div>Авторизация в хотспот - тема не самая легкая. Она затрагивает большой стек технологий:</div><div><ul><li>Mikrotik RouterOS</li><li>Настройка Hotspot в RouterOS</li><li>RADIUS сервер</li><li>MySQL сервер</li><li>Web сервер с php</li><li>Код на HTML и PHP</li><li>Linux система с перечисленными выше пунктами</li></ul></div><div><div>Для запуска хотспот с авторизацией по СМС глубокого погружения в технологии не требуется. Но если вы хотите зарабатывать на этом деньги необходимо будет изучить нюансы и погрузиться в безопасность и отказоустойчивость. Об этом поговорим в конце статьи.</div></div><div><br /></div><div>Работает система следующим образом:</div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-tuoat-u1WSM/V_4ll2t3PyI/AAAAAAAAAzg/CMM8OBMK8WcYbdBPLSyZ9b6c5tVeK4yKgCLcB/s1600/1.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="296" src="https://4.bp.blogspot.com/-tuoat-u1WSM/V_4ll2t3PyI/AAAAAAAAAzg/CMM8OBMK8WcYbdBPLSyZ9b6c5tVeK4yKgCLcB/s640/1.PNG" width="640" /></a></div><div class="separator" style="clear: both; text-align: left;">Клиент подключается к WiFi, система клиентского устройства определяет, что подключение есть, но доступа в сеть нет и открывает так называемый Captive Portal - это сайт, заданный в настройках ОС. Микротик редиректит браузер на свою страницу авторизации - login.html, которая находится в директории hotspot на самом Mikrotik (появляется после инициализации хотспота).&nbsp;</div><div><br /></div><div>login.html знает некоторые данные, касаемые нашего хотспота и подключившегося клиента. Эти данные страничка принимает методом POST. Полный список возможных переменных <a href="http://wiki.mikrotik.com/wiki/Manual:Customizing_Hotspot#Variables" target="_blank">тут</a>.&nbsp;</div><div><br /></div><div>Так как Mikrotik у нас не один, то удобно будет использовать внешний веб-сервер. Почему не один?? Теперь, если понадобится изменить данные на страничке, то нужно будет менять их в одном месте - на сервере, а не на всех наших хостпотах. А ещё внешний сервер нам будет нужен для интерактивности. Ведь RouterOS не может работать с "полноценными" языками программирования, такими как Python, Perl, PHP, а нам нужно будет "общаться" с клиентом. Так как у меня есть опыт работы с Apache, PHP и Debian, то я выбрал именно этот стек. Вы можете использовать то, что вам ближе.</div><div>Замечу, что хотспотов много, а веб-сервер один. Можно было бы сделать один хотспот для ещё большего удобства конфигурирования, но микротик не позволяет делать хотспоты в разных широковещательных доменах, а в моем случае так и есть.</div><div><br /></div><div>На сервер браузер пользователя попадает через редирект со страницы login.html, передавая тем же POST'ом те же данные. На сервере нас встречает уже "умная" страница приветствия, предлагая получить интернет.&nbsp;</div><div><br /></div><div>Дальше нам необходимо проверить, авторизовывался ли уже этот пользователь в нашей сети. RouterOS обращается к RADIUS серверу с указанными логином и паролем, а он (RADIUS) хранит эти данные в MySQL базе. Если пользователь уже есть в нашей БД, то он спокойно получает интернет. Если же нет, то предлагается авторизоваться. Согласно П<span style="font-family: inherit; letter-spacing: 0.2px;">остановления Правительства Российской Федерации от 31 июля 2014 г. N 758 мы обязаны авторизовывать всех своих пользователей. Делать это мы будем посредством кодов, передаваемых в СМС.</span></div><div><span style="font-family: inherit; letter-spacing: 0.2px;"><br /></span></div><div><span style="letter-spacing: 0.2px;">Клиент вводит свой номер, PHP генерирует код и отправляет его по СМС. Клиент вводит код и, если введенный код совпадает со сгенерированным ранее, то разрешается доступ в Интернет, а логин и пароль клиента заносятся в БД. На самом деле, в БД можно занести ещё много интересных данных о нашем клиенте, но это выходит за рамки статьи.</span></div><div><br /></div><div>При выборе данных, используемых для авторизации я столкнулся с проблемой. Надо узнать эти данные при попытке входа и не напрягать при этом пользователя. Я решил использовать MAC адрес клиентского девайса, тем более получить его проще простого.<br /><br />Перейдем от описания работы системы к её настройке.</div><h2>RADIUS, MySQL&nbsp;</h2><div>Про установку и настройку Debian я писать не буду. <a href="http://www.bubnovd.net/2011/03/debian.html" target="_blank">Где-то</a> <a href="http://www.bubnovd.net/2011/08/linux-server-2-iptables.html" target="_blank">в моем</a> <a href="http://www.bubnovd.net/2011/09/linux-server-3-nfs.html" target="_blank">блоге </a><a href="http://www.bubnovd.net/2012/09/linux.html" target="_blank">уже </a><a href="http://www.bubnovd.net/2013/02/lvm.html" target="_blank">есть </a><a href="http://www.bubnovd.net/2013/02/blog-post_28.html" target="_blank">статьи </a><a href="http://www.bubnovd.net/2011/05/gentoo.html" target="_blank">об этом.</a>&nbsp;Кратко что нужно сделать: поправить sources.list, обновить репозитории и систему, настроить права пользователей, ssh, sudo, настроить простейшие правила фаервола.</div><div><br /></div><div>Устанавливаем апач:&nbsp;</div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">aptitude install apache2</span><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-7aySBOEss4s/WAOaW-_iz5I/AAAAAAAAA0c/SyC7WCk_g4Q9KHZSBi5AkzxYcmz_O99tgCLcB/s1600/apache-work.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="212" src="https://1.bp.blogspot.com/-7aySBOEss4s/WAOaW-_iz5I/AAAAAAAAA0c/SyC7WCk_g4Q9KHZSBi5AkzxYcmz_O99tgCLcB/s320/apache-work.PNG" width="320" /></a></div><br /></div><div><br /></div><div>СУБД</div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">aptitude install mysql-server</span></div><div><br /></div><div>PHP</div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">aptitude install php5 php5-pear php5-mysql</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span>PHPmyAdmin, если вам привычнее работать с MySQL через веб оболочку.<br /><br /></div><div>Чтобы проверить работу php, создаем файл /var/www/html/phpinfo.php со следующим содержанием:<br /><br /><br />&lt;?php<br />phpinfo();<br />?&gt;<br /><br /><br />Перезапускаем апач service apache2 restart и открываем http://your_ip/phpinfo.php. Должны увидеть что-то подобное:<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-65ieCzIwnjw/WAOb85lOUGI/AAAAAAAAA0o/67CIVzSvU9wARFdjb3kPl-Ym8p7Is-DdwCLcB/s1600/php-work.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="230" src="https://2.bp.blogspot.com/-65ieCzIwnjw/WAOb85lOUGI/AAAAAAAAA0o/67CIVzSvU9wARFdjb3kPl-Ym8p7Is-DdwCLcB/s320/php-work.PNG" width="320" /></a></div><br /><br /></div><div>Также нам пригодится curl</div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">aptitude install curl</span></div><div><br /></div><div>RADIUS</div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">aptitude install freeradius freeradius-mysql freeradius-utils</span></div><div><br /></div><div><br /></div><div>Создаем БД для наших пользователей:&nbsp;</div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">mysql -u root -p</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">CREATE DATABASE db_hotspot;</span></div><div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-LsPjDnQ2nE8/WAOc04vrc7I/AAAAAAAAA0s/6lA3zHH0yV0LeXWZ_Do5ymwkrepoc8DiQCLcB/s1600/create-database.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="74" src="https://2.bp.blogspot.com/-LsPjDnQ2nE8/WAOc04vrc7I/AAAAAAAAA0s/6lA3zHH0yV0LeXWZ_Do5ymwkrepoc8DiQCLcB/s320/create-database.PNG" width="320" /></a></div><br /></div><div>Создаем пользователя MySQL, чтоб не лазить в базу рутом:&nbsp;</div><div><br /></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">GRANT ALL PRIVILEGES ON db_hotspot.* to hsuser@localhost IDENTIFIED BY 'supermegapassword' WITH GRANT OPTION;</span></div><div><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-G_99sQo9wqo/WAOdqXVuNNI/AAAAAAAAA0w/fmFhB_AhQpU_H5iMDTKjP09Eh3H4zUyTACLcB/s1600/create-user.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="46" src="https://4.bp.blogspot.com/-G_99sQo9wqo/WAOdqXVuNNI/AAAAAAAAA0w/fmFhB_AhQpU_H5iMDTKjP09Eh3H4zUyTACLcB/s320/create-user.PNG" width="320" /></a></div><br /></div><div>Далее &nbsp;разворачиваем в базу необходимые таблицы:</div><div><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; text-align: justify;">mysql -u hsuser -p db_hotspot &lt; /etc/freeradius/sql/mysql/schema.sql</span></div><div><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; text-align: justify;">mysql -u hsuser -p db_hotspot &lt; /etc/freeradius/sql/mysql/nas.sql</span><br /><span style="background-color: white; text-align: justify;"><br /></span></div><div><span style="background-color: white; text-align: justify;"><br /></span></div><div style="text-align: justify;"><span style="background-color: white;">В случае с freeradius3:</span><br /><span style="background-color: white;"><span style="font-family: courier new, courier, monospace;">mysql -u hsuser -p db_hotspot &lt; /etc/freeradius/3.0/mods-config/sql/main/mysql/schema.sql</span></span><br /><span style="background-color: white;"><br /></span><span style="background-color: white;">Проверим, что все получилось. Логинимся <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">mysql -u hsuser -p</span> и проверяем созданные таблицы use db_hotspot;&nbsp;</span></div><div style="text-align: justify;"><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">show tables;</span></div><div style="text-align: justify;"><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Ph-InEcn55g/WAOhKV-VM1I/AAAAAAAAA1A/Q-GuXIpETXEYgDGp2QjJTm3MHzgTvr_CACLcB/s1600/import-db.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://1.bp.blogspot.com/-Ph-InEcn55g/WAOhKV-VM1I/AAAAAAAAA1A/Q-GuXIpETXEYgDGp2QjJTm3MHzgTvr_CACLcB/s1600/import-db.PNG" /></a></div><span style="background-color: white;"><br /></span></div>В freeradius 3:<br />ln -s /etc/freeradius/3.0/mods-available/sql /etc/freeradius/3.0/mods-enabled/sql<br /><br /><br />Корректируем настройки RADIUS:<br /><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/etc/freeradius/sql.conf</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; &nbsp; # Connection info:</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; &nbsp; server = "localhost"</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; &nbsp; #port = 3306</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; &nbsp; login = "hsuser"</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; &nbsp; password = "supermegapassword"</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">radius_db = "db_hotspot"</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: inherit;"><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; text-align: justify;">/etc/freeradius/sites-enabled/default</span></span></div><div><span style="font-family: inherit;"><span style="background-color: white; text-align: justify;">В секциях authorize, accounting, session, post-auth необходимо убрать комментарий напротив sql.</span></span></div><div style="text-align: justify;"><span style="background-color: white;"><br /></span></div></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/etc/freeradius/radiusd.conf</span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;">убрать комментарий $INCLUDE sql.conf</span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/etc/freeradius/clients.conf</span></div><div style="text-align: justify;"><span style="background-color: white;">Добавляем строки, в которых указываем подсеть ваших хотспотов и учетные данные для соединения микротиков с радиус сервером.</span></div><div style="text-align: justify;"><span style="background-color: white;"></span><br /><div><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 192.168.0.0/16 {</span></div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="background-color: white;"></span></span><br /><div><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; &nbsp; secret &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= radiuspassword</span></div><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"></span><br /><div><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; &nbsp; shortname &nbsp; &nbsp; &nbsp; = hs-routers</span><br /><span style="background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">}</span></div><span style="background-color: white;"></span><br /><div><span style="background-color: white;"><br /></span></div><span style="background-color: white;"></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;">Перезапускаем радиус с новыми конфигами:</div><div style="text-align: justify;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/etc/init.d/freeradius restart&nbsp;</span></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Прописываем в микротик параметры подключения к радиус серверу. Я рекомендую указать в src address тот IP адрес вашего роутера, который вам понятен. Чтобы легче было дебажить стык RADIUS сервер - Mikrotik. Да и в будущем может появиться ещё адрес (например, туннель).</div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-0DQX4MgM_sY/V_5COq1SM-I/AAAAAAAAA0M/wiGfGLUKWDwLgXQvZ3qUs9Tch699SNRyACLcB/s1600/3.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://2.bp.blogspot.com/-0DQX4MgM_sY/V_5COq1SM-I/AAAAAAAAA0M/wiGfGLUKWDwLgXQvZ3qUs9Tch699SNRyACLcB/s320/3.PNG" width="270" /></a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;">Конфигурируем hotspot на Mikrotik</span><br /><br />В моем случае есть основная WiFi сеть для сотрудников на wlan1 и отдельный wlan-интерфейс для hotspot. Создаем VirtualAP и security profile без авторизации для него. Я создаю ещё и отдельный bridge для &nbsp;hotspot, чтобы удобно было добавить к hotspot ещё интерфейс или проверить его работу удаленно.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-Lf6FJlMbB_Q/WGUgKIf-NWI/AAAAAAAAA54/YVgErIutfowZfgNuTAEErV35g_sBkmphQCLcB/s1600/br.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="257" src="https://3.bp.blogspot.com/-Lf6FJlMbB_Q/WGUgKIf-NWI/AAAAAAAAA54/YVgErIutfowZfgNuTAEErV35g_sBkmphQCLcB/s400/br.PNG" width="400" /></a></div><br /></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;">Предварительно создаем IP Pool и DHCP Server для hotspot сети, а так же назначаем адрес на интерфейсе hotspot. Я не буду подробно описывать как это делается, так как задача типичная и материала в интернете много.</span></span><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-I1e-QePB6e0/WGUiPrPfd5I/AAAAAAAAA6I/53gY7XNI6C0nJxZ0dQR08qnnYJyvzRGLgCLcB/s1600/dhcp.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="237" src="https://4.bp.blogspot.com/-I1e-QePB6e0/WGUiPrPfd5I/AAAAAAAAA6I/53gY7XNI6C0nJxZ0dQR08qnnYJyvzRGLgCLcB/s400/dhcp.PNG" width="400" /></a></div><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span><span style="background-color: white;"><span style="font-family: inherit;">Создаем профиль хотспота: логин по HTTP PAP и Trial, Use RADIUS&nbsp;</span></span><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-DGNdHTqfV6E/WGUgqj_EokI/AAAAAAAAA58/TigsXUNjtTMyu0R6Xga6VVs18yMI-nazgCLcB/s1600/hs-prof.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="265" src="https://4.bp.blogspot.com/-DGNdHTqfV6E/WGUgqj_EokI/AAAAAAAAA58/TigsXUNjtTMyu0R6Xga6VVs18yMI-nazgCLcB/s400/hs-prof.PNG" width="400" /></a></div><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;">Создаем профиль пользователя: address pool я не указываю, так как он указан в настройках сервера, как мы рассмотрим чуть ниже, Open Status Page - HTTP Login</span></span><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-_dP-2o4cgvI/WGUheIzb4jI/AAAAAAAAA6E/icz6uiX5hPEFbZ4GKLIdNEtOFyWysDWYgCLcB/s1600/user-pr.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="395" src="https://3.bp.blogspot.com/-_dP-2o4cgvI/WGUheIzb4jI/AAAAAAAAA6E/icz6uiX5hPEFbZ4GKLIdNEtOFyWysDWYgCLcB/s400/user-pr.PNG" width="400" /></a></div><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;">Создаем профиль hotspot сервера: выбираем созданный IP Pool, интерфейс hotspot и созданный профиль хотспот.</span></span><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-KecdQ2rWLnU/WGUi0RY7thI/AAAAAAAAA6M/3Czq2NBxw8Yp-sLSRqN5hUbdna86meLmQCLcB/s1600/hs.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="273" src="https://3.bp.blogspot.com/-KecdQ2rWLnU/WGUi0RY7thI/AAAAAAAAA6M/3Czq2NBxw8Yp-sLSRqN5hUbdna86meLmQCLcB/s400/hs.PNG" width="400" /></a></div><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;">Сейчас в корне файловой системы роутера должна создаться папка hotspot с файлами, необходимыми для работы в дефолтном режиме. Описание этих файлов есть в <a href="http://wiki.mikrotik.com/wiki/Manual:Customizing_Hotspot" target="_blank">вики</a>. Мы будем делать свою систему авторизации, поэтому нам необходимо переделать файл login.html.</span></span><br /><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span><span style="background-color: white;">Ниже содержимое моего login.html</span><br /><span style="background-color: white;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;html&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;head&gt;&lt;title&gt;...&lt;/title&gt;&lt;/head&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;body&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">$(if chap-id)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;noscript&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;center&gt;&lt;b&gt;JavaScript required. Enable JavaScript to continue.&lt;/b&gt;&lt;/center&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;/noscript&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">$(endif)</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;center&gt;If you are not redirected in a few seconds, click 'continue' below&lt;br&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;form name="redirect" action="http://192.168.15.3/login-redir.php" method="post"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="mac" value="$(mac)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="ip" value="$(ip)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="username" value="$(mac)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="password" value="$(mac)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="link-login" value="$(link-login)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="link-orig" value="$(link-orig)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="error" value="$(error)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="chap-id" value="$(chap-id)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="chap-challenge" value="$(chap-challenge)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="link-login-only" value="$(link-login-only)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="link-orig-esc" value="$(link-orig-esc)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="mac-esc" value="$(mac-esc)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="hidden" name="identity" value="$(identity)"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;input type="submit" value="continue"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;/form&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;script language="JavaScript"&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;!--</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp;document.redirect.submit();</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">//--&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;/script&gt;&lt;/center&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;/body&gt;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="background-color: white;"></span></span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;/html&gt;</span><br /><br />В строке&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&lt;form name="redirect" action="http://192.168.15.3/login-redir.php" method="post"&gt;</span><br />мы указываем страницу на сервере, на которую будем редиректить авторизацию. Далее в скрытых полях передаем параметры, полученные от hotpost:<br /><br /><ul><li>MAC адрес клиента</li><li>IP клиента</li><li>В качестве username и password мы используем MAC адрес клиента. Такой метод выбран для того, чтобы пользователю не приходилось при каждом подключении вводить username - он автоматом берется от hotpost сервера.</li><li><br /></li></ul></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><span style="font-family: inherit;">chmod +x login-redir.php </span></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;">&lt;?php<br />&nbsp; &nbsp;$mac=$_POST['mac'];<br />&nbsp; &nbsp;$ip=$_POST['ip'];<br />&nbsp; &nbsp;$username=$_POST['username'];<br />&nbsp; &nbsp;$password=$_POST['password'];<br />&nbsp; &nbsp;$linklogin=$_POST['link-login'];<br />// &nbsp; $linkorig=$_POST['link-orig'];<br />&nbsp; &nbsp;$linkorig='http://u-dengi.ru';<br />&nbsp; &nbsp;$error=$_POST['error'];<br />&nbsp; &nbsp;$chapid=$_POST['chap-id'];<br />&nbsp; &nbsp;$chapchallenge=$_POST['chap-challenge'];<br />&nbsp; &nbsp;$linkloginonly=$_POST['link-login-only'];<br />&nbsp; &nbsp;$linkorigesc=$_POST['link-orig-esc'];<br />&nbsp; &nbsp;$macesc=$_POST['mac-esc'];<br />&nbsp; &nbsp;$identity=$_POST['identity'];<br />&nbsp; &nbsp;$phone=$_POST['phone'];<br />&nbsp; &nbsp;$code=$_POST['code'];<br />&nbsp; &nbsp;$iscode=$_POST['iscode'];<br />&nbsp; &nbsp;$authcode=$_POST['authcode'];<br />&nbsp; &nbsp;$thispage='http://192.168.15.3/login-redir.php';<br />?&gt;<br />&lt;!DOCTYPE html&gt;<br />&lt;html lang="en"&gt;<br />&nbsp; &lt;head&gt;<br />&nbsp; &nbsp; &lt;meta charset="utf-8"&gt;<br />&nbsp; &nbsp; &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;<br />&nbsp; &nbsp; &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;<br />&nbsp; &nbsp; &lt;meta name="description" content=""&gt;<br />&nbsp; &nbsp; &lt;meta name="author" content=""&gt;<br /><br /><br /><br />&nbsp; &lt;style type="text/css"&gt;<br />&nbsp; &nbsp; &nbsp; body {<br />&nbsp; &nbsp; &nbsp; &nbsp; padding-top: 60px;<br />&nbsp; &nbsp; &nbsp; &nbsp; padding-bottom: 40px;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; background: url(img/bg.jpg) no-repeat center top;<br />&nbsp; &nbsp; &nbsp; &nbsp; -webkit-background-size: cover;<br />&nbsp; &nbsp; &nbsp; &nbsp; -moz-background-size: cover;<br />&nbsp; &nbsp; &nbsp; &nbsp; -o-background-size: cover;<br />&nbsp; &nbsp; &nbsp; &nbsp; background-size: cover;<br />&nbsp; &nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; &nbsp; .form-signin {<br />&nbsp; &nbsp; &nbsp; &nbsp; max-width: 300px;<br />&nbsp; &nbsp; &nbsp; &nbsp; padding: 19px 29px 29px;<br />&nbsp; &nbsp; &nbsp; &nbsp; margin: 0 auto 20px;<br />&nbsp; &nbsp; &nbsp; &nbsp; background-color: #fff;<br />&nbsp; &nbsp; &nbsp; &nbsp; border: 1px solid #e5e5e5;<br />&nbsp; &nbsp; &nbsp; &nbsp; -webkit-border-radius: 5px;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-moz-border-radius: 5px;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; border-radius: 5px;<br />&nbsp; &nbsp; &nbsp; &nbsp; -webkit-box-shadow: 0 1px 2px rgba(0,0,0,.05);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-moz-box-shadow: 0 1px 2px rgba(0,0,0,.05);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; box-shadow: 0 1px 2px rgba(0,0,0,.05);<br />&nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; .form-signin .form-signin-heading,<br />&nbsp; &nbsp; &nbsp; .form-signin .checkbox {<br />&nbsp; &nbsp; &nbsp; &nbsp; margin-bottom: 10px;<br />&nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; .form-signin input[type="text"],<br />&nbsp; &nbsp; &nbsp; .form-signin input[type="password"] {<br />&nbsp; &nbsp; &nbsp; &nbsp; font-size: 16px;<br />&nbsp; &nbsp; &nbsp; &nbsp; height: auto;<br />&nbsp; &nbsp; &nbsp; &nbsp; margin-bottom: 15px;<br />&nbsp; &nbsp; &nbsp; &nbsp; padding: 7px 9px;<br />&nbsp; &nbsp; &nbsp; }<br />a, a:link, a:visited, a:active { color: #AAAAAA; text-decoration: none; font-size: 10px; }<br />a:hover { border-bottom: 1px dotted #c1c1c1; color: #AAAAAA; }<br />img {border: none;}<br />td { font-size: 14px; color: #7A7A7A; }<br />&lt;/style&gt;<br /><br /><br /><br />&nbsp; &nbsp; &lt;title&gt;Удобный WiFi&lt;/title&gt;<br /><br />&nbsp; &nbsp; &lt;!-- Bootstrap core CSS --&gt;<br />&nbsp; &nbsp; &lt;link href="css/bootstrap.min.css" rel="stylesheet"&gt;<br /><br />&nbsp; &nbsp; &lt;!-- Custom styles for this template --&gt;<br />&nbsp; &nbsp; &lt;link href="css/jumbotron-narrow.css" rel="stylesheet"&gt;<br /><br />&nbsp; &nbsp; &lt;!-- Just for debugging purposes. Don't actually copy this line! --&gt;<br />&nbsp; &nbsp; &lt;!--[if lt IE 9]&gt;&lt;script src="../../assets/js/ie8-responsive-file-warning.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;<br /><br />&nbsp; &nbsp; &lt;!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries --&gt;<br />&nbsp; &nbsp; &lt;!--[if lt IE 9]&gt;<br />&nbsp; &nbsp; &nbsp; &lt;script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"&gt;&lt;/script&gt;<br />&nbsp; &nbsp; &nbsp; &lt;script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"&gt;&lt;/script&gt;<br />&nbsp; &nbsp; &lt;![endif]--&gt;<br />&nbsp; &lt;/head&gt;<br />&nbsp; &lt;body&gt;&lt;font size="" color="#ffffff"&gt;<br /><br />&nbsp; &nbsp; &lt;div class="container"&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;div id="" align="center"&gt;<br />&lt;!-- &lt;form name='fooooorm'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='text' name='fooormtxt' value='teeeext'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='submit' class='btn btn-lg btn-primary btn-block' value='sabmeeeet'&gt;<br />&lt;/form&gt; --&gt;<br />&lt;?php<br />if (empty($error)){<br />&nbsp; &nbsp; &nbsp; &nbsp; echo "&lt;form name='sendin' action='$linkloginonly' method='post'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='username' value='$username'/&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='password' value='$password'/&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='dst' value='$linkorig' /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='popup' value='true' /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='submit' class='btn btn-lg btn-primary btn-block' value='Получить удобный Интернет!' /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/form&gt;";<br /><br />}<br />&nbsp; &nbsp; &nbsp; &nbsp; else {<br />// &nbsp; &nbsp; &nbsp;echo "ERROR: $error &lt;br&gt;";<br />&nbsp; &nbsp; &nbsp; &nbsp; if (empty($phone)){<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $code = rand(0,9999);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo "&lt;h5&gt;&lt;font color=#0000cc&gt;Чтобы получить код авторизации, введите номер телефона&lt;/font&gt;&lt;/h5&gt;&lt;br&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;form name='registration' action='$thispage' method='post'&gt; \n<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='text' class='form-control' name='phone' placeholder='9123456789' maxlength='10' /&gt; &lt;br&gt;\n<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='submit' class='btn btn-lg btn-primary btn-block' value='Получить код' /&gt; \n<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='mac' value='$mac'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='ip' value='$ip'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='username' value='$username'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='password' value='$password'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='link-login' value='$link-login'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='link-orig' value='$link-orig'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='error' value='$error'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='chap-id' value='$chap-id'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='chap-challenge' value='$chap-challenge'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='link-login-only' value='$linkloginonly'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='link-orig-esc' value='$link-orig-esc'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='mac-esc' value='$mac-esc'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='code' value='$code'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='identity' value='$identity'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/form&gt;";<br />&nbsp; &nbsp; &nbsp; &nbsp; } else {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (empty($authcode)){<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($curl = curl_init()){<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curl_setopt($curl, CURLOPT_URL, 'http://www.mcommunicator.ru/m2m/m2m_api.asmx/SendMessage');<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curl_setopt($curl, CURLOPT_POST, true);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curl_setopt($curl, CURLOPT_POSTFIELDS, "msid=7".$phone."&amp;message=$code&amp;naming=u_dengi_biz&amp;login=79824607067&amp;password=5d55b17c98ce2755e0182ad4b7e252e9");<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $out=curl_exec($curl);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curl_close($curl);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo "&lt;h5&gt;&lt;font color=#0000cc&gt;Введите код, полученный в СМС&lt;/font&gt;&lt;/h5&gt;&lt;br&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;form name='reg' action='$thispage' method='post'&gt; \n<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='text' class='form-control 'name='authcode' maxlength='4' /&gt; &lt;br&gt;\n<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='submit' class='btn btn-lg btn-primary btn-block' value='Получить интернет' /&gt; \n<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='mac' value='$mac'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='ip' value='$ip'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='username' value='$username'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='password' value='$password'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='link-login' value='$link-login'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='link-orig' value='$link-orig'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='error' value='$error'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='chap-id' value='$chap-id'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='chap-challenge' value='$chap-challenge'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='link-login-only' value='$linkloginonly'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='link-orig-esc' value='$link-orig-esc'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='mac-esc' value='$mac-esc'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='phone' value='$phone'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='code' value='$code'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='identity' value='$identity'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/form&gt;";<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($code == $authcode) {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $db_host = "localhost";<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $db_user = "hotspot";<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $db_password = "this_is_hs-passw0rd";<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $db_table = "db_hotspot";<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $db = mysql_connect($db_host, $db_user, $db_password) OR DIE ('Нет соединения с MySQL' . mysql_error());<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_select_db("db_hotspot",$db);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_query ("INSERT INTO radcheck (username, attribute, value) values ('$username', 'Password', '$password')");<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_query ("INSERT INTO phones (mac, phone, identity, datetime) values ('$username', '$phone', '$identity', now())");<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mysql_close($db);<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $url="http://mfo-api.u-dengi.biz/work/hs/SecureConnectionToWiFI/" . $identity . "/" . $mac . "/" . $phone . "/" . date("M/d/Y-H:i:s");<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($curl = curl_init()){<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curl_setopt($curl, CURLOPT_URL, $url);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $out=curl_exec($curl);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curl_close($curl);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo "&lt;form name='authorization' action='$linkloginonly' method='post'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='username' value='$username'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='password' value='$password'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type='hidden' name='dst' value='http://u-dengi.ru'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/form&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;script type='text/javascript'&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; document.authorization.submit();<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/script&gt;";<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo "Nevernyi kod!";<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; }<br /><br />}<br /><br />?&gt;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;br&gt;<br />&lt;!-- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;input type="button" class="btn btn-lg btn-primary btn-block" value="Воспользоваться бесплатным Интернетом!" onclick="location.href='&lt;?php echo $linkloginonly; ?&gt;?dst=&lt;?php echo $linkorigesc; ?&gt;&amp;username=T-&lt;?php echo $macesc; ?&gt;'" /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;input type="button" class="btn btn-lg btn-primary btn-block" value="Воспользоваться бесплатным Интернетом!" onclick="location.href='$(link-login-only)?dst=http://u-dengi.ru/&amp;username=T-$(mac-esc)'" /&gt; --&gt;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/div&gt;<br />&nbsp; &nbsp;&lt;!-- /container --&gt;<br /><br /><br />&nbsp; &nbsp; &lt;!-- Bootstrap core JavaScript<br />&nbsp; &nbsp; ================================================== --&gt;<br />&nbsp; &nbsp; &lt;!-- Placed at the end of the document so the pages load faster --&gt;<br />&nbsp;&lt;/font&gt;<br />&nbsp;&lt;script src="js/jquery.min.js"&gt;&lt;/script&gt;<br />&nbsp; &nbsp; &lt;script src="js/bootstrap.min.js"&gt;&lt;/script&gt;<br />&lt;!-- &lt;?php<br />print "mac= $mac &lt;br&gt;";<br />print "ip= $ip &lt;br&gt;";<br />print "username= $username &lt;br&gt;";<br />print "linklogin= $linklogin &lt;br&gt;";<br />print "linkorig= $linkorig &lt;br&gt;";<br />print "error= $error &lt;br&gt;";<br />print "chapid= $chapid &lt;br&gt;";<br />print "chapchallenge= $chapchallenge &lt;br&gt;";<br />print "linkloginonly= $linkloginonly &lt;br&gt;";<br />print "linkorigesc= $linkorigesc &lt;br&gt;";<br />print "macesc= $macesc &lt;br&gt;";<br />print "curl_out= $out &lt;br&gt;";<br />print "code= $code &lt;br&gt;";<br />print "phone= $phone &lt;br&gt;";<br />?&gt; --&gt;<br /><br />&nbsp;&lt;/body&gt;<br /><span style="background-color: white;"><span style="font-family: inherit;"></span></span><br />&lt;/html&gt;<br /><div><br /></div></div><div style="text-align: justify;"><span style="background-color: white;"><span style="font-family: inherit;"><br /></span></span></div><div style="text-align: justify;"><span style="background-color: white;">http://asp24.com.ua/blog/nastojka-hotspot-mikrotik-s-ispol-zovaniem-freeradius-i-mysql/</span></div><div style="text-align: justify;"><span style="background-color: white;">http://iantonov.me/page/nastraivaem-lamp-linux-apache-mysql-php-v-debian-7</span></div><div style="text-align: justify;"><span style="background-color: white;">https://habrahabr.ru/sandbox/96309/</span><br /><span style="background-color: white;">https://wiki.freeradius.org/guide/SQL-HOWTO-for-freeradius-3.x-on-Debian-Ubuntu</span></div>
