+++
title = "Linux Server. 2 Настройка iptables"
date = 2011-08-25T01:49:00Z
updated = 2013-05-29T11:37:18Z
tags = ["Linux Server", "ubuntu", "iptables", "debian"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Займёмся правильной настройкой фаервола. На самом деле пакетный фильтр в Linux носит имя netfilter. А iptables - утилита для его настройки. Правильная настройка любого фаервола ведется по правилу: "Что не разрешено - то запрещено". То есть сначала нужно закрыть всё.<br /><br /><a name='more'></a>Все действия выполняются из под суперпользователя. sudo su<br />Закрываем всё:<br /><i><span style="color: #990000;">iptables -P INPUT DROP</span></i><br /><i><span style="color: #990000;">iptables -P FORWARD DROP</span></i><br /><i><span style="color: #990000;">iptables -P OUTPUT DROP</span></i><br /><br />Если нужно, чтобы на машину ходили пинги, нужно разрешить icmp-пакеты:<br /><i><span style="color: #990000;">iptables -A INPUT -p icmp -j ACCEPT</span></i><br /><i><span style="color: #990000;">iptables -A OUTPUT -p icmp -j ACCEPT</span></i><br />В этом случае пинги будут ходить отовсюду. Чтобы разрешить пинг только с конкретных ip/подсетей, пишем следующее (предыдущее не пишем):<br /><i><span style="color: #990000;">iptables -A INPUT -s 192.168.0.100 -p icmp -j ACCEPT</span></i><br /><i><span style="color: #990000;">iptables -A OUTPUT -d 192.168.0.100 -p icmp -j ACCEPT</span></i><br />В этом случае 192.168.0.100 - ip машины, с которой можно пинговать. Чтобы задать подсеть, достаточно написать 192.168.0.0/24, где 24 - маска подсети (можно писать 255.255.255.0).<br /><br />Открытие портов производим по такому же принципу. Если конкретный адрес/подсеть не указаны, порты откроются для всех. Не забываем, что если в цепочке INPUT указывается s (source), то в OUTPUT - d (destination), и наоборот. Откроем 22 порт для 192.168.0.100:<br /><i><span style="color: #990000;">iptables -A INPUT -s 192.168.0.100 -p tcp --dport 22 -j ACCEPT</span></i><br /><i><span style="color: #990000;">iptables -A OUTPUT -d 192.168.0.100 -p tcp --sport 22 -j ACCEPT</span></i><br /><br />Не забываем открыть DNS порты, иначе сами сможем ходить в нет только по айпишникам:<br /><span style="color: #990000;"><i>iptables -A INPUT -p udp --sport 53 -j ACCEPT</i></span><br /><span style="color: #990000;"><i>iptables -A OUTPUT -p udp --dport 53 -j ACCEPT</i></span><br /><span class="Apple-style-span" style="color: cyan;"><br /></span><br /><b>Проброс портов:</b><br /><u>Задача:</u><br />при попытке соединения с сервером (192.168.0.104) из локальной сети &nbsp;(c IP 192.168.0.100) на порт RDP (3389) - соединять клиента с Windows-сервером (192.168.0.21).<br />Тут нужен <a href="http://ru.wikipedia.org/wiki/NAT">NAT</a>. Сначала нужно включить его поддержку<br /><i><span style="color: #990000;">echo net.ipv4.ip_forward=1 &gt; /etc/sysctl.conf</span></i><br />Перезагружаемся.<br />Теперь пишем правила:<br /><i><span style="color: #990000;">iptables -t nat -A PREROUTING --dst 192.168.0.104 -p tcp --dport 3389 -j DNAT --to-destination 192.168.0.21</span></i><br />Этой командой мы говорим фаерволу, чтобы он добавил в таблицу nat в цепочку PREROUTING правило, которое в пакетах, идущих к машине с фаерволом (192.168.0.104) на порт 3389, заменял адрес назначения пакетов с 192.168.0.104 на 192.168.0.21.<br /><br /><span style="color: #990000;"><i>iptables -t nat -A POSTROUTING -p tcp --dst 192.168.0.21 --dport 3389 -j SNAT --to-source 192.168.0.104</i></span><br />Это пишем уже в цепочку POSTROUTING (т.е. после принятия решения о маршрутизации) таблицы nat, в котором говорим, что пакеты, идущие от нас (192.168.0.104) к 192.168.0.21 меняли адрес отправителя на наш (192.168.0.104). Так как сейчас у них адрес отправителя (192.168.0.100 или адрес той машины, с которой мы хотим подключиться к RDP).<br /><br />Ещё два правила в таблицу filter:<br /><i><span style="color: #990000;">iptables -A FORWARD --dst 192.168.0.21&nbsp;--src 192.168.0.0/24&nbsp;-p tcp --dport 3389 &nbsp;-j ACCEPT</span></i><br /><i><span style="color: #990000;">iptables -A FORWARD --src 192.168.0.0/24&nbsp;--dst 192.168.0.21&nbsp;-p tcp --dport 3389 &nbsp;-j ACCEPT</span></i><br />Эти правила разрешают прохождение пакетов из локалки 192.168.0.0/24 на Windows-сервер (192.168.0.21) на порт 3389 и обратно.<br /><br />Пока что у меня в фаерволе следующие правила:<br /><br /><br /><span style="color: #0b5394;">Chain INPUT (policy DROP)</span><br /><span style="color: #0b5394;">target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; icmp -- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; anywhere</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; udp &nbsp;-- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;udp spt:domain</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;192.168.0.100 &nbsp; &nbsp; &nbsp; &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp dpt:ssh</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp spt:www</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;192.168.0.100 &nbsp; &nbsp; &nbsp; &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp dpt:www</span><br /><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;">Chain FORWARD (policy DROP)</span><br /><span style="color: #0b5394;">target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;192.168.0.0/24 &nbsp; &nbsp; &nbsp; 192.168.0.21 &nbsp; &nbsp; &nbsp; &nbsp;tcp dpt:3389</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;192.168.0.21 &nbsp; &nbsp; &nbsp; &nbsp; 192.168.0.0/24 &nbsp; &nbsp; &nbsp;tcp spt:3389</span><br /><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;">Chain OUTPUT (policy DROP)</span><br /><span style="color: #0b5394;">target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; icmp -- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; anywhere</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; udp &nbsp;-- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;udp dpt:domain</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 192.168.0.100 &nbsp; &nbsp; &nbsp; tcp spt:ssh</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp dpt:www</span><br /><span style="color: #0b5394;">ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 192.168.0.100 &nbsp; &nbsp; &nbsp; tcp spt:www</span><br /><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;">Chain PREROUTING (policy ACCEPT)</span><br /><span style="color: #0b5394;">target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination</span><br /><span style="color: #0b5394;">DNAT &nbsp; &nbsp; &nbsp; tcp &nbsp;-- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 192.168.0.104 &nbsp; &nbsp; &nbsp; tcp dpt:3389 to:192.168.0.21</span><br /><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;">Chain OUTPUT (policy ACCEPT)</span><br /><span style="color: #0b5394;">target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination</span><br /><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;">Chain POSTROUTING (policy ACCEPT)</span><br /><span style="color: #0b5394;">target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination</span><br /><span style="color: #0b5394;">SNAT &nbsp; &nbsp; &nbsp; tcp &nbsp;-- &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 192.168.0.21 &nbsp; &nbsp; &nbsp; &nbsp;tcp dpt:3389 to:192.168.0.104</span><br /><div><br /></div><br /><br />Мануалы:<br /><a href="http://easylinux.ru/node/190/">http://easylinux.ru/node/190/</a><br /><a href="http://www.opennet.ru/docs/RUS/iptables/">http://www.opennet.ru/docs/RUS/iptables/</a><br /><a href="http://www.it-simple.ru/?p=2250">http://www.it-simple.ru/?p=2250</a><br /><br /><br /><span class="Apple-style-span" style="color: blue;">UPD: </span>Для совсем начинающих: можете задать вопросы в комментах или в личку. Обязательно отвечу и постараюсь помочь с простыми решениями (в сложных сам не шарю)<br /><span style="color: blue;">UPD2:</span><span style="color: #cccccc;">&nbsp;Недавно <a href="http://sysadminblog.ru/linux/2012/05/22/primery-ispolzovaniya-iptables.html">здесь </a>выложили ещё один мануал</span>
