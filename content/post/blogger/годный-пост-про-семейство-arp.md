+++
title = "Годный пост про семейство ARP"
date = 2017-01-30T03:12:00Z
updated = 2017-01-30T03:12:28Z
tags = ["windows", "ARP", "MS", "cisco"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Заслуживающий отдельного внимания пост про семейство протоколов ARP и особенности их работы на Windows от <a href="https://www.facebook.com/rvkarmanov" target="_blank">Руслана Карманова</a><br />Оригинал <a href="https://www.atraining.ru/arp-inarp-rarp-proxy-gratuitous-dai-sticky-and-more/" target="_blank">тут</a>. Я просто скопипастил весь текст<br /><br /><header style="background-color: white; box-sizing: border-box; color: #222222; font-family: wf_SegoeUI, &quot;Segoe UI&quot;, &quot;Segoe WP&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 14px;"><h1 class="entry-title" itemprop="name" style="box-sizing: border-box; color: black; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 44px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Семейка протокола ARP</h1><h3 itemprop="headline" style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Протокол ARP вроде бы простой и тривиальный, но количество его однофамильцев с различным функционалом - достаточно серьёзно. Разбираемся.</h3><div><a name='more'></a><br /></div></header><div itemprop="mainEntityOfPage" itemscope="" itemtype="https://schema.org/URL" style="background-color: white; box-sizing: border-box; color: #222222; font-family: wf_SegoeUI, &quot;Segoe UI&quot;, &quot;Segoe WP&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 14px; margin: 0px; padding: 0px;"></div><div class="clear-p" style="background-color: white; box-sizing: border-box; color: #222222; font-family: wf_SegoeUI, &quot;Segoe UI&quot;, &quot;Segoe WP&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 14px; margin: 0px; padding: 0px;"><div class="entry-content" itemprop="articleBody" style="box-sizing: border-box; color: #454545; margin: 0px; padding: 0px;"><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Привет.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><br /></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Многие думают, что если протокол мелкий и незаметный, то про него не надо ничего знать. Нетрудно догадаться, что это не так, и именно детальное знание подобных низкоуровневых задач является тем, что отличает профессионала от гуглоиксперта или фанатика, верующего, что в его любимой ОС всё работает “само по себе и априори идеально”.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><br /></div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Оглавление</h2><ul style="box-sizing: border-box; line-height: 1.6; list-style-position: inside; margin: 14px 0px 14px 3px; padding: 0px;"></ul><ul style="box-sizing: border-box; line-height: 1.6; list-style-position: inside; margin: 14px 0px 14px 3px; padding: 0px;"><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Протокол ARP<ul style="box-sizing: border-box; line-height: 1.6; list-style-position: inside; margin: 4px 0px 4px 5px; padding: 0px;"><li style="box-sizing: border-box; margin: 0px; padding: 0px;">&nbsp;Вкратце про сам протокол и формат заголовка</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">&nbsp;Базовый тюнинг – тайм-ауты и кэш</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">&nbsp;ARP и QoS</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">&nbsp;ARP и NLB</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">&nbsp;ARP и SNAP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">&nbsp;ARP и NUD</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">&nbsp;ARP и DAD</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">&nbsp;ARP и WOL</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;"><del style="box-sizing: border-box;">ARP и РПГ-7</del></li></ul></li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Протокол RARP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Протокол InARP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Протокол UNARP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Протокол SLARP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Протокол DirectedARP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Безопасность ARP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Механизм Proxy ARP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Что такое и как работает Gratuitous ARP</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Cisco ARP Optimization Feature – что это?</li></ul><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Как работает протокол ARP</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Протокол Address Resolution Protocol (ARP) используется для простой задачи – выяснить по известному адресу сетевого уровня (IP) неизвестный адрес канального уровня (например MAC). Данные ARP вкладываются в протокол канального уровня и являются, по уровню вложения, протоколом 3го уровня, а вот по функционалу остаются протоколом 2го уровня. Это я к тому, что модель OSI надо знать не хорошо, а очень хорошо. Для идентификации ARP внутри кадра Ethernet будет использоваться код протокола&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">0x0806</span>. В состав ARP-пакета будет входить следующие интересные поля:</div><ul style="box-sizing: border-box; line-height: 1.6; list-style-position: inside; margin: 14px 0px 14px 3px; padding: 0px;"><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Тип оборудования (длина поля – 2 байта): Код, обозначающий тип среды, в которой идёт работа. Для Ethernet’ов это будет единица, готы могут ставить 5 (для протокола Chaos), эстеты – 149.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Тип протокола сетевого уровня, про который идёт речь в ARP-пакете (длина поля – 2 байта): Стандартный код протокола, такой же, как в 802.3, например. То есть для IPv4 – это&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">0x0800</span>.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Длина адреса канального уровня (длина поля – 1 байт): Сколько байт в адресе канального уровня. Например, для 802.3 это будет 6.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Длина адреса сетевого уровня (длина поля – 1 байт): Сколько байт в адресе сетевого уровня. Например, для IPv4 это будет 4.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Код операции ARP (длина поля – 2 байта): У операции ARP Request это единица, у ARP Response – двойка. Да, такой вот обильный в плане функционала протокол. :)</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Адрес канального уровня отправителя (SRC MAC, говоря проще) – уникастовый MAC-адрес интерфейса, с которого отправляется запрос.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Адрес сетевого уровня отправителя (SRC IP, говоря проще) – уникастовый IP-адрес интерфейса, с которого отправляется запрос. В случае нескольких IP-адресов на интерфейсе – основной адрес интерфейса (primary).</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Искомый адрес канального уровня – в случае ARP – широковещательный 802.3 адрес вида FF-FF-FF-FF-FF-FF. Ведь очевидно, что раз делается ARP-запрос вида “я знаю только искомый IP-адрес”, то искомый адрес канального уровня неизвестен, поэтому сюда пишется “заглушка” из броадкаста. На фактическое распространение она не влияет, т.к. в самом Ethernet-кадре, в котором вложен ARP-запрос, уже указан броадкаст как DST MAC.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Искомый адрес сетевого уровня – в случае ARP – тот самый IP-адрес, для которого надо найти соответствующий MAC.</li></ul><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Задачи, стоящие перед протоколом, достаточно прозрачны. Как он будет настраиваться?</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Базовые операции с ARP для Windows</h3><h4 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 23px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Почистить локальный кэш ARP или удалить отдельную запись</h4><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Кэш:&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp -d</span><br style="box-sizing: border-box;" />Запись:&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp -d&nbsp;<i style="box-sizing: border-box; line-height: inherit;">ip-адрес</i></span></div><h4 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 23px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Добавить статическую ARP-запись</h4><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp -s&nbsp;<i style="box-sizing: border-box; line-height: inherit;">ip-адрес</i>&nbsp;<i style="box-sizing: border-box; line-height: inherit;">mac-адрес</i></span></div><h4 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 23px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Детально посмотреть кэш</h4><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp -a -v</span><br style="box-sizing: border-box;" />Будут видны все типы записей – и static, и dynamic, и invalid. Сам вывод будет разбит по критерию привязки записей к интерфейсам – в начале каждого раздела будет выводиться primary IP интерфейса, а потом его внутренний идентификатор (Вы можете посмотреть табличку интерфейсов и их ID командой&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">netsh int ipv4 sh int</span>).</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Есть и более современный вариант отображения кэша:<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">netsh interface ipv4 show nei</span>. В этой команде вывод также разбит по интерфейсам (правда, пишутся их человеческие названия, а не primary IP), статические и системные записи будут называться Permanent, обычные – Reachable (если доступны), Unreacheable (если нет) и Stale (если запись устарела).</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Базовые операции с ARP на оборудовании Cisco</h3><h4 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 23px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Как добавить статическую запись</h4><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config)#arp&nbsp;<i style="box-sizing: border-box; line-height: inherit;">ip-адрес или “vrf имя-vrf”</i>&nbsp;<i style="box-sizing: border-box; line-height: inherit;">mac-адрес</i>&nbsp;<i style="box-sizing: border-box; line-height: inherit;">тип-вложения</i>&nbsp;<i style="box-sizing: border-box; line-height: inherit;">тип-интерфейса</i></span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Из интересного тут разве что тип вложения – можно указать, какой именно вариант вложения (из реально возможных сейчас – ARPA или SNAP) будет у записи. Параметр “Тип интерфейса” можно не указывать.</div><h4 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 23px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Настроить включение-выключение ARP и его тип</h4><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config-if)#arp&nbsp;<i style="box-sizing: border-box; line-height: inherit;">arpa или frame-relay или snap</i></span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Как понятно, обычно тип ARP будет ARPA и в модификации нуждаться тоже особо не будет. Внимание – типы не являются взаимоисключающими – т.е. можно сделать и&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp arpa</span>&nbsp;и&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp snap</span>, и это лишь покажет, что на данном интерфейсе надо обрабатывать и тот и тот варианты.</div><h4 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 23px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Настроить время нахождения записи в ARP-кэше</h4><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config-if)#arp timeout&nbsp;<i style="box-sizing: border-box; line-height: inherit;">секунды</i></span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Настройка идёт на интерфейсе, т.к. данный тайм-аут будет только у записей в ARP-кэше, сделанных через этот интерфейс.</div><h4 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 23px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Очистить кэш ARP</h4><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Весь:<br style="box-sizing: border-box;" /><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">#clear arp-cache</span><br style="box-sizing: border-box;" />Отдельную запись:<br style="box-sizing: border-box;" /><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">#clear arp-cache&nbsp;<i style="box-sizing: border-box; line-height: inherit;">ip-адрес</i></span><br style="box-sizing: border-box;" />Все записи, привязанные к конкретному интерфейсу:<br style="box-sizing: border-box;" /><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">#clear arp-cache&nbsp;<i style="box-sizing: border-box; line-height: inherit;">интерфейс</i></span></div><h4 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 23px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Настроить работу с incomplete ARP records</h4><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Данные настройки будут нужны, чтобы задать поведение системы в случае “Я точно знаю, что есть сосед с таким IP-адресом, но у меня нет его MAC-адреса”.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Вы можете задать общее число таких адресов, находящихся “в процессе поиска”, а также количество попыток</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Включение:<br style="box-sizing: border-box;" /><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config)#ip arp incomplete enable</span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Количество адресов:<br style="box-sizing: border-box;" /><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config)#ip arp incomplete entries&nbsp;<i style="box-sizing: border-box; line-height: inherit;">число</i></span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Количество попыток:<br style="box-sizing: border-box;" /><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config)#ip arp incomplete retry&nbsp;<i style="box-sizing: border-box; line-height: inherit;">число</i></span></div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Базовый тюнинг ARP – тайм-ауты и кэш</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">В NT 6.0 сетевой стек был ощутимо изменен (приведён в соответствие с RFC 4861), поэтому то, что действовало для XP/2003, работать в большинстве своём не будет. Схема работы ARP-кэша теперь следующая:</div><ul style="box-sizing: border-box; line-height: 1.6; list-style-position: inside; margin: 14px 0px 14px 3px; padding: 0px;"><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Есть кэш “соседей” – для IPv4 и IPv6</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Запись туда идёт после получения ARP-ответа, после чего у строки кэша появляется статус “Reachable”</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Статус теряется в случае отказа интерфейса или по тайм-ауту – если прошло более “ReachableTime” секунд, то статус меняется на “Stale”</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Если хочется отправить пакет узлу, строка кэша для которого находится в состоянии “Stale”, то предварительно надо отправить ARP-запрос</li></ul><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Как точнее считается время? Формула подсчёта такова:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">ReachableTime = BaseReachableTime * (случайный коэффициент между MIN_RANDOM_FACTOR и MAX_RANDOM_FACTOR)</code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Параметры, от которых идёт вычисление, выглядят так: BaseReachableTime = 30 секунд, MIN_RANDOM_FACTOR = 0.5, а MAX_RANDOM_FACTOR – 1.5. Параметр BaseReachableTime изменяем командой:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">netsh interface ipv4 set interface&nbsp;<i style="box-sizing: border-box; line-height: inherit;">имя интерфейса</i>&nbsp;basereachable=<i style="box-sizing: border-box; line-height: inherit;">количество миллисекунд</i></code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Заметьте, для каждого интерфейса это устанавливается отдельно. Ранее действовавшее общесистемное значение по умолчанию в 120 секунд, таким образом, теперь не актуально. Я бы рекомендовал увеличить это значение до тех же 2х минут, что были раньше – количество трафика снизится, а минусов практически нет – узлы, которые сменят MAC за время устаревания кэша, сами об этом уведомят.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">В случае работы с оборудованием Cisco, данный параметр – тайм-аут записи в ARP-кэше – задаётся на интерфейсе командой:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp timeout&nbsp;<i style="box-sizing: border-box; line-height: inherit;">время в секундах</i></code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">и имеет базовое значение в 14400 (это 4 часа).</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Суммарный же объём кэша IPv4-соседей можно установить так:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">netsh interface ipv4 set global neighborcachelimit=<i style="box-sizing: border-box; line-height: inherit;">количество</i></code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">По умолчанию их 256. Как понятно, в случае, если соседей по среде передачи данных мало (например, есть единственный сетевой интерфейс в сеть с маской /28), этот кэш увеличивать не надо, а уменьшить вполне можно. Помните, это именно кэш ARP, т.е. явных адресов соседей по vlan плюс служебных мультикастов. Нет смысла его раздувать до огромных габаритов, если в сети банально мало узлов, нечего кэшировать особо будет.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Давайте теперь чуть углубимся.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">ARP и QoS</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">В случае, когда сетевой интерфейс загружен трафиком, часть трафика может теряться. Увы, ни один из методов queuing не является от этого панацеей. Начиная с Cisco IOS 15.1 можно указать, что на данном интерфейсе необходимо всегда обрабатывать ARP-пакеты в первую очередь, что может значительно сократить процент потери ARP-данных. На общую загрузку это, как понятно, повлияет мало, а вот пользы может принести много. Ведь ARP-пакеты передаются без механизма подтверждения доставки и терять их не очень хорошо.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Данный механизм включается на L3-интерфейсах, командой:<br style="box-sizing: border-box;" /><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp packet-priority enable</code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Выключается, как понятно,&nbsp;<code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">no arp packet-priority enable</code>. В Windows аналогичной процедуры нет.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">ARP и NLB</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Чтобы ARP дружил с NLB, он должен обрабатывать ситуацию, когда придёт ARP-запрос с не-юникастового адреса. То есть, смотрите ситуацию. Допустим, есть NLB, который работает в мультикастовом режиме. Два хоста, соответственно, прикидываются одним IP-адресом, отвечая на ARP-запросы про этот адрес общим мультикастовым MAC’ом, и потом договариваясь друг меж другом, что делать с пришедшим трафиком. Вот чтобы эта схема работала, надо, чтобы когда этот “общий виртуальный узел”, который обладает виртуальным IP и мультикастовым MAC, решил узнать через ARP чей-то MAC, ему вообще ответили. Потому что есть тонкость – у мультикастового MAC есть характерный вид, по которому понятно, что он мультикастовый. А не-юникастовые source MAC в общем-то не являются нормальной ситуацией и нуждаются в особой обработке. Соответственно, для этого надо явно включить обработку ситуации “к нам пришёл ARP-запрос от товарища, у которого обратный MAC-адрес не-юникастовый”. Делается это путём установки параметра:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\EnableBcastArpReply</code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">в единицу. Если она будет в нуле – в ряде ситуаций поимеете проблемы с NLB.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">ARP и SNAP</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">По умолчанию, ARP вкладывается в 802.3 кадр простым, Ethernet II способом. Это можно поменять в случае, если необходима поддержка SNAP-механизма, который, как известно, нужен для мультиплексирования потоков данных на канальном уровне. Напомню, что по RFC 1042 данные IP и ARP всегда передаются поверх 802.x сетей используя связку LLC+SNAP, за исключением обычного Ethernet (802.3), где они вкладываются напрямую (см. RFC 894).</div><div class="commentcode" style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Примечание: Если не известно, то надо задуматься об изучении курса ICND1, потому что детальное рассмотрение “что такое SNAP, зачем, почему, когда, с кем” не входит в спектр задач по изучению ARP.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Для этой задачи есть ключ:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\ArpUseEtherSNAP</code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">По умолчанию он в нуле, установив в единицу Вы получите ситуацию, что ARP-запросы будут вкладываться в SNAP (притом в LLC+SNAP, что увеличит суммарный размер кадра на 3+5=8 байт).</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">ARP и NUD</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">NUD – это Neighbor Unreachability Detection. По умолчанию включается на интерфейсах, которые смотрят в broadcast-среды, и выключается на других. Помогает узнать о том, что сосед (что обычный, что шлюз) перешёл в нефункциональное состояние до времени, пока его запись в ARP-кэше стала Stale. Механизм полезный, поэтому его рекомендуется включать в явном виде. Делается это командой:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">netsh int ipv4 set int&nbsp;<i style="box-sizing: border-box; line-height: inherit;">имя интерфейса</i>&nbsp;nud=enabled</code></div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">ARP и DAD</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">DAD – это Duplicate Address Detection. То самое, что не даёт взять себе адрес, который уже есть у кого-то. Проводится путём отправки Gratuious ARP, про который чуть ниже. Тюнингуется достаточно просто, двумя параметрами:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">netsh int ipv4 set int&nbsp;<i style="box-sizing: border-box; line-height: inherit;">имя интерфейса</i>&nbsp;retransmittime=<i style="box-sizing: border-box; line-height: inherit;">миллисекунды</i></code><br style="box-sizing: border-box;" /><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">netsh int ipv4 set int&nbsp;<i style="box-sizing: border-box; line-height: inherit;">имя интерфейса</i>&nbsp;dadtransmits=<i style="box-sizing: border-box; line-height: inherit;">попытки</i></code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">По умолчанию&nbsp;<code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">retransmittime</code>&nbsp;– т.е. время между попытками обнаружить соседа, который уже занял адрес – 1 секунда, количество попыток&nbsp;<code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">dadtransmits</code>&nbsp;– 3. Можете сократить их, если уверены, что все соседи отвечают достаточно быстро, это уменьшит время инициализации интерфейса – система не будет ждать “вдруг кто проснётся и скажет, что адрес уже занят”.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">ARP и WOL</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Функция Wake-On-Lan, думается, хорошо Вам известна. Она нужна, чтобы узел “проснулся” в определённый момент – когда увидит на сетевом интерфейсе соответствующие неким условиям данные. Обычно это данные, напрямую идущие на данный узел, притом содержащие некую последовательность – Magic Pattern. Так вот, можно заранее указать условие – будет ли данный Magic Pattern искаться вообще во всех сетевых данных, которые попадут на нужный узел, либо только не некоторых. В частности, так как статья про ARP, есть настройка, позволяющая установить для интерфейса условие – анализировать ли на предмет наличия Magic Pattern’а пакеты протоколов ARP (для IPv4) и ND (для IPv6). Включается следующим образом:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">netsh int ipv4 set int&nbsp;<i style="box-sizing: border-box; line-height: inherit;">имя интерфейса</i>&nbsp;forcearpndwolpattern=enabled</code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Как выключается, надеюсь, понятно. Рекомендуется к выключению на узлах, у которых нет задачи просыпаться по WOL, т.к. ускоряет обработку путём раннего отбрасывания механизмом поиска Magic Pattern указанных пакетов.<br style="box-sizing: border-box;" />Теперь про RARP.</div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Протокол RARP</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">RARP – это как ARP, только наоборот. Логично. По сути, RARP – это очень сильно простой сервис по динамическому конфигурированию узлов. Он ведь отрабатывает задачу, обратную ARP.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">ARP: Я знаю искомый L3-адрес, дайте мне соответствующий ему L2-адрес.<br style="box-sizing: border-box;" />RARP: Я знаю искомый L2-адрес, дайте мне соответствующий ему L3-адрес.</div><div class="commentcode" style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Примечание: Обратите внимание, для работы ARP выделенный сервер не нужен, а для RARP – нужен.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">У RARP-сервера есть табличка соответствий MAC и IP-адресов, из которой он берёт указанную информацию и отправляет её. Различия на технологическом уровне будут следующими: RARP-пакеты будут иметь код вложения&nbsp;<code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">0x8035</code>, плюс коды операций у них будут 3 для RARP-запроса и 4 для RARP-ответа.</div><div class="commentcode" style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Примечание: Если код вложения будет от RARP, а коды – 1 или 2 (т.е. как у обычного ARP), то RARP-сервер отдаст данный пакет на обработку ARP-стеку.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Вообще, RARP сейчас практически не используется, но если хотите почитать – есть RFC 903.</div><div class="commentcode" style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Примечание: А если хотите почитать, и чтобы накрыло – почитайте про Dynamic RARP, это RFC 1931.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Реализация RARP-сервера в Windows</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Её нет. Если хочется стороннее решение, то можно&nbsp;<a href="http://www.panix.com/~perin/rarpd.zip" rel="nofollow" style="box-sizing: border-box; color: #1570a6; line-height: inherit; text-decoration: none;">скачать RARP windows server быстро бесплатно без sms</a>.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Реализация RARP-сервера на оборудовании Cisco</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Она есть. Конфигурируется в несколько этапов. По порядку:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Шаг первый: Добавляем запись для потенциального RARP-клиента (т.е. того, кто хочет получить IP-адрес). В глобальной конфигурации:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config)#arp&nbsp;<i style="box-sizing: border-box; line-height: inherit;">ip-адрес</i>&nbsp;<i style="box-sizing: border-box; line-height: inherit;">mac-адрес-клиента</i>&nbsp;arpa</span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Шаг второй: Разрешаем на интерфейсе, в качестве параметра – тот адрес на интерфейсе, от которого отправляем RARP-ответы.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config-if)#ip rarp-server&nbsp;<i style="box-sizing: border-box; line-height: inherit;">ip-адрес</i></span></div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Протокол InARP (Inverse ARP)</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">InARP – специальная модификация ARP для не-broadcast сетей (например, Frame Relay или ATM). Суть проста – в сетях, где нет широковещания, обычный ARP работать не сможет, а задачи, которые им решаются, никуда не пропадают. Соответственно, нужна схема работы. Она будет достаточно интересна и проста. Узел, который поддерживает InARP, будет самостоятельно с указанной периодичностью отправлять в субинтерфейсы, поддерживающие InARP (например, в FR’овские), InARP-сообщения, в которых будет указано что-то вида “привет, я от узла с сетевым адресом таким-то”. Соответственно, принимающая сторона, получая такое сообщение из-под субинтерфейса с DLCI=xxx, будет записывать у себя в таблицу – “За DLCI xxx живёт товарищ с IP yyy”. В общем-то и всё.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Другие отличия будут состоять в использовании других кодов операций – 8 для запроса InARP, 9 для ответа. Ну и в механизме вложения – понятное дело, в Q.922 вкладываться – это не в 802.3</div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Протокол UnARP</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Предлагался в RFC 1868. Суть проста – сам формат пакета ARP не менялся, добавлялся лишь новый тип сообщения – сообщение вида “Я ушёл из сети”. Т.е. задачей дополнения UNARP являлось то, что узлы, которые отключаются, могут послать сообщение “Стирайте меня все из ARP-кэшей”, чтобы остальные не ждали время окончания кэширования записей. К сожалению, не поддерживается (основная причина – небезопасен, т.к. такое сообщение легко подделать).</div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Протокол SLARP (Serial Line ARP)</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Специальный субпротокол, работающий внутри цисковского варианта HDLC (который обычно cHDLC). Используемый код вложения –&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">0x8035</span>. Протокол простой, но интересный тем, что может делать две штуки – проверять состояние канала, периодически передавая кадры, и назначать IPv4-адреса в случае, если с одной стороны serial link адрес IPv4 есть, а с другой – нет. Адрес назначается по логике “Если у меня последний бит адреса 1, предложить такой же, но с нулём, и наоборот”. Маска предлагается такая же, как у себя.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><br /></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Формат кадра будет такой:</div><ul style="box-sizing: border-box; line-height: 1.6; list-style-position: inside; margin: 14px 0px 14px 3px; padding: 0px;"><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Адрес (один байт) – стандартный адрес вида b1111111 из xHDLC/PPP.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Контроль (один байт) – то же самое, опять LLC3, т.е. b00000011.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Код протокола вложения (два байта) – личный номер SLARP,&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">0x8035</span>.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Код операции (один байт) – вариант или Address request(0x00), или address reply (0x01), или Keep-alive (0x02).</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">IPv4-адрес и маска (два раза по 4 байта) – предлагаемый партнёру по serial link адрес.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Резерв (один байт) – вечно 0xFF.</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">FCS в варианте CRC-16 (два байта)</li><li style="box-sizing: border-box; margin: 0px; padding: 0px;">Флаг (один байт) – стандартный флаг xHDLC вида b0111110.</li></ul><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><br /></div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Протокол DirectedARP</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Протокол описан в RFC 1433. Сейчас как отдельный протокол не используется, хотя многие мысли, высказанные в этом RFC, достаточно дельные и повлияли, например, на формирование современного IPv6.</div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Безопасность ARP</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">В общем-то, в ARP нет никаких встроенных средств безопасности. Это очень простой служебный протокол, поэтому о какой-то отдельной защите его говорить трудно. Можно высказать лишь общие мысли – например, что в случае малого количества хостов проще ввести все их IP-MAC соответствия как статические – в этом случае ARP они передавать перестанут (в кэше-то записи про соседей будут всё время), а если кто-то злонамеренный специально передаст поддельный ARP-ответ, то никакого влияния он не окажет – динамически полученный ARP-ответ не перезапишет собой статическую запись.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Есть ряд дополнительных механизмов (которых достаточно много), которые могут помочь в этом вопросе. Например, на оборудовании Cisco есть команда:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">arp authorized</code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">которая, в случае включения на интерфейсе, отключит динамические записи в кэш ARP. Т.е. интерфейс перестанет слушать ARP-ответы от неизвестных клиентов и дополнять ими кэш ARP.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Для ряда моделей оборудования (например, на старших линейках маршрутизаторов – это 7600) можно задать в режиме глобальной конфигурации максимальный размер ARP-кэша для устройства (по умолчанию он не ограничен и составляет 256.000 записей):</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><code style="box-sizing: border-box; font-weight: 700; line-height: inherit;">ip arp entry learn&nbsp;<i style="box-sizing: border-box; line-height: inherit;">количество</i></code></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Есть, в общем-то, множество доп.механизмов безопасности ARP – тот же DAI или ARP ACL, про которые, возможно, я тоже допишу сюда.</div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Механизм Proxy ARP</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Суть механизма Proxy ARP, детально обозначенного в RFC 1027, проста – дать возможность узлу, который в силу каких-то причин (например, у него не указан шлюз по умолчанию) не может понять, куда маршрутизировать трафик для других сетей, всё же сделать это. Притом сделать просто – используя то, что в сегменте с этим узлом присутствует добрый узел, на котором включен Proxy ARP, и который, увидев что узел пытается через ARP-запрос найти получателя трафика, “прикинется” этим получателем и ответит на запрос.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Т.е. вот есть маршрутизатор, на котором включен Proxy ARP. Он получает ARP-запрос на разрешение адреса узла, который находится в другом сегменте относительно спрашивающего и помогает – просто отвечает ему от имени этого узла. Соответственно, этот роутер и будет передавать трафик между данными узлами, а отправитель будет думать, что отправляет трафик напрямую.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Данный механизм включен “по умолчанию” на большинстве систем и нуждается в отключении – т.е. описанная ситуация, в общем-то, по производственной необходимости возникает довольно-таки редко.</div><div class="commentcode" style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Пример: Например, у хоста A адрес 10.1.1.1/24, а у хоста B – 10.1.1.2/16. Технологически они в разных сетях, и между ними даже есть роутер – у него в сторону хоста A смотрит интерфейс 10.1.1.254/24, в сторону хоста B – 10.1.255.254/16. Но вот проблема в том, что хост A не понимает, что хост B – в другой сети, а думает, что B – его сосед. И пытается найти его, отправляя ARP-запрос. Вот в этом случае если роутер будет поддерживать Proxy ARP, то всё будет хорошо – связь между A и B будет.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Как включить Proxy ARP на оборудовании Cisco</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Зайдите на нужный интерфейс и введите там команду:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config-if)#ip proxy-arp</span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Выключить глобально –&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">(config)#ip arp proxy disable</span>.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Как включить Proxy ARP в Windows</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">В случае, когда у Вас используется RRaS, proxy ARP работает автоматически.</div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Что такое и как работает Gratuitous ARP</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Это страшное слово переводится как “самопроизвольный” ARP. Суть события в следующем. Любой узел, который инициирует новый интерфейс, на котором есть поддержка ARP, должен при завершении процесса конфигурирования IP-адреса (статически ли, по DHCP, через APIPA’у – без разницы) уведомить соседей о том, что он появился. Делается это при помощи отправки одиночного ARP Reply, в котором указывается, что логично, связка “мой MAC – мой новый IP”. Т.е. выглядит этот ARP-ответ несколько странно с точки зрения классической схемы работы ARP – узел рассылает на броадкастовый MAC и свой IP информацию о своём настоящем MAC и своём же IP. Т.е. совпадают SRC IP и DST IP.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><i style="box-sizing: border-box; line-height: inherit;">Примечание: По сути, этот механизм – это “форсированное” обновление ARP-кэша соседей новой информацией – “теперь я по этому MAC-адресу”. Заодно, именно благодаря этому механизму, происходит обнаружение дублирующихся IP-адресов – тот, кто пытается присвоить себе IP-адрес, рассылая это уведомление “засветится”.</i></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Но, в общем-то, мы и договорились, что это – исключительная и разовая ситуация. Казалось бы, в чём проблема-то?</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Проблема в том, что когда такое происходит на сервере удалённого доступа, к которому подключено несколько клиентов (более 1, по сути), то этот сервер при подключении каждого своего клиента получает от него данный стартовый запрос ARP и ретранслирует запрос далее, выступая, по сути, прокси. В результате, допустим, порт коммутатора, в который включен этот сервер, впадает в тягостные размышления о здоровье сервера, который постоянно сообщает всей сети о том, что за его MAC-адресом интерфейса (того, который воткнут в коммутатор) очень много IP-адресов, и все они разные. И каждый раз, когда клиент будет подключаться (например, VPN-канал переподключит, или другим способом вызовет переход через NCP-фазу PPP), такой ARP-ответ будет создаваться и отправляться серверу, а тот будет отдавать его дальше – чтобы уведомить сеть, что трафик на такой-то IP-адрес надо отправлять на его, сервера, MAC, а дальше он уж сам разберется.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Соответственно, в ряде ситуаций (например, много клиентов, краткие сессии) такой механизм надо отключать. Зачастую проще привязать статически целую пачку ARP-соответствий (например, когда на сервере удалённого доступа выделен пул в 20 адресов, и абоненты подключаются, делают какую-то краткую операцию и отключаются), чем постоянно форвардить в сеть эти ARP Reply.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><i style="box-sizing: border-box; line-height: inherit;">Примечание: На самом деле, делать это надо с умом, как и всё остальное. Есть ситуации, когда gratuitous ARP является штатным и нужным. Например, у Вас сделан HSRP-балансировщик. Активный узел упал – второй становится активным. И в этот момент он тоже “просто так, внезапно” отправит gratuitous ARP – чтобы сразу уведомить всю сеть, что теперь у виртуального IP новый MAC, а не ждать, пока у всех узлов кончится тайм-аут кэша.</i></div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Как настроить Gratuitous ARP на оборудовании Cisco</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Включить:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">router(config)#ip gratuitous-arps</span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Если добавить в конце команды слово non-local, то будет обрабатываться вышеописанная ситуация с PPP.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Отключить приём всех gratuitous ARP’ов:<br style="box-sizing: border-box;" /><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">router(config)#ip arp gratuitous none</span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Включить приём только gratuitous ARP’ов, source которых из connected-сетей:<br style="box-sizing: border-box;" /><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">router(config)#ip arp gratuitous local</span></div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Как настроить Gratuitous ARP на Windows Server</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Для указанного сценария с RRaS – никак. Ваш RRaS-сервер не будет передавать стартовый ARP-запрос, полученый от PPP-клиента, в другие сети, поэтому ситуация, описанная выше, просто не возникнет.</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Управлять же Gratuitous ARP со стороны узла вполне можно. Для этого есть ключ реестра:</div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;"><span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">HKLM\System\CurrentControlSet\Services\TcpIp\Parameters</span></div><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">а в нём – параметр&nbsp;<span style="box-sizing: border-box; font-weight: 700; line-height: inherit;">ArpRetryCount</span>&nbsp;типа DWORD32. Если поставить этот параметр в нуль, то механизм будет выключен. По умолчанию Windows-хосты делают Gratuitous ARP три раза – сразу после инициализации адреса, потом через 1/2 секунды, потом через ещё 1/10 секунды. Можете поставить единицу, если уверены в качестве работы сети и её не-критичной загруженности на момент выхода ARP Reply – “сэкономите трафик”.<br style="box-sizing: border-box;" /><i style="box-sizing: border-box; line-height: inherit;">Примечание: Считаются фактически отправленные ARP, а не попытки. Т.е. если среда была недоступна, то все равно отправят три, просто чуть позже.</i><br style="box-sizing: border-box;" /><i style="box-sizing: border-box; line-height: inherit;">Примечание: Если поставить нуль, то вдобавок отвалится функция обнаружения конфликтов DHCP, но это будет в другой истории.</i></div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Cisco ARP Optimization Feature – что это?</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Это достаточно полезное архитектурное изменение, появившееся в релизах IOS 12.0 – 12.2 и закрепившееся в более поздних. Идея проста. Устройство хранит информацию о связках IP-MAC-интерфейс в отдельной таблице. Эта таблица организована для быстрого поиска информации по известному IP-адресу. Соответственно, этот механизм эффективен, когда надо обработать единичный пакет. В ситуации же, когда интерфейс попеременно переходит из состояния включения в выключенное и наоборот (interface flapping), надо сразу же обработать в этой таблице все ARP-записи, относящиеся ко всем IP и MAC, находящимся за данным интерфейсом. Вот фича Cisco ARP Optimization как раз умеет делать эту операцию – например, очистить все записи за соответствующий интерфейс. Выигрыш – резко сниженная загрузка CPU, которому надо обработать событие “падение интерфейса”.</div><h3 style="box-sizing: border-box; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 27px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Как настроить Cisco ARP Optimization Feature</h3><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Никак – это просто другая структура хранения данных ARP в оперативной памяти, используемая в современных версиях IOS.</div><h2 style="box-sizing: border-box; color: #2ba6cb; font-family: wf_SegoeUILight, &quot;Segoe UI Light&quot;, &quot;Segoe WP Light&quot;, Tahoma, Arial, Verdana, sans-serif; font-size: 37px; font-weight: 300; line-height: 1.1; margin: 14px 0px; padding: 0px; text-rendering: optimizeLegibility;">Заключение</h2><div style="box-sizing: border-box; font-family: wf_SegoeUI, &quot;Segoe UI&quot;; line-height: 1.4; margin-top: 12px; overflow: auto; padding: 0px;">Если я вспомню ещё что-то, или меня наведут на мысль, то обязательно напишу сюда в качестве дополнения к статье.</div></div></div>
