+++
title = "Объединение одинаковых подсетей в RouterOS"
date = 2015-03-10T23:59:00Z
updated = 2015-03-10T23:59:38Z
tags = ["пересекающиеся адреса", "routeros", "двойной NAT", "NAT", "Mikrotik", "Virtual Address Mapping"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Имеем две сети с одинаковой адресацией и site-to-site VPN между ними. Необходимо обеспечить взаимодействие между сетями, не изменяя их внутренней адресации. Не спрашивайте почему нельзя сменить адресацию - просто нельзя. В обеих точках оборудование Mikrotik.<br /><br /><a name='more'></a>Решение подсказала эта <a href="http://habrahabr.ru/post/117320/">статья</a>. Вся основная настройка будет проводиться только на роутере-клиенте. На втором роутере необходимо будет лишь прописать маршрут до фэйковой сети. Будем считать, что VPN уже функционирует. Я не буду расписывать детали прохождения пакетов, т.к. это описано в указанной статье. Просто <span style="color: #666666; font-family: Courier New, Courier, monospace;">код с хабра</span> и как <span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">это делается в RouterOS</span>.<br /><br />Итак, наша сеть - 192.168.0.0/16. Сеть, в которую нужно попасть - 192.168.15.0/24. Отличия моих адресов от хабра:<br />1. там с обеих сторон 192.168.0.0/24. У меня 192.168.0.0/16 и 192.168.15.0/24<br />2. там фэйковые адреса 10.8.1.0/24, 10.8.2.0/24. У меня 10.9.0.0/16 и 172.25.25.0/24<br /><br /><span style="color: #444444; font-family: Courier New, Courier, monospace;">iptables -t mangle -A PREROUTING -i tun0 -d 10.8.1.0/24 -j MARK --set-mark 8</span><br /><br /><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">chain=prerouting action=mark-connection new-connection-mark=in passthrough=yes dst-address=172.25.25.0/24 in-interface=vpn</span><br /><br /><span style="background-color: #cccccc; font-family: 'Courier New', Courier, monospace;">chain=output action=mark-routing new-routing-mark=in passthrough=yes connection-mark=in&nbsp;</span><br /><br /><span style="background-color: #f7f7f9; line-height: 22.3999996185303px; white-space: pre-wrap;"><span style="color: #666666; font-family: Courier New, Courier, monospace;">iptables -t nat -A PREROUTING -m mark --mark 8 -j NETMAP --to 192.168.0.0/24</span></span><br /><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">chain=dstnat action=netmap to-addresses=192.168.15.0/24 connection-mark=in</span><br /><br /><span style="background-color: #f7f7f9; line-height: 22.3999996185303px; white-space: pre-wrap;"><span style="color: #666666; font-family: Courier New, Courier, monospace;">iptables -t nat -A POSTROUTING -m mark --mark 8 -j NETMAP --to 10.8.2.0/24</span></span><br /><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">chain=srcnat action=netmap to-addresses=10.9.0.0/16 connection-mark=in</span><br /><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;"><br /></span><span style="background-color: #f7f7f9; line-height: 22.3999996185303px; white-space: pre-wrap;"><span style="color: #666666; font-family: Courier New, Courier, monospace;">ip route add 192.168.0.0/24 dev eth1 table netmap</span></span><br /><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">dst-address=192.168.15.0/24 gateway=ether2-master-local routing-mark=in</span><br /><br /><br /><br />Ну и приведу всю конфигурацию Mangle, NAT и Route.<br /><br />/ip firewall mangle&gt; print<br />Flags: X - disabled, I - invalid, D - dynamic<br />&nbsp;0 &nbsp; chain=prerouting action=mark-connection new-connection-mark=in passthrough=yes<br />&nbsp; &nbsp; &nbsp;dst-address=172.25.25.0/24 in-interface=vpn<br /><br />&nbsp;1 &nbsp; chain=output action=mark-routing new-routing-mark=in passthrough=yes<br />&nbsp; &nbsp; &nbsp;connection-mark=in<br /><br />&nbsp;2 &nbsp; chain=prerouting action=mark-connection new-connection-mark=out passthrough=yes<br />&nbsp; &nbsp; &nbsp;dst-address=10.9.0.0/16 in-interface=ether2-master-local<br /><br />&nbsp;3 &nbsp; chain=output action=mark-routing new-routing-mark=out passthrough=yes<br />&nbsp; &nbsp; &nbsp;connection-mark=out<br /><div><br /></div><div><br /></div><div><br /></div><div><div>/ip firewall nat&gt; print&nbsp;</div><div>Flags: X - disabled, I - invalid, D - dynamic&nbsp;</div><div>&nbsp;0 &nbsp; ;;; default configuration</div><div>&nbsp; &nbsp; &nbsp;chain=srcnat action=masquerade out-interface=ether1-gateway&nbsp;</div><div><br /></div><div>&nbsp;1 &nbsp; chain=dstnat action=netmap to-addresses=192.168.15.0/24 connection-mark=in&nbsp;</div><div><br /></div><div>&nbsp;2 &nbsp; chain=srcnat action=netmap to-addresses=10.9.0.0/16 connection-mark=in&nbsp;</div><div><br /></div><div>&nbsp;3 &nbsp; chain=dstnat action=netmap to-addresses=192.168.15.0/24 routing-mark=out&nbsp;</div><div><br /></div><div>&nbsp;4 &nbsp; chain=srcnat action=netmap to-addresses=172.25.25.0/24 routing-mark=out&nbsp;</div></div><div><br /></div><div><br /></div><div><br /></div><div><div>&nbsp;/ip&gt; route print detail&nbsp;</div><div>Flags: X - disabled, A - active, D - dynamic,&nbsp;</div><div>C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme,&nbsp;</div><div>B - blackhole, U - unreachable, P - prohibit&nbsp;</div><div>&nbsp;0 A S &nbsp;dst-address=192.168.15.0/24 gateway=ether2-master-local&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; gateway-status=ether2-master-local reachable distance=1 scope=30&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; target-scope=10 routing-mark=in&nbsp;</div><div><br /></div><div>&nbsp;1 A S &nbsp;dst-address=192.168.0.0/16 gateway=vpn&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; gateway-status=vpn reachable distance=1 scope=30 target-scope=10&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; routing-mark=out&nbsp;</div><div><br /></div><div><div>&nbsp;4 A S &nbsp;dst-address=192.168.0.0/16 gateway=%vpn_serv_IP%&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; gateway-status=192.168.242.1 reachable via &nbsp;vpn distance=1 scope=30&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; target-scope=10</div></div></div><div><br /></div>
