+++
title = "MiTM атака на RDP с SSL"
date = 2014-03-05T18:44:00Z
updated = 2014-03-05T18:44:46Z
tags = ["security", "RDP", "MS", "MiTM", "SSL"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

https://labs.portcullis.co.uk/blog/ssl-man-in-the-middle-attacks-on-rdp/<br /><br />Копипаста:<br /><br />This post seeks to demonstrate why users learning to ignore those  certificate warnings for SSL-based RDP connection could leave them open  to Man-in-the-middle (MiTM) attacks. The MiTM attack demonstrated  displays keystrokes sent during an RDP session. We conclude with some  advice on how to avoid being the victim of such an attack.<br /><br /><a name='more'></a><br /><span id="more-1510"></span><br /> <h2>Types of RDP connections</h2>Before we start, let’s first clarify which of the various RDP  connection types this post is about. There are 3 types of connection:<br /> <ul><li>RDP Security Layer</li><li>SSL (TLS 1.0)</li><li>CredSSP (SSL with NLA)</li></ul>It’s the middle one we’ll demonstrate an attack on in this post. On  the Terminal Server, SSL is configured like this (with any NLA  checkboxes unticked):<br /> <div class="wp-caption alignnone" id="attachment_1492" style="width: 310px;"><a href="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/2003-rdp-setting-not-vulnerable.png"><img alt="2003-rdp-setting-not-vulnerable" class="size-medium wp-image-1492" height="233" src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/2003-rdp-setting-not-vulnerable-300x233.png" width="300" /></a><div class="wp-caption-text">RDP configuration used</div></div>Some connections may also be vulnerable if the server is set to  “Negotiate” its Security Layer to – as that could result in SSL being  used.<br /> <h2>SSL certificate warning</h2>If users are used to dismissing a warnings like this one each time they connect, then this post is relevant to them:<br /> <div class="wp-caption alignnone" id="attachment_1496" style="width: 267px;"><a href="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/ssl-warning.png"><img alt="ssl-warning" class="size-medium wp-image-1496" height="300" src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/ssl-warning-257x300.png" width="257" /></a><div class="wp-caption-text">SSL warning that should not be routinely ignored</div></div><h2>Attack overview</h2>At a high level, the attack will proceed in a similar way to any SSL MiTM attack:<br /> <ol><li>Have the victim connect to a PoC tool (rdp-ssl-mitm.py) on our system instead of the RDP server they’re trying to reach</li><li>Using the RDP protocol, our tool will negotiate the use of SSL</li><li>At the point the connection is upgraded to SSL, our tool will  negotiate an SSL connection with the RDP client using its own  (untrusted) SSL certificate. This will give our tool access to data sent  by the RDP client in cleartext</li><li>Our tool also needs to create an SSL connection with the legitimate RDP server down which it will send data from the RDP client</li></ol>The only complication to this attack is that our tool has to talk the  RDP protocol briefly before creating the required SSL connections.<br /> <h3>1. Having the victim connect to us</h3>In a real attack, we’d need to have the RDP client connect to our  system instead of the target server. This could be achieved using ARP  spoofing, DNS spoofing or some other method. Rather than cloud the  demonstration with such details, we’ll assume this is step is possible  and just type the IP address of the attacker system into the victim RDP  client.<br /> On our attacker system (192.168.190.170), we start our PoC tool. We  tell it forward connections to the legitimate RDP server 192.168.2.96:<br /> <pre class="brush: bash; gutter: false; title: ; notranslate" title="">$ ./rdp-ssl-mitm.py -r 192.168.2.96:3389<br />[+] Listening for connections on 0.0.0.0:3389<br /></pre>And we simply enter the IP address of the attacker system into the RDP client (the client connects from 192.168.190.1):<br /> <div class="wp-caption alignnone" id="attachment_1495" style="width: 310px;"><a href="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/rdp-attack-prior-to-logon.jpg"><img alt="rdp-attack-prior-to-logon" class="size-medium wp-image-1495" height="177" src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/rdp-attack-prior-to-logon-300x177.jpg" width="300" /></a><div class="wp-caption-text">We enter the attacker IP address to avoid the complexity of ARP spoofing</div></div><h3>2. Talk RDP to the client to negotiate the use of SSL</h3>The negotiation of SSL is quite short within the RDP protocol:<br /> Message #1: Client &gt; MiTM &gt; Server<br /> <pre class="brush: plain; gutter: false; highlight: [1]; title: ; notranslate" title="">03 00 00 13 0e e0 00 00 00 00 00 01 00 08 00 *03*<br />00 00 00<br /></pre>This message is fairly static and our tool just passes it through to  the server unaltered. The *03*&nbsp;means that the client supports RDP  Security Layer, SSL and CredSSP.<br /> Message #2: Server &gt; MiTM &gt; Client<br /> <pre class="brush: plain; gutter: false; highlight: [1]; title: ; notranslate" title="">03 00 00 13 0e d0 00 00 12 34 00 02 00 08 00 *01*<br />00 00 00<br /></pre>In the next message the server chooses the protocol to use. The  *01*&nbsp;in this case means the the server has chosen SSL (not CredSSP which  would be&nbsp;*02*). Again, we pass this message back to the client  unaltered.<br /> Note that if the server were to select CredSSP (*02*), then the demonstration would fail. We’re attacking SSL, not CredSSP.<br /> <h3>3. Create SSL connection with RDP client</h3>Message #3: Client &gt; MiTM<br /> The 3rd message is the start of an SSL connection.&nbsp;Here is the SSL  Client Hello message beginning *16 03 01*… (03 01 being the version of  SSL used: SSL 3.1 AKA TLS 1.0).<br /> <pre class="brush: plain; gutter: false; highlight: [1]; title: ; notranslate" title="">*16 03 01* 00 5a 01 00 00 56 03 01 52 21 ac be 63<br />20 ce de 4b a5 90 18 f0 66 97 ee 9d 54 14 e3 1c<br />... snip ...<br /></pre>Our tool does not forward this data directly to the server. Instead  it responds with and SS Server Hello message and proceeds to complete  the SSL connection with the client.<br /> The SSL certificate we present to the RDP client is issued to fred  and this is displayed in the mstsc SSL warning shown to the user:<br /> <div class="wp-caption alignnone" id="attachment_1517" style="width: 265px;"><a href="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/fred.jpg"><img alt="fred" class="size-medium wp-image-1517" height="300" src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/fred-255x300.jpg" width="255" /></a><div class="wp-caption-text">The certificate presented by our PoC tool causes this security warning</div></div>The details of the SSL certificate differ to those the user would  normally see – if the user were to check. To refine the attack we could  make the certificate details match more closely, but we’d never get the  signature to be the same as the normal certificate, so there’d always be  a difference.<br /> <h3>4. Create SSL connection with RDP server</h3>Simultaneously, our tool also sends and SSL Client Hello to the RDP server and creates a second SSL connection.<br /> <h2>Displaying key strokes</h2>Our tool is now in a position to display the cleartext messages about  keystrokes (for example) sent by the RDP client. It is relatively easy  to determine what sort of message is sent when a key is pressed. The  following two 4-byte messages are sent when the ‘p’ key is pressed:<br /> <pre class="brush: plain; gutter: false; title: ; notranslate" title="">44 04 00 19<br />44 04 01 19<br /></pre>The 3rd byte is the direction of key (00 means key-down, 01 means key-up). &nbsp;The 4th byte is the key scan code. &nbsp;If we <a href="http://msdn.microsoft.com/en-us/library/aa299374%28v=vs.60%29.aspx" title="look up">look up</a>&nbsp;0×19 we find it corresponds to the p key.<br /> In the general case, the scan-code to character mapping depends which  keyboard you’re using. In the PoC tool I implemented the mapping for  for QWERTY keyboards, so if you have a UK/US keyboard, it should  translate the majority of scan-codes to the correct characters. Note  that we don’t get know whether characters are uppercase or lowercase.  We’d have to manually track the status of CAPS Lock and SHIFT keys.<br /> Without getting too bogged down in the details, here’s some sample  output from the PoC tool that shows keystrokes being logged – in  particular an administrator logging in with username Administrator,  password Password:<br /> <pre class="brush: bash; gutter: false; title: ; notranslate" title="">$ ./rdp-ssl-mitm.py -r 192.168.2.96:3389 <br />[+] Listening for connections on 0.0.0.0:3389<br />[+] Incoming connection from 192.168.190.1:60370<br />[+] New outgoing request to 192.168.2.96:3389 (SSL: 0)<br />[+] Connected<br />[+] Detected incoming SSL connection. Turning self into SSL socket<br />[+] Incoming connection from 192.168.190.1:60374<br />[+] New outgoing request to 192.168.2.96:3389 (SSL: 0)<br />[+] Connected<br />[+] Detected incoming SSL connection. Turning self into SSL socket<br />&lt;LShift-down&gt;A&lt;LShift-up&gt;DMINISTRATOR&lt;Tab&gt;&lt;LShift-down&gt;P&lt;LShift-up&gt;ASSWORD&lt;Enter&gt;<br /></pre><h2>Conclusions</h2>Learning to ignore SSL certificate warnings is as bad for RDP  connection as it is for HTTPS websites. The results are similar: users  quickly become vulnerable to Man-in-the-middle attacks. Such attacks can  harvest usernames, passwords, keystrokes and other sensitive data.<br /> Using SSL certificates that are signed by a Certificate Authority the  RDP client trusts will result in no warning under normal operation, so  is highly recommended.<br /> This attack doesn’t work if the server mandates NLA, so using NLA is also highly recommended.<br /> It’s important to note that this isn’t a vulnerability in the RDP  Client or Server software. &nbsp;Nor is this a &nbsp;new discovery. &nbsp;It’s a  weakness in way RDP is sometimes used which stems from users ignoring  security warnings. &nbsp;At a technical level, this is a fairly vanilla SSL  MiTM attack.<br /> It might be interesting to extend this work by recording screen  captures; or by injecting images of login boxes to encourage users to  part of with other credentials. There would also be an opportunity to  attack any drives that the RDP client has mapped for drive redirection –  see <a href="http://tombstone-bbs.co.uk/reverse-rdp/reverse-rdp.html" title="Attacking the RDP client">Attacking the RDP Clients</a> for inspiration. These would be&nbsp;pretty demanding coding challenges, though!
