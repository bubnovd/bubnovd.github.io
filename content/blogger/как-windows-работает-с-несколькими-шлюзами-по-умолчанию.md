+++
title = "Как Windows работает с несколькими шлюзами по умолчанию"
date = 2015-07-20T23:56:00Z
updated = 2015-07-20T23:59:04Z
tags = ["windows", "failover"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Для обеспечения отказоустойчивости сетей применяется практика использования нескольких шлюзов по умолчанию. В таком случае при доступности одного из шлюзов, трафик будет идти через него (шлюзы не эквивалентны, постоянно активен только один). При отказе этого шлюза, трафик пойдет через второй шлюз. С соединениями по TCP проблем это не создаст. Единственное, TCP коннект должен будет пересоединиться по новому маршруту после завершения таймаута соединения. С трафиком же UDP могут возникнуть проблемы при переключении шлюза - телефония начнет заикаться, видео будет пропадать. Но по прошествии какого-то времени проблема исчезнет. А как Windows определяет доступность шлюза? Об этом ниже.<br /><br /><a name='more'></a><br /><br />Когда TCP-соединение маршрутизируется через основной шлюз, хост пытается отправить пакет к получателю столько раз, сколько указано в ключе реестра&nbsp;<span style="background-color: white; font-family: 'Segoe UI', 'Segoe UI Web', 'Segoe UI Symbol', 'Helvetica Neue', 'BBAlpha Sans', 'S60 Sans', Arial, sans-serif; font-size: 15px; line-height: 20px;">TcpMaxDataRetransmissions, </span><span style="background-color: white; line-height: 20px;"><span style="font-family: inherit;">деленное пополам. И если ответ от получателя за это количество попыток ни разу не пришел, то алгоритм меняет&nbsp;</span></span><span style="background-color: white; font-family: 'Segoe UI', 'Segoe UI Web', 'Segoe UI Symbol', 'Helvetica Neue', 'BBAlpha Sans', 'S60 Sans', Arial, sans-serif; font-size: 15px; line-height: 20px;">Route Cache Entry (RCE)</span><span style="font-family: inherit;"><span style="background-color: white; line-height: 20px;"> </span><span style="background-color: white; line-height: 20px;">(кэш маршрутов). Наше соединение (отправившее TcpMaxDataRetransmissions/2 пакетов и не получившее ни одного ответа) переключается на шлюз, указанный вторым в настройках адаптера. Когда 25% TCP-соединений переключатся на второй шлюз, он становится шлюзом по умолчанию. Новый шлюз по умолчанию будет использоваться до возникновения аналогичных проблем с ним, либо до перезагрузки системы.</span></span><br /><span style="font-family: inherit;"><span style="background-color: white; line-height: 20px;"><br /></span></span><span style="font-family: inherit;"><span style="background-color: white; line-height: 20px;">Вольный перевод <a href="https://support.microsoft.com/en-us/kb/171564" target="_blank">KB</a></span></span><span style="line-height: 20px;"><a href="https://support.microsoft.com/en-us/kb/171564" target="_blank">171564</a></span>
