+++
title = "[Мониторинг] Prometheus + Grafana. Часть 1. Общая информация"
date = 2018-05-27T11:06:00Z
updated = 2018-05-30T02:46:22Z
tags = ["prometheus", "grafana", "monitoring", "snmp_exporter"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Система мониторинга - неотъемлемая часть ИТ инфраструктуры. Сеть не исключение. Для мониторинга сети уже написано много различных систем на разные вкусы:<br /><br /><ul><li><a href="http://www.bubnovd.net/2017/05/thedudenetwork-managementandmonitoring.html" target="_blank">The Dude</a>. Простая и быстрая в настройке и освоении система мониторинга от Mikrotik. Идеально подходит для небольших сетей или в случае, когда мониторинг нужен "вчера"</li></ul><ul><li><a href="https://www.zabbix.com/ru/" target="_blank">Zabbix</a>. Монструозный гигант. Долгое время стандарт де факто в мониторинге (да и сейчас, пожалуй). Умеет, не побоюсь этого слова, всё.&nbsp;</li></ul><ul><li><a href="http://www.bubnovd.net/2014/03/cacti-mikrotik-full-monitoring.html" target="_blank">Cacti</a>. Легковесная мониторилка на основе RRDTool</li></ul><ul><li><a href="https://oss.oetiker.ch/mrtg/" target="_blank">MRTG</a>, <a href="https://www.ru.paessler.com/prtg" target="_blank">PRTG </a>и <a href="https://www.nagios.org/" target="_blank">куча </a>других <a href="https://www.icinga.com/" target="_blank">систем</a></li></ul><div><br /></div><div>С распространением микросервисов функциональности и производительности существующих систем мониторинга стало не хватать и, что ожидаемо, начали разрабатываться и внедряться новые системы. В очередном моём проекте как раз понадобилась система мониторинга. И чтобы не отставать от цивилизованного мира, я решил попробовать что-то новое. Выбор пал на стек Prometheus + Grafana. Чтобы как-то увлечь Вас, предлагаю посмотреть на демо интерфейс по <a href="https://play.grafana.org/d/000000003/big-dashboard?orgId=1" target="_blank">ссылке</a>.</div><div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-LyDAjmqZx7g/Wwrve4VCaXI/AAAAAAAAFP0/eicg99-DMPs07f5vrO_BbVTVzWEFRp_ZwCLcBGAs/s1600/grafana.PNG" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="610" data-original-width="1264" height="307" src="https://3.bp.blogspot.com/-LyDAjmqZx7g/Wwrve4VCaXI/AAAAAAAAFP0/eicg99-DMPs07f5vrO_BbVTVzWEFRp_ZwCLcBGAs/s640/grafana.PNG" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Grafana</td></tr></tbody></table><br /><a name='more'></a><br /></div><div><br /></div><div>Давайте рассмотрим что же из себя представляет этот стек.</div><div><br /></div><div>В современной разработке принято разделять продукт на несколько разных по назначению частей. Так система получается более масштабируемой и универсальной. Вот и здесь система мониторинга состоит из нескольких частей:</div><div><br /></div><div><img alt="@prometheus" src="https://avatars1.githubusercontent.com/u/3380462?s=200&amp;v=4" /><b><a href="https://github.com/prometheus/prometheus" target="_blank"><span style="font-size: large;">Prometheus</span></a></b></div><div><br /></div><div>Как написано по ссылке, это система мониторинга и time-series database. Prometheus принимает метрики из разных источников (exporters), записывает их в базу и предоставляет интерфейс для построения графиков и различных выборок.<br /><br /><br /><br /><br /></div><div><br /></div><div><img alt="Grafana Icon" height="200" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIwLjEuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHdpZHRoPSIzNTFweCIgaGVpZ2h0PSIzNjVweCIgdmlld0JveD0iMCAwIDM1MSAzNjUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDM1MSAzNjUiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8ZyBpZD0iTGF5ZXJfMV8xXyI+CjwvZz4KPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8xXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxNzAuOTE4MSIgeTE9IjQzOS40ODEiIHgyPSIxNzAuOTE4MSIgeTI9IjEwNi42NzQ5Ij4KCTxzdG9wICBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiNGRkYxMDAiLz4KCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiNGMDVBMjgiLz4KPC9saW5lYXJHcmFkaWVudD4KPHBhdGggZmlsbD0idXJsKCNTVkdJRF8xXykiIGQ9Ik0zMzcuNSwxNjEuMWMtMC42LTYuMS0xLjYtMTMuMS0zLjYtMjAuOWMtMi03LjctNS0xNi4yLTkuNC0yNWMtNC40LTguOC0xMC4xLTE3LjktMTcuNS0yNi44CgljLTIuOS0zLjUtNi4xLTYuOS05LjUtMTAuMmM1LjEtMjAuMy02LjItMzcuOS02LjItMzcuOWMtMTkuNS0xLjItMzEuOSw2LjEtMzYuNSw5LjRjLTAuOC0wLjMtMS41LTAuNy0yLjMtMQoJYy0zLjMtMS4zLTYuNy0yLjYtMTAuMy0zLjdjLTMuNS0xLjEtNy4xLTIuMS0xMC44LTNjLTMuNy0wLjktNy40LTEuNi0xMS4yLTIuMmMtMC43LTAuMS0xLjMtMC4yLTItMC4zQzIwOS42LDEyLjQsMTg1LjEsMSwxODUuMSwxCgljLTI3LjMsMTcuMy0zMi40LDQxLjUtMzIuNCw0MS41cy0wLjEsMC41LTAuMywxLjRjLTEuNSwwLjQtMywwLjktNC41LDEuM2MtMi4xLDAuNi00LjIsMS40LTYuMiwyLjJjLTIuMSwwLjgtNC4xLDEuNi02LjIsMi41CgljLTQuMSwxLjgtOC4yLDMuOC0xMi4yLDZjLTMuOSwyLjItNy43LDQuNi0xMS40LDcuMWMtMC41LTAuMi0xLTAuNC0xLTAuNGMtMzcuOC0xNC40LTcxLjMsMi45LTcxLjMsMi45CgljLTMuMSw0MC4yLDE1LjEsNjUuNSwxOC43LDcwLjFjLTAuOSwyLjUtMS43LDUtMi41LDcuNWMtMi44LDkuMS00LjksMTguNC02LjIsMjguMWMtMC4yLDEuNC0wLjQsMi44LTAuNSw0LjIKCWMtMzQuOSwxNy4yLTQ1LjIsNTIuNS00NS4yLDUyLjVDMzMsMjYxLjQsNjcsMjYzLjUsNjcsMjYzLjVjMCwwLDAuMS0wLjEsMC4xLTAuMWM0LjMsNy43LDkuMywxNSwxNC45LDIxLjljMi40LDIuOSw0LjgsNS42LDcuNCw4LjMKCWMtMTAuNiwzMC40LDEuNSw1NS42LDEuNSw1NS42YzMyLjQsMS4yLDUzLjctMTQuMiw1OC4yLTE3LjdjMy4yLDEuMSw2LjUsMi4xLDkuOCwyLjljMTAsMi42LDIwLjIsNC4xLDMwLjQsNC41CgljMi41LDAuMSw1LjEsMC4yLDcuNiwwLjFsMS4yLDBsMC44LDBsMS42LDBsMS42LTAuMWMwLDAsMCwwLjEsMCwwLjFjMTUuMywyMS44LDQyLjEsMjQuOSw0Mi4xLDI0LjljMjEuNi0yMi44LDIwLjItNDUuMywyMC4yLTQ1LjMKCWMtMC4yLTAuMi0wLjQtMC4zLTAuNi0wLjVjNC4yLTIuOSw4LjItNi4xLDEyLTkuNWM3LjYtNi45LDE0LjMtMTQuOCwxOS45LTIzLjNjMC41LTAuOCwxLTEuNiwxLjUtMi40YzIxLjYsMS4yLDM2LjktMTMuNCwzNi45LTEzLjQKCWMtNC0yNS4yLTE5LjYtMzYtMTkuNi0zNmMtMC4yLDAtMC4zLDAuMS0wLjUsMC4xYzAuMi0xLjUsMC4zLTMsMC40LTQuNWMwLjItMi40LDAuMi00LjksMC4yLTcuM2wwLTEuOGwwLTAuOWwwLTAuNQoJYzAtMC42LDAtMC40LDAtMC42bC0wLjEtMS41bC0wLjEtMmMwLTAuNy0wLjEtMS4zLTAuMi0xLjljLTAuMS0wLjYtMC4xLTEuMy0wLjItMS45bC0wLjItMS45bC0wLjMtMS45Yy0wLjQtMi41LTAuOC00LjktMS40LTcuNAoJYy0yLjMtOS43LTYuMS0xOC45LTExLTI3LjJjLTUtOC4zLTExLjItMTUuNi0xOC4zLTIxLjhjLTctNi4yLTE0LjktMTEuMi0yMy4xLTE0LjljLTguMy0zLjctMTYuOS02LjEtMjUuNS03LjIKCWMtNC4zLTAuNi04LjYtMC44LTEyLjktMC43bC0xLjYsMGwtMC40LDBjLTAuMSwwLTAuNiwwLTAuNSwwbC0wLjcsMGwtMS42LDAuMWMtMC42LDAtMS4yLDAuMS0xLjcsMC4xYy0yLjIsMC4yLTQuNCwwLjUtNi41LDAuOQoJYy04LjYsMS42LTE2LjcsNC43LTIzLjgsOWMtNy4xLDQuMy0xMy4zLDkuNi0xOC4zLDE1LjZjLTUsNi04LjksMTIuNy0xMS42LDE5LjZjLTIuNyw2LjktNC4yLDE0LjEtNC42LDIxYy0wLjEsMS43LTAuMSwzLjUtMC4xLDUuMgoJYzAsMC40LDAsMC45LDAsMS4zbDAuMSwxLjRjMC4xLDAuOCwwLjEsMS43LDAuMiwyLjVjMC4zLDMuNSwxLDYuOSwxLjksMTAuMWMxLjksNi41LDQuOSwxMi40LDguNiwxNy40YzMuNyw1LDguMiw5LjEsMTIuOSwxMi40CgljNC43LDMuMiw5LjgsNS41LDE0LjgsN2M1LDEuNSwxMCwyLjEsMTQuNywyLjFjMC42LDAsMS4yLDAsMS43LDBjMC4zLDAsMC42LDAsMC45LDBjMC4zLDAsMC42LDAsMC45LTAuMWMwLjUsMCwxLTAuMSwxLjUtMC4xCgljMC4xLDAsMC4zLDAsMC40LTAuMWwwLjUtMC4xYzAuMywwLDAuNi0wLjEsMC45LTAuMWMwLjYtMC4xLDEuMS0wLjIsMS43LTAuM2MwLjYtMC4xLDEuMS0wLjIsMS42LTAuNGMxLjEtMC4yLDIuMS0wLjYsMy4xLTAuOQoJYzItMC43LDQtMS41LDUuNy0yLjRjMS44LTAuOSwzLjQtMiw1LTNjMC40LTAuMywwLjktMC42LDEuMy0xYzEuNi0xLjMsMS45LTMuNywwLjYtNS4zYy0xLjEtMS40LTMuMS0xLjgtNC43LTAuOQoJYy0wLjQsMC4yLTAuOCwwLjQtMS4yLDAuNmMtMS40LDAuNy0yLjgsMS4zLTQuMywxLjhjLTEuNSwwLjUtMy4xLDAuOS00LjcsMS4yYy0wLjgsMC4xLTEuNiwwLjItMi41LDAuM2MtMC40LDAtMC44LDAuMS0xLjMsMC4xCgljLTAuNCwwLTAuOSwwLTEuMiwwYy0wLjQsMC0wLjgsMC0xLjIsMGMtMC41LDAtMSwwLTEuNS0wLjFjMCwwLTAuMywwLTAuMSwwbC0wLjIsMGwtMC4zLDBjLTAuMiwwLTAuNSwwLTAuNy0wLjEKCWMtMC41LTAuMS0wLjktMC4xLTEuNC0wLjJjLTMuNy0wLjUtNy40LTEuNi0xMC45LTMuMmMtMy42LTEuNi03LTMuOC0xMC4xLTYuNmMtMy4xLTIuOC01LjgtNi4xLTcuOS05LjljLTIuMS0zLjgtMy42LTgtNC4zLTEyLjQKCWMtMC4zLTIuMi0wLjUtNC41LTAuNC02LjdjMC0wLjYsMC4xLTEuMiwwLjEtMS44YzAsMC4yLDAtMC4xLDAtMC4xbDAtMC4ybDAtMC41YzAtMC4zLDAuMS0wLjYsMC4xLTAuOWMwLjEtMS4yLDAuMy0yLjQsMC41LTMuNgoJYzEuNy05LjYsNi41LTE5LDEzLjktMjYuMWMxLjktMS44LDMuOS0zLjQsNi00LjljMi4xLTEuNSw0LjQtMi44LDYuOC0zLjljMi40LTEuMSw0LjgtMiw3LjQtMi43YzIuNS0wLjcsNS4xLTEuMSw3LjgtMS40CgljMS4zLTAuMSwyLjYtMC4yLDQtMC4yYzAuNCwwLDAuNiwwLDAuOSwwbDEuMSwwbDAuNywwYzAuMywwLDAsMCwwLjEsMGwwLjMsMGwxLjEsMC4xYzIuOSwwLjIsNS43LDAuNiw4LjUsMS4zCgljNS42LDEuMiwxMS4xLDMuMywxNi4yLDYuMWMxMC4yLDUuNywxOC45LDE0LjUsMjQuMiwyNS4xYzIuNyw1LjMsNC42LDExLDUuNSwxNi45YzAuMiwxLjUsMC40LDMsMC41LDQuNWwwLjEsMS4xbDAuMSwxLjEKCWMwLDAuNCwwLDAuOCwwLDEuMWMwLDAuNCwwLDAuOCwwLDEuMWwwLDFsMCwxLjFjMCwwLjctMC4xLDEuOS0wLjEsMi42Yy0wLjEsMS42LTAuMywzLjMtMC41LDQuOWMtMC4yLDEuNi0wLjUsMy4yLTAuOCw0LjgKCWMtMC4zLDEuNi0wLjcsMy4yLTEuMSw0LjdjLTAuOCwzLjEtMS44LDYuMi0zLDkuM2MtMi40LDYtNS42LDExLjgtOS40LDE3LjFjLTcuNywxMC42LTE4LjIsMTkuMi0zMC4yLDI0LjcKCWMtNiwyLjctMTIuMyw0LjctMTguOCw1LjdjLTMuMiwwLjYtNi41LDAuOS05LjgsMWwtMC42LDBsLTAuNSwwbC0xLjEsMGwtMS42LDBsLTAuOCwwYzAuNCwwLTAuMSwwLTAuMSwwbC0wLjMsMAoJYy0xLjgsMC0zLjUtMC4xLTUuMy0wLjNjLTctMC41LTEzLjktMS44LTIwLjctMy43Yy02LjctMS45LTEzLjItNC42LTE5LjQtNy44Yy0xMi4zLTYuNi0yMy40LTE1LjYtMzItMjYuNQoJYy00LjMtNS40LTguMS0xMS4zLTExLjItMTcuNGMtMy4xLTYuMS01LjYtMTIuNi03LjQtMTkuMWMtMS44LTYuNi0yLjktMTMuMy0zLjQtMjAuMWwtMC4xLTEuM2wwLTAuM2wwLTAuM2wwLTAuNmwwLTEuMWwwLTAuM2wwLTAuNAoJbDAtMC44bDAtMS42bDAtMC4zYzAsMCwwLDAuMSwwLTAuMWwwLTAuNmMwLTAuOCwwLTEuNywwLTIuNWMwLjEtMy4zLDAuNC02LjgsMC44LTEwLjJjMC40LTMuNCwxLTYuOSwxLjctMTAuMwoJYzAuNy0zLjQsMS41LTYuOCwyLjUtMTAuMmMxLjktNi43LDQuMy0xMy4yLDcuMS0xOS4zYzUuNy0xMi4yLDEzLjEtMjMuMSwyMi0zMS44YzIuMi0yLjIsNC41LTQuMiw2LjktNi4yYzIuNC0xLjksNC45LTMuNyw3LjUtNS40CgljMi41LTEuNyw1LjItMy4yLDcuOS00LjZjMS4zLTAuNywyLjctMS40LDQuMS0yYzAuNy0wLjMsMS40LTAuNiwyLjEtMC45YzAuNy0wLjMsMS40LTAuNiwyLjEtMC45YzIuOC0xLjIsNS43LTIuMiw4LjctMy4xCgljMC43LTAuMiwxLjUtMC40LDIuMi0wLjdjMC43LTAuMiwxLjUtMC40LDIuMi0wLjZjMS41LTAuNCwzLTAuOCw0LjUtMS4xYzAuNy0wLjIsMS41LTAuMywyLjMtMC41YzAuOC0wLjIsMS41LTAuMywyLjMtMC41CgljMC44LTAuMSwxLjUtMC4zLDIuMy0wLjRsMS4xLTAuMmwxLjItMC4yYzAuOC0wLjEsMS41LTAuMiwyLjMtMC4zYzAuOS0wLjEsMS43LTAuMiwyLjYtMC4zYzAuNy0wLjEsMS45LTAuMiwyLjYtMC4zCgljMC41LTAuMSwxLjEtMC4xLDEuNi0wLjJsMS4xLTAuMWwwLjUtMC4xbDAuNiwwYzAuOS0wLjEsMS43LTAuMSwyLjYtMC4ybDEuMy0wLjFjMCwwLDAuNSwwLDAuMSwwbDAuMywwbDAuNiwwCgljMC43LDAsMS41LTAuMSwyLjItMC4xYzIuOS0wLjEsNS45LTAuMSw4LjgsMGM1LjgsMC4yLDExLjUsMC45LDE3LDEuOWMxMS4xLDIuMSwyMS41LDUuNiwzMSwxMC4zYzkuNSw0LjYsMTcuOSwxMC4zLDI1LjMsMTYuNQoJYzAuNSwwLjQsMC45LDAuOCwxLjQsMS4yYzAuNCwwLjQsMC45LDAuOCwxLjMsMS4yYzAuOSwwLjgsMS43LDEuNiwyLjYsMi40YzAuOSwwLjgsMS43LDEuNiwyLjUsMi40YzAuOCwwLjgsMS42LDEuNiwyLjQsMi41CgljMy4xLDMuMyw2LDYuNiw4LjYsMTBjNS4yLDYuNyw5LjQsMTMuNSwxMi43LDE5LjljMC4yLDAuNCwwLjQsMC44LDAuNiwxLjJjMC4yLDAuNCwwLjQsMC44LDAuNiwxLjJjMC40LDAuOCwwLjgsMS42LDEuMSwyLjQKCWMwLjQsMC44LDAuNywxLjUsMS4xLDIuM2MwLjMsMC44LDAuNywxLjUsMSwyLjNjMS4yLDMsMi40LDUuOSwzLjMsOC42YzEuNSw0LjQsMi42LDguMywzLjUsMTEuN2MwLjMsMS40LDEuNiwyLjMsMywyLjEKCWMxLjUtMC4xLDIuNi0xLjMsMi42LTIuOEMzMzgsMTcwLjMsMzM3LjksMTY2LDMzNy41LDE2MS4xeiIvPgo8L3N2Zz4K" width="192" />&nbsp;<b><a href="https://grafana.com/" target="_blank"><span style="font-size: large;">Grafana</span></a></b><br /><br />Если предыдущая часть собирает и хранит данные, то эта - отображает их в удобной для пользователя форме. Посмотрите ещё раз <a href="https://play.grafana.org/d/000000012/grafana-play-home?orgId=1" target="_blank">на интерфейс </a>- ну разве не волшебство?</div><div><br /><br /><br /><br /><br />Prometheus получает данные от экспортеров в виде простого текста. Вроде этого:<br /><br /><blockquote class="tr_bq" style="white-space: pre-wrap; word-wrap: break-word;"># HELP go_gc_duration_seconds A summary of the GC invocation durations.<br /># TYPE go_gc_duration_seconds summary<br />go_gc_duration_seconds{quantile="0"} 6.5914e-05<br />go_gc_duration_seconds{quantile="0.25"} 0.000120385<br />go_gc_duration_seconds{quantile="0.5"} 0.000150536<br />go_gc_duration_seconds{quantile="0.75"} 0.000208313<br />go_gc_duration_seconds{quantile="1"} 0.001072873<br />go_gc_duration_seconds_sum 0.333397658<br />go_gc_duration_seconds_count 1648<br /># HELP go_goroutines Number of goroutines that currently exist.<br /># TYPE go_goroutines gauge<br />go_goroutines 58</blockquote><br />Но эти данные ему ещё нужно доставить. Сами ведь они к нему не придут. Для этого существуют специальные модули, называемые exporters, которые позволяют отсылать данные Prometheus'у. Со списком можно ознакомиться <a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank">по ссылке</a>. Это что-то вроде Zabbix agent'ов. Есть экспортеры для Linux и Windows, MS SQL, MySQL, Nginx и других систем.<br /><br />Так как нас в первую очередь интересует сеть, то и экспортировать нам надо SNMP. В этом нам поможет <a href="https://github.com/prometheus/snmp_exporter" target="_blank">SNMP_exporter</a>.<br /><br />Таким образом, мы определились, что наш стек мониторинга будет работать на Prometheus, Grafana и snmp_exporter для Prometheus. Все эти модули можно менять на любые другие такого же назначения. Интерфейс Grafana можно заменить на Kibana (но не стоит этого делать - kibana совсем для других целей), а БД в виде Prometheus можно заменить на InfluxDB, Graphite или что-то ещё. Я выбрал именно Grafana + Prometheus + snmp_exporter за гибкий язык запросов prometheus&nbsp; и гибкость и красоту grafana.<br /><br />Чтобы ещё больше погрузиться в модные технологии, весь стек было решено поднимать в docker контейнерах. Вам совсем необязательно повторять этот трюк, но познакомиться с контейнерезацией в XXI веке тоже было бы неплохо.<br /><br /><br />На этом пока всё. В следующей части установим и настроим сборку метрик с помощью prometheus и snmp_exporter.</div>
