+++
title = "Скрипт. Заливка файлов на FTP"
date = 2011-08-15T20:41:00Z
updated = 2013-05-29T11:40:18Z
tags = ["bat", "Автоматизация", "cmd", "скрипт"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Этот скрипт был написан для предотвращения нежелательных последствий от BSOD. Скрипт просматривает папку с дампами BSOD. Если дампы есть (синий экран был), то создаёт на FTP-сервере папку с датой создания дампа в качестве имени, а внутри неё папку с именем сбойной машины. И уже в эту папку копирует дампы. Затем переименовывает дампы в *.dmp.old, чтобы на следующий день их не копировать. Если скрипт запущен впервые, он копирует дампы как положено (каждый на свою дату).<br /><br /><a name='more'></a>Краткое описание скрипта:<br /><br /><ol><li>Секция check. Проверяет, есть ли уже дампы. Если нет, скрипт заканчивает свою работу. Если да - переходит на следующую секцию.</li><li>Секция makeftpcommand. Создаёт файл с именем script, в который пишет команды для работы с FTP.</li><li>Секция makedirectory. Анализирует папку с дампами и записывает в script команду для создания папки на FTP-сервере с именем вида дата/имя_машины.</li><li>Секция copyfiles. Заливает дамп в нужную папку.</li><li>Секция rename. Переименовывает дамп в *.dmp.old, чтобы при следующем запуске не копировать уже скопированные файлы.</li><li>Оставшиеся строки закрывают файл script, выполняют его и удаляют.</li></ol><br /><br /><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@echo on</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@echo =======================================</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@echo Copying memory dumps on FTP-server</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@echo =======================================</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@echo Script started</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">set $SRC="%systemroot%\minidump\"</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">:check</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@echo Checking files</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@if exist $SRC\*.dmp goto makeftpcommand</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">:makeftpcommand</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">set addr=script</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">echo.open 127.0.0.1&gt;&gt; %ADDR%</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">echo.anonymous&gt;&gt; %ADDR%</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">echo.&gt;&gt; %ADDR%</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">echo.binary&gt;&gt; %ADDR%</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">:makedirectory</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@echo Making directories</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">for %%a in (%$SRC%) do (for /f "tokens=1" %%b in ("%%~ta") do (echo.mkdir \%%~b\%computername%&gt;&gt;%ADDR%))</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">:copyfiles</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">@echo Copying files</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">for %%a in (%$SRC%) do (for /f "tokens=1" %%b in ("%%~ta") do (echo.cd %%~b\%computername%&gt;&gt;%ADDR% &amp;&amp; echo.send %%a &gt;&gt;%ADDR% &amp;&amp; echo.cd ../..&gt;&gt;%ADDR%))</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">:rename</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">for /f "tokens=1" %%a in ('dir /b %$SRC%\*.*') do ren %$SRC%\%%a %%a.old</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">echo.bye&gt;&gt; %ADDR%</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">ftp.exe -s:%ADDR%&nbsp;</span><br /><span class="Apple-style-span" style="color: #0b5394; font-family: 'Courier New', Courier, monospace;">del /F /Q script</span>
