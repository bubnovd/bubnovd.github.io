+++
title = "Wi-Fi. Интересное. 1."
date = 2013-09-19T21:55:00Z
updated = 2013-09-19T21:55:49Z
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Попала в мои руки приличная сеть с кучей беспроводных устройств. Пришлось грызть гранит беспроводных соединений. Отсюда, репосты нужного и интересного с хабра. Копипаст, чтоб не потерять инфу.<br /><br /><h1 class="title">                <a href="http://habrahabr.ru/post/149447/"><span class="post_title">Wi-Fi: неочевидные нюансы (на примере домашней сети)</span></a>                                 </h1><div class="hubs">  <a name='more'></a><br /><span class="profiled_hub" title="Профильный хаб"></span></div>Сейчас многие покупают точки доступа 802.11n, но хороших скоростей  достичь удается не всем. В этом посте поговорим о не очень очевидных  мелких нюансах, которые могут ощутимо улучшить (или ухудшить) работу  Wi-Fi. Всё описанное ниже применимо как к домашним Wi-Fi-роутерам со  стандартными и продвинутыми (DD-WRT &amp; Co.) прошивками, так и к  корпоративным железкам и сетям. Поэтому, в качестве примера возьмем  «домашнюю» тему, как более родную и близкую к телу. Ибо даже самые  администые из админов и инженеристые из инженеров живут в  многоквартирных домах (или поселках с достаточной плотностью соседей), и  всем хочется быстрого и надежного Wi-Fi.<br /><b>[!!]:</b> <i>после замечаний касательно публикации <a href="http://habrahabr.ru/post/149418/">первой части</a> привожу текст целиком. Если вы читали первую часть — продолжайте <a href="http://habrahabr.ru/post/149447/#2">отсюда</a>.</i><br /><a href="https://www.blogger.com/null" name="habracut"></a><br />Несколько примечаний перед началом:<br /><ul><li>Стиль изложения нарочито упрощен, т.к. некоторые вещи вам, возможно,  придется объяснять соседям, совершенно незнакомым с основами  радиосетей, стандартом 802.11 и регуляторной политикой государства.</li><li>Все описанное ниже носит рекомендательный характер. Возможно, они  неприменимы к вашей ситуации. Из любого правила есть исключения, которые  опущены для краткости. Предельные случаи можно обсудить в комментариях.</li><li>Пожалуйста, обратите внимание на слово «неочевидные». Подробное  доказательство некоторых тезисов требует погружения в стандарты, я этого  делать не хочу (хоть и пришлось пару раз).</li></ul><br /><br /><h4>1. Как жить хорошо самому и не мешать соседям.</h4><br /><b>[1.1]</b> Казалось бы – чего уж там? Выкрутил точку на полную  мощность, получил максимально возможное покрытие – и радуйся. А теперь  давайте подумаем: не только сигнал точки доступа должен достичь клиента,  но и сигнал клиента должен достичь точки. Мощность передатчика ТД  обычно до 100 мВт (20 dBm). А теперь загляните в datasheet к своему  ноутбуку/телефону/планшету и найдите там мощность его Wi-Fi передатчика.  Нашли? Вам очень повезло! Часто её вообще не указывают (можно поискать  по <a href="http://transition.fcc.gov/oet/ea/fccid/">FCC ID</a>). Тем не  менее, можно уверенно заявлять, что мощность типичных мобильных  клиентов находится в диапазоне 30-50 мВт. Таким образом, если ТД вещает  на 100мВт, а клиент – только на 50мВт, в зоне покрытия найдутся места,  где клиент будет слышать точку хорошо, а ТД клиента — плохо (или вообще  слышать не будет) – асимметрия. <i>Это справедливо даже с учетом того,  что у точки обычно лучше чувствительность приема — смотрите под  спойлером. Опять же, речь идет не о дальности, а о симметрии.</i>Сигнал  есть – а связи нет. Или downlink быстрый, а uplink медленный. Это  актуально, если вы используете Wi-Fi для онлайн-игр или скайпа, для  обычного интернет-доступа это не так и важно (только, если вы не на краю  покрытия). И будем жаловаться на убогого провайдера, глючную точку,  кривые драйвера, но не на неграмотное планирование сети. <br /><img src="http://habrastorage.org/storage2/abd/8b0/b24/abd8b0b24381be3172e5f33e64b8a421.png" /><br /><br /><div class="spoiler"><b class="spoiler_title">Обоснование (для тех, кому интересны подробности):</b></div><br /><b>Вывод: может оказаться, что для получения более стабильной связи мощность точки придется снизить</b>. Что, согласитесь, не совсем очевидно :) <br /><br /><b>[1.2]</b> Также далеко не самым известным фактом, добавляющим к  асимметрии, является то, что у большинства клиентских устройств мощность  передатчика снижена на «крайних» каналах (1 и 11/13 для 2.4 ГГц). Вот  пример для iPhone из <a href="https://apps.fcc.gov/eas/GetApplicationAttachment.html?id=1544473">документации FCC</a> (мощность на порту антенны).<br /><img src="http://habrastorage.org/storage2/457/883/365/4578833652094df1a1ed8b3e5416d197.png" /><br />Как видите, на крайних каналах мощность передатчика в ~2.3 раза ниже,  чем на средних. Причина в том, что Wi-Fi – связь широкополосная,  удержать сигнал чётко в пределах рамки канала не удастся. Вот и  приходится снижать мощность в «пограничных» случаях, чтобы не задевать  соседние с ISM диапазоны. <b>Вывод: если ваш планшет плохо работает в туалете – попробуйте переехать на канал 6.</b><br /><br /><a href="https://www.blogger.com/null" name="2"></a><h4>2. Раз уж речь зашла о каналах…</h4><br />Всем известны «непересекающиеся» каналы 1/6/11. Так вот, они  пересекаются! Потому, что Wi-Fi, как было упомянуто раньше, технология  широкополосная и полностью сдержать сигнал в рамках канала невозможно.  Приведенные ниже иллюстрации демонстрируют эффект для 802.11n OFDM (HT).  На первой иллюстрации изображена спектральная маска 802.11n OFDM (HT)  для 20МГц канала в 2.4ГГц (взята прямо из стандарта). По вертикали —  мощность, по горизонтали — частота (смещение от центральной частоты  канала). На второй иллюстрации я наложил спектральные маски каналов  1,6,11 с учетом соседства. Из этих иллюстраций мы сделаем два важных  вывода. <br /><img src="http://habrastorage.org/storage2/eb6/41a/713/eb641a713034df076a98e0395494ce49.png" /><br /><img src="http://habrastorage.org/storage2/411/1ee/55b/4111ee55b74e79932c244b3984ed57cf.png" /><br /><br /><b>[2.1]</b> Все считают, что ширина канала — 22МГц (так и есть). Но,  как показывает иллюстрация, сигнал на этом не заканчивается, и даже  непересекающиеся каналы таки перекрываются: 1/6 и 6/11 — на ~-20dBr,  1/11 — на ~-36dBr, 1/13 — на -45dBr.<br />Попытка поставить две точки доступа, настроенные на соседние  «неперекрывающиеся» каналы, близко друг от друга приведет к тому, что  каждая из них будет создавать соседке помеху в 20dBm – 20dB – 50dB  [которые добавим на потери распространения сигнала на малое расстояние и  небольшую стенку] =-50dBm! Такой уровень шума способен целиком забить  любой полезный Wi-Fi сигнал из соседней комнаты, или блокировать ваши  коммуникации целиком! <div class="spoiler"><b class="spoiler_title">Почему</b></div><br /><b>Вывод: если вы поставите точку рядом со стеной, а ваш сосед – с  другой стороны стены, его точка на соседнем «неперекрывающемся» канале  все равно может доставлять вам серьезные проблемы.</b> Попробуйте посчитать значения помехи для каналов 1/11 и 1/13 и сделать выводы самостоятельно. <br />Аналогично, некоторые стараются «уплотнить» покрытие, устанавливая две  точки настроенные на разные каналы друг на друга стопкой — думаю, уже не  надо объяснять, что будет (исключением тут будет грамотное  экранирование и грамотное разнесение антенн — все возможно, если знать  как). <br /><br /><b>[2.2]</b> Второй интересный аспект – это попытки чуть более  продвинутых пользователей «убежать» между стандартными каналами 1/6/11.  Опять же, логика проста: «Я между каналами словлю меньше помех». По  факту, помех, обычно, ловится не меньше, а больше. Раньше вы страдали по  полной только от одного соседа (на том же канале, что и вы). Но это  были помехи не первого уровня OSI (интерференция), а второго – коллизии —  т.к. ваша точка делила с соседом коллизионный домен и цивилизованно  соседствовала на MAC-уровне. Теперь вы ловите интерференцию (Layer1) от  двух соседей с обеих сторон. <br />В итоге, delay и jitter, может, и попытались немного уменьшиться (т.к.  коллизий теперь как бы нет), но зато уменьшилось и соотношение  сигнал/шум. А с ним уменьшились и скорости (т.к. каждая скорость требует  некоторого минимального SNR — об этом в [3.1]) и процент годных фреймов  (т.к. уменьшился запас по SNR, увеличилась чувствительность к случайным  всплескам интерференции). Как следствие, обычно, возростает retransmit  rate, delay, jitter, уменьшается пропускная способность.<br />Кроме того, при значительном перекрытии каналов таки возможно корректно  принять фрейм с соседнего канала (если соотношение сигнал/шум позволяет)  и таки получить коллизию. А при помехе выше -62dBm вышеупомянутый  механизм CCA просто не даст воспользоваться каналом. Это только  усугубляет ситуацию и негативно влияет на пропускную способность.<br /><b>Вывод: не старайтесь использовать нестандартные каналы, не просчитав последствий, и отговаривайте от этого соседей.</b> В общем, то же, что и с мощностью: отговаривайте соседей врубать точки  на полную мощность на нестандартных каналах – будет меньше интерференции  и коллизий у всех. Как просчитать последствия станет понятно из [3].<br /><br /><b>[2.3]</b> По примерно тем же причинам не стоит ставить точку доступа у  окна, если только вы не планируете пользоваться/раздавать Wi-Fi во  дворе. Толку от того, что ваша точка будет светить вдаль, вам лично  никакого – зато будете собирать коллизии и шум от всех соседей в прямой  видимости. И сами к захламленности эфира добавите. Особенно в  многоквартирных домах, построенных зигзагами, где окна соседей смотрят  друг на друга с расстояния в 20-30м. Соседям с точками на подоконниках  принесите свинцовой краски на окна… :)<br /><br /><b>[2.4][UPD]</b> Также, для 802.11n актуален вопрос 40MHz каналов. Моя  рекоммендация — включать 40MHz в режим «авто» в 5GHz, и не включать  («20MHz only») в 2.4GHz (исключение — полное отсутствие соседей).  Причина в том, что в присутствии 20MHz-соседей вы с большой долей  вероятности получите помеху на одной из половин 40MHz-канала + включится  режим совместимости 40/20MHz. Конечно, можно жестко зафиксировать 40MHz  (если все ваши клиенты его поддерживают), но помеха все равно  останется. Как по мне, лучше стабильные 75Mbps на поток, чем  нестабильные 150. Опять же, возможны исключения — применима логика из  [3.4]. Подробности можно почитать <a href="http://habrahabr.ru/post/149447/#comment_5055041">в этой ветке комментариев</a> (вначале прочтите [3.4]).<br /><br /><h4>3. Раз уж речь зашла о скоростях…</h4><br /><b>[3.1]</b> Уже несколько раз мы упоминали скорости (rate/MCS — не  throughput) в связке с SNR. Ниже приведена таблица необходимых SNR для  рейтов/MCS, составленная мной по материалам стандарта. Собственно,  именно поэтому для более высоких скоростей чувствительность приемника  меньше, как мы заметили в [1.1].<br /><img src="http://habrastorage.org/storage2/516/195/389/5161953891f683892c750f4f07f84782.png" /><br />В сетях 802.11n/MIMO благодаря <a href="http://en.wikipedia.org/wiki/Maximal-ratio_combining">MRC</a> и другим многоантенным ухищрениям нужный SNR можно получить и при более  низком входном сигнале. Обычно, это отражено в значениях  чувствительности в datasheet'ах.<br />Отсюда, кстати, можно сделать еще один вывод: <b>эффективный размер (и форма) зоны покрытия зависит от выбранной скорости (rate/MCS).</b> Это важно учитывать в своих ожиданиях и при планировании сети.<br /><br /><b>[3.2]</b> <i>Этот пункт может оказаться неосуществимым для владельцев  точек доступа с совсем простыми прошивками, которые не позволяют  выставлять Basic и Supported Rates.</i> Как уже было сказано выше,  скорость (rate) зависит от соотношения сигнал/шум. Если, скажем, 54Mbps  требует SNR в 25dB, а 2Mbps требует 6dB, то понятно, что фреймы,  отправленные на скорости 2Mbps «пролетят» дальше, т.е. их можно  декодировать с большего расстояния, чем более скоростные фреймы. Тут мы и  приходим к Basic Rates: все служебные фреймы, а также броадкасты (если  точка не поддерживает BCast/MCast acceleration и его разновидности),  отправляются на самой нижней Basic Rate. А это значит, что вашу сеть  будет видно за многие кварталы. Вот пример (спасибо Motorola  AirDefense).<br /><img src="http://habrastorage.org/storage2/4a2/8fd/cc9/4a28fdcc91ae76f5d54f25d0c66c5f61.jpg" /><br />Опять же, это добавляет к рассмотренной в [2.2] картине коллизий: как  для ситуации с соседями на том же канале, так и для ситуации с соседями  на близких перекрывающихся каналах. Кроме того, фреймы ACK (которые  отправляются в ответ на любой unicast пакет) тоже ходят на минимальной  Basic Rate (если точка не поддерживает их акселерацию) <br /><div class="spoiler"><b class="spoiler_title">Еще немного математики</b></div><br /><b>Вывод: отключайте низкие скорости – и у вас, и у соседей сеть станет работать быстрее.</b> У вас – за счет того, что весь служебный трафик резко начнет ходить  быстрее, у соседей – за счет того, что вы теперь для них не создаете  коллизий (правда, вы все еще создаете для них интерференцию — сигнал  никуда не делся — но обычно достаточно низкую). Если убедите соседей  сделать то же самое – у вас сеть будет работать еще быстрее.<br /><br /><b>[3.3]</b> Понятно, что при отключении низких скоростей подключиться к  тоже можно будет только в зоне более сильного сигнала (требования к SNR  стали выше), что ведет к уменьшению эффективного покрытия. Равно как и в  случае с понижением мощности. Но тут уж вам решать, что вам нужно:  максимальное покрытие или быстрая и стабильная связь. Используя табличку  и datasheet'ы производителя точки и клиентов почти всегда можно достичь  приемлемого баланса.<br /><br /><b>[3.4]</b> Еще одним интересным вопросом являются режимы совместимости  (т.н. “Protection Modes”). В настоящее время есть режим совместимости  b-g (ERP Protection) и a/g-n (HT Protection). В любом случае скорость  падает. На то, насколько она падает, влияет куча факторов (тут еще на  две статьи материала хватит), я обычно просто говорю, что скорость  падает примерно на треть. При этом, если у вас точка 802.11n и клиент  802.11n, но у соседа за стеной точка g, и его трафик долетает до вас –  ваша точка точно так же свалится в режим совместимости, ибо того требует  стандарт. Особенно приятно, если ваш сосед – самоделкин и ваяет что-то  на основе передатчика 802.11b. :) Что делать? Так же, как и с уходом на  нестандартные каналы – оценить, что для вас существеннее: коллизии (L2)  или интерференция (L1). <b>Если уровень сигнала от соседа относительно низок, переключайте точки в режим чистого 802.11n (Greenfield)</b>:  возможно, понизится максимальная пропускная способность (снизится SNR),  но трафик будет ходить равномернее из-за избавления от избыточных  коллизий, пачек защитных фреймов и переключения модуляций. В противном  случае – лучше терпеть и поговорить с соседом на предмет  мощности/перемещения ТД. Ну, или отражатель поставить… Да, и не ставьте  точку на окно! :)<br /><br /><b>[3.5]</b> Другой вариант – переезжать в 5 ГГц, там воздух чище:  каналов больше, шума меньше, сигнал ослабляется быстрее, да и банально  точки стоят дороже, а значит – их меньше. Многие покупают dual radio  точку, настраивают 802.11n Greenfield в 5 ГГц и 802.11g/n в 2.4 ГГц для  гостей и всяких гаджетов, которым скорость все равно не нужна. Да и  безопаснее так: у большинства script kiddies нет денег на дорогие  игрушки с поддержкой 5 ГГц. <br /><b>Для 5 ГГц следует помнить, что надежно работают только 4 канала: 36/40/44/48</b> (для Европы, для США есть еще 5). На остальных включен режим сосуществования с радарами (<a href="http://en.wikipedia.org/wiki/List_of_WLAN_channels#5.C2.A0GHz_.28802.11a.2Fh.2Fj.2Fn.29.5B13.5D">DFS</a>). В итоге, связь может периодически пропадать.<br /><br /><h4>4. Раз уж речь зашла о безопасности…</h4><br />Упомянем некоторые интересные аспекты и здесь.<br /><b>[4.1]</b> Какой должна быть длина PSK? Вот выдержка из текста стандарта 802.11-2012, секция M4.1:<br /><i>Keys derived from the pass phrase provide relatively low levels of  security, especially with keys generated form short passwords, since  they are subject to dictionary attack. Use of the key hash is  recommended only where it is impractical to make use of a stronger form  of user authentication. A key generated from a passphrase of less than  about 20 characters is unlikely to deter attacks.</i><br /><b>Вывод: ну, у кого пароль к домашней точке состоит из 20+ символов? :)</b><br /><br /><b>[4.2]</b> Почему моя точка 802.11n не «разгоняется» выше скоростей a/g? И какое отношение это имеет к безопасности? <br />Стандарт 802.11n поддерживает только два режима шифрования: CCMP и None.  Сертификация Wi-Fi 802.11n Compatible требует, чтобы при включении TKIP  на радио точка переставала поддерживать все новые скоростные режимы  802.11n, оставляя лишь скорости 802.11a/b/g. В некоторых случаях можно  видеть ассоциации на более высоких рейтах, но пропускная способность все  равно будет низкой. <b>Вывод: забываем про TKIP – он все равно будет запрещен с 2014 года</b> (планы Wi-Fi Alliance).<br /><br /><b>[4.3]</b> Стоит ли прятать (E)SSID? (это уже более известная тема)<br /><div class="spoiler"><b class="spoiler_title">спрятался</b></div><br /><br /><h4>5. Всякая всячина.</h4><br /><b>[5.1]</b> Немного о MIMO. Почему-то по сей день я сталкиваюсь с  формулировками типа 2x2 MIMO или 3x3 MIMO. К сожалению, для 802.11n эта  формулировка малополезна, т.к. важно знать еще количество  пространственных потоков (Spatial Streams). Точка 2x2 MIMO может  поддерживать только один SS, и не поднимется выше 150Mbps. Точка с 3x3  MIMO может поддерживать 2SS, ограничиваясь лишь 300Mbps. Полная формула  MIMO выглядит так: TX x RX: SS. Понятно, что количество SS не может быть  больше min (TX, RX). Таким образом, приведенные выше точки будут  записаны как 2x2:1 и 3x3:2. Многие беспроводные клиенты реализуют 1x2:1  MIMO (смартфоны, планшеты, дешевые ноутбуки) или 2x3:2 MIMO. <b>Так что бесполезно ожидать скорости 450Mbps от точки доступа 3x3:3 при работе с клиентом 1x2:1.</b> Тем не менее, <b>покупать точку типа 2x3:2 все равно стоит</b>,  т.к. большее количество принимающих антенн добавляет точке  чувствительности (MRC Gain). Чем больше разница между количеством  принимающих антенн точки и количеством передающих антенн клиента — тем  больше выигрыш (если на пальцах). Однако, в игру вступает multipath.<br /><br /><b>[5.2]</b> Как известно, multipath для сетей 802.11a/b/g – зло. Точка  доступа, поставленная антенной в угол, может работать не самым лучшим  образом, а выдвинутая из этого угла на 20-30см может показать  значительно лучший результат. Аналогично для клиентов, помещений со  сложной планировкой, кучей металлических предметов и т.д. <br />Для сетей MIMO с MRC и в особенности для <a href="http://en.wikipedia.org/wiki/Space-division_multiple_access">работы нескольких SS</a> (и следовательно, для получения высоких скоростей) multipath –  необходимое условие. Ибо, если его не будет – создать несколько  пространственных потоков не получится. Предсказывать что-либо без  специальных инструментов планирования здесь сложно, да и с ними  непросто. Вот пример рассчетов из Motorola LANPlanner, но однозначный  ответ тут может дать только радиоразведка и тестирование. <br /><img src="http://habrastorage.org/storage2/b2f/b8e/619/b2fb8e61948a44fcd642e0ad3220c1ac.png" /><br />Создать благоприятную multipath-обстановку для работы трех SS сложнее,  чем для работы двух SS. Поэтому новомодные точки 3x3:3 работают с  максимальной производительностью обычно лишь в небольшом радиусе, да и  то не всегда. Вот <a href="https://lh6.googleusercontent.com/-j6efSnQainw/TXAWH_jiAtI/AAAAAAAAA3Q/MtBoqF3px38/s1600/original.jpg">красноречивый пример от HP</a> (если копнуть глубже в материалы анонса их <a href="http://h17007.www1.hp.com/us/en/whatsnew/011011.aspx">первой точки 3x3:3 — MSM460</a>)<br /><br /><b>[5.3]</b> Ну, и несколько интересных фактов для коллекции:<br /><ul><li>Человеческое тело ослабляет сигнал на 3-5dB (2.4/5ГГц). Просто  развернувшись лицом к точке можно получить более высокую скорость.</li><li>Некоторые дипольные антенны имеют асммметричную диаграмму  направленности в H-плоскости («вид сбоку») и лучше работают  перевернутыми</li><li>В фрейме 802.11 может использоваться одновременно до четырех MAC-адресов, а в 802.11s (новый стандарт на mesh) — до шести!</li></ul><br /><br /><h4>Итого</h4><br />Технология 802.11 (да и радиосетей в целом) обладает множеством  неочевидных особенностей. Лично у меня вызывает громадное уважение и  восхищение тот факт, что люди отточили насколько сложную технологию до  уровня «воткни-работай». Мы рассмотрели (в разном объеме) разные аспекты  физического и канального уровня сетей 802.11:<br /><ul><li>Асиметрию мощностей</li><li>Ограничения на мощность передачи в граничных каналах</li><li>Пересечение «непересекающихся» каналов и последствия</li><li>Работу на «нестандартных» каналах (отличных от 1/6/11/13)</li><li>Работу механизма Clear Channel Assesment и блокировку канала</li><li>Зависимость скорости (rate/MCS) от SNR и, как следствие, зависимость  чувствительности приемника и зоны покрытия от требуемой скорости</li><li>Особенности пересылки служебного трафика</li><li>Последствия включения поддержки низких скоростей</li><li>Последствия включения поддержки режимов совместимости</li><li>Выбор каналов в 5ГГц</li><li>Некоторые забавные аспекты безопасности, MIMO и проч.</li></ul><br />Не все было рассмотрено в полном объеме и исчерпывающем виде, равно как  за бортом остались неочевидные аспекты сосуществования клиентов,  балансировки нагрузки, WMM, питания и роуминга, экзотика типа  Single-Channel Architecture и индивидуальных BSS — но это уже тема для  сетей совсем другого масштаба. Если следовать хотя бы вышеприведенным  соображениям, в обычном жилом доме можно получить вполне приличный <del>коммунизм</del> microcell, как в высокопроизводительных корпоративных WLAN. Надеюсь, статья была вам интересна.     
