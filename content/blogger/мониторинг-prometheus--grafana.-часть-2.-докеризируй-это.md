+++
title = "[Мониторинг] Prometheus + Grafana. Часть 2. Докеризируй это!"
date = 2019-06-10T08:46:00Z
updated = 2019-06-10T08:46:58Z
draft = true
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Как говорится, обещанного три года ждут. Но я не дождался. Поэтому, спустя всего лишь год с небольшим руки сами бросились к клавиатуре и написали этот пост. Запустим grafana и prometheus!<br /><br />Как говорилось в <a href="http://www.bubnovd.net/2018/05/prometheus-grafana-1.html" target="_blank">предыдущей части</a>, стек нашего мониторинга будет состоять из трех частей:<br /><br /><ol><li>prometheus, который будет хранить данные</li><li>grafana, которая будет отображать эти данные</li><li>snmp_exporter, который будет эти самые дынные выдергивать с наших сетевых устройств</li></ol><div><br /></div><div>Есть ещё четвертая часть, которая мониторингу нужна как TTL'у девятый бит - система контейнеризаци. Это docker со своими друзьями, внутри которого будем крутить всё наше хозяйство.&nbsp;</div><h3><br />Что ещё за docker?</h3><div><br /></div><div>Если вы задались этим вопросом - поздравляю! Теперь вы айти-дед и ничего не понимаете в новомодных технологиях.&nbsp;</div><div><br /></div><div>Контейнер - это, в двух словах (совсем не правильных и даже вредных, но так проще понять), маленькая виртуальная машина для отдельного приложения. запускать приложения в контейнерах удобно тем, что приложения не будут влиять друг на друга - у каждого будут свои библиотеки. Помните, как неудобно рпыгать по граблям, когда одному приложению нужна новая библиотека, в другое работате только со старой. И не позавдую я тому, кто затрет старую либу, не помня её версии.&nbsp;</div><div><br /></div><div>А ещё с помощью файлов описания контейнеров, можно в удобном виде описать как разворачивается приложение, какие зависимости ему нужны и сразу подсунуть ему нужный конфиг. А ещё миграция, балансировка и прочее.&nbsp;</div><div><br /></div><div>Но главное:&nbsp;</div><div>Контейнеризация в рамках этой статьи идет скорее в качестве доплнительной опции, чем необходимости. Весь стек прекрасно работает без докера.</div><div><br /></div><div><br /></div><h3>Ставим docker</h3><div><br /></div><div>Но мы пойдем по пути с docker.&nbsp;</div><div><br /></div><div>тут описание как накатить всё с помощью docker-compose</div><div><br /></div><h3>snmp exporter</h3><div>Главный элемент этой части - конфиг snmp.yml:</div><div><br /></div><br /><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">mikrotik:</span></div><div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; walk:</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; - 1.3.6.1.2.1.17.1.1</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; - 1.3.6.1.2.1.17.2.1</span></div></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">...</span></div><div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; metrics:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; - name: dot1dBaseBridgeAddress&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; oid: 1.3.6.1.2.1.17.1.1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; type: PhysAddress48</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; help: The MAC address used by this bridge when it must be referred to in a unique</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; fashion - 1.3.6.1.2.1.17.1.1</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; - name: dot1dStpProtocolSpecification</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; oid: 1.3.6.1.2.1.17.2.1</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; type: gauge&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; help: An indication of what version of the Spanning Tree Protocol is being run</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; - 1.3.6.1.2.1.17.2.1&nbsp; &nbsp;</span></div></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">...</span></div><div><br /></div><div>В первой части идет перечисление OID, которые надо опрашивать, а во второй - их описание. Я составлял конфиг специально для Mikrotik RouterOS. Но несложно сделать свой. Для удобного создания конфигов для snmp-exporter существует специальный <a href="https://github.com/prometheus/snmp_exporter/tree/master/generator" target="_blank">snmp-generator</a>, рекомендую использовать его.&nbsp;</div><div><br /></div><div>Если snmp_exporter работает нормально, то по адресу http://localhost:9116 будет страница с запросом проверяемого модуля и адресом ресурса. В первое поле вводим mikrotik, во второе - ip вашего роутера и через минуту получаем страницу, удобную для чтения prometheus'ом.&nbsp;</div><div><br /></div><div>В нашем случае эту страницу увидеть не получится - она доступна только изнутри докер-контейнеров, чтобы не светить всему миру параметры выших маршрутизаторов.</div><div><br /></div><div><br /></div><h3>prometheus</h3><div>Главный герой нашего повествования</div><div><br /></div><div><br /></div><div><br /></div>
