+++
title = "Скрипт для выявления порта свитча по маку. Опрос по SNMP"
date = 2015-02-27T00:32:00Z
updated = 2015-02-27T01:30:50Z
tags = ["SNMP", "PowerShell", "коммутатор", "L2", "коммутация", "Автоматизация", "скрипт"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Допилил <a href="http://www.bubnovd.net/2015/02/blog-post_25.html">предыдущий скрипт&nbsp;</a>. Необходимо знать аплинки каждого из свитчей. В моем случае, все они подключены к одному корневому (RootSwitch). Скрипт вытягивает по SNMP FDB таблицу корневого свитча, ищет в ней заданный MAC, сверяет его по заранее заданной таблице аплинков до свитчей доступа, переходит на следующий свитч и с него так же забирает FDB таблицу, а в ней уже ищет необходимый MAC. Информация выводится следующим образом "MAC, vlan, port корневого свитча; MAC, vlan, port конечного свитча".<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-JpMcamIh4E0/VPAsOT9d_vI/AAAAAAAAAj8/GG4qV6cYNaA/s1600/PS-MAC-Port.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-JpMcamIh4E0/VPAsOT9d_vI/AAAAAAAAAj8/GG4qV6cYNaA/s1600/PS-MAC-Port.PNG" height="75" width="400" /></a></div><br /><br /><a name='more'></a>Для работы с SNMP необходимо подключить модуль <a href="http://vwiki.co.uk/SNMP_and_PowerShell">SharpSNMP</a>.<br />Из неожиданностей<br /><br /><ul><li>&nbsp;в OID &nbsp;MAC адреса хранятся в десятичном формате, пришлось их переводить в шестнадцатеричный.&nbsp;</li><li>Простым способом вернуть несколько значений из функции невозможно. Пришлось городить хэш-таблицу, в которой хранились бы три массива (MAC, vlan, port)</li></ul><br />В OID информация хранится следующим образом:<br />OID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Data<br />--- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ----<br />.1.3.6.1.2.1.17.7.1.2.1.1.2.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 223<br />.1.3.6.1.2.1.17.7.1.2.1.1.2.41 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;63<br />.1.3.6.1.2.1.17.7.1.2.1.1.2.4026 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 222<br />.1.3.6.1.2.1.17.7.1.2.2.1.2.<span style="color: red;">1</span>.144.2.166.50.206.43 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3<br />.1.3.6.1.2.1.17.7.1.2.2.1.2.<span style="color: red;">1</span>.144.2.166.50.206.63 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6<br />.1.3.6.1.2.1.17.7.1.2.2.1.2.<span style="color: red;">1</span>.144.2.166.50.206.126 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4<br />.1.3.6.1.2.1.17.7.1.2.2.1.2.<span style="color: red;">41</span>.0.21.100.59.187.78 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;26<br />.1.3.6.1.2.1.17.7.1.2.2.1.2.<span style="color: red;">4026</span>.0.9.136.173.129.150 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;26<br />.1.3.6.1.2.1.17.7.1.2.2.1.<span style="color: blue;">3</span>.4026.232.64.241.24.239.215 &nbsp; &nbsp; &nbsp;3<br />.1.3.6.1.2.1.17.7.1.2.2.1.<span style="color: blue;">3</span>.4026.232.64.241.24.242.213 &nbsp; &nbsp; &nbsp;3<br /><br />Первые три строки (может быть больше или меньше, в зависиомсти от количества vlan'ов): последняя цифра - номер vlan'а, data - количество MAC-адресов в этом влане в FDB-таблице.<br /><br />Далее следуют строки с перечислением MAC-адресов, сгруппированные по vlan'ам: после символов .1.3.6.1.2.1.17.7.1.2.2.1.2. идет номер vlan (1, 41, 4026 в нашем случае), а за ним MAC адрес в десятичном формате. В поле Data - порт с найденным MAC-ом.<br /><br />Далее следуют строки, начинающиеся на .1.3.6.1.2.1.17.7.1.2.2.1.3. Они содержат информацию, о способе получения MAC-адреса. Если параметр 3 - MAC получен методом learning (опрос порта), 4 - MAC коммутатора, с которого взяли FDB.<br /><br />Мы будем обрабатывать строки из второго блока. Сначала отсекаем ненужную нам часть OID, затем разбиваем на подстроки и запоминаем данные. Полученные данные выводим по порядку в 3 массива - MAC, port, vlan.<br /><br />Собственно скрипт:<br /><br /><span style="font-family: Courier New, Courier, monospace;">function findonswitch ([string]$ip) {</span><br /><span style="font-family: Courier New, Courier, monospace;">$oid=".1.3.6.1.2.1.17.7.1.2.2.1.2."</span><br /><span style="font-family: Courier New, Courier, monospace;">$mas = Invoke-SnmpWalk $ip ".1.3.6.1.2.1.17.7.1.2" #vlans</span><br /><span style="font-family: Courier New, Courier, monospace;">$i=0</span><br /><span style="font-family: Courier New, Courier, monospace;">$vlan=@()</span><br /><span style="font-family: Courier New, Courier, monospace;">$mac=@()</span><br /><span style="font-family: Courier New, Courier, monospace;">$port=@()</span><br /><span style="font-family: Courier New, Courier, monospace;">foreach ($pt in $mas)</span><br /><span style="font-family: Courier New, Courier, monospace;">{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>if ($pt.OID -like "*$oid*")</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$pt.OID = $pt.OID.remove(0,28)</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$vlan += $pt.OID.Substring(0, $pt.OID.IndexOf("."))</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$temp = $pt.OID.Substring($pt.OID.IndexOf(".") + 1, $pt.OID.Length - $pt.OID.IndexOf(".")-1)</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>###перевод из Dec в Hex</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$mas=$temp.split(".")</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$nmac=@()</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>foreach ($sdec in $mas)</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">    </span>$dec = [int]$sdec</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">    </span>$nmac += '{0:X2}' -f $dec</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>}</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$str=$nmac -join "-"</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>###</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$mac += $str</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$port += $pt.Data</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>}</span><br /><span class="Apple-tab-span" style="white-space: pre;"><span style="font-family: Courier New, Courier, monospace;">  </span></span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;">$return= @{}</span><br /><span style="font-family: Courier New, Courier, monospace;">$return.vlan=$vlan</span><br /><span style="font-family: Courier New, Courier, monospace;">$return.mac=$mac</span><br /><span style="font-family: Courier New, Courier, monospace;">$return.port=$port</span><br /><span style="font-family: Courier New, Courier, monospace;">return $return</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">####################################################################</span><br /><span style="font-family: Courier New, Courier, monospace;">$rootIP = "192.168.0.21"</span><br /><span style="font-family: Courier New, Courier, monospace;">$sport = ("1", "2", "5", "12", "13", "14", "43", "44", "65", "66", "74", "107")</span><br /><span style="font-family: Courier New, Courier, monospace;">$swDB = ("192.168.0.42", "192.168.0.44", "192.168.0.61", "192.168.0.52", "192.168.0.51", "192.168.0.12", "192.168.0.33", "192.168.0.32", "192.168.0.41", "192.168.0.43", "192.168.0.11", "192.168.0.34")</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">function findinarr ($array, $value) {</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; for ($i=0; $i -lt $array.count;$i++) {&nbsp;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; if($array[$i] -eq $value){$i}</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; }</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: 'Courier New', Courier, monospace;">$res=findonswitch $rootIP</span><br /><span style="font-family: Courier New, Courier, monospace;">$dataMACRoot = $res.mac</span><br /><span style="font-family: Courier New, Courier, monospace;">$dataPortRoot = $res.port</span><br /><span style="font-family: Courier New, Courier, monospace;">$dataVlanRoot = $res.vlan</span><br /><span style="font-family: Courier New, Courier, monospace;">$mac = Read-Host "Enter MAC"</span><br /><span style="font-family: Courier New, Courier, monospace;">if ($mac.indexof(":") -ne 0)</span><br /><span style="font-family: Courier New, Courier, monospace;">{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>$mac=$mac.replace(":", "-")</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;">$i=0</span><br /><span style="font-family: Courier New, Courier, monospace;">$flag=0</span><br /><span style="font-family: Courier New, Courier, monospace;">foreach ($S in $dataMACRoot)</span><br /><span style="font-family: Courier New, Courier, monospace;">{<span class="Apple-tab-span" style="white-space: pre;"> </span></span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>if ($mac -eq $s)</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>$portRoot = $dataPortRoot[$i]</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>$vlanRoot = $dataVlanRoot[$i]</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>Write-Host $mac on $portRoot 'in vlan' $vlanRoot on RootSwitch</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>if ($flag -eq 0)</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>$portRoot1 = $dataPortRoot[$i]</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>}</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>$flag++</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>}</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>$i++</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">$A = findinarr $sport $portRoot1</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">$res=findonswitch $swDB[$A]</span><br /><span style="font-family: Courier New, Courier, monospace;">$dataMAC = $res.mac</span><br /><span style="font-family: Courier New, Courier, monospace;">$dataPort = $res.port</span><br /><span style="font-family: Courier New, Courier, monospace;">$dataVlan = $res.vlan</span><br /><span style="font-family: Courier New, Courier, monospace;">$i=0</span><br /><span style="font-family: Courier New, Courier, monospace;">foreach ($S in $dataMAC)</span><br /><span style="font-family: Courier New, Courier, monospace;">{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>if ($mac -eq $s)</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>$port = $dataPort[$i]</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>$vlan = $dataVlan[$i]</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>Write-Host $mac on $port 'in vlan' $vlan on 'switch' $swDB[$A]</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>}</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>$i++</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><br />Работа второй части скрипта (после ###########) описана в предыдущем <a href="http://www.bubnovd.net/2015/02/blog-post_25.html">посте</a>. Тут она претерпела некоторые изменения, в связи с входящей информацией из массива, а не из csv-файла, но логика не изменилась.
