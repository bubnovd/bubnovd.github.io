+++
title = "Самый полный мануал по резервированию интернета на Mikrotik RouterOS"
date = 2015-03-05T22:06:00Z
updated = 2017-07-26T23:24:47Z
tags = ["routeros", "Mikrotik", "script", "failover"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

В сети много мануалов по фэйловеру на RouterOS и подобрать нужный под конкретные цели иногда проблематично. В ходе своих экспериментов я выяснил, что наиболее универсальным является <a href="http://wiki.mikrotik.com/wiki/Advanced_Routing_Failover_without_Scripting">этот</a> способ. Но у меня возникло несколько вопросов, ответы на которые я пока не нашел.<br /><a name='more'></a><br /><pre style="-webkit-box-shadow: rgb(192, 192, 192) 0px 0px 12px; background: rgba(255, 255, 238, 0.701961); border-radius: 5px; border: 1px solid rgb(170, 170, 170); box-shadow: rgb(192, 192, 192) 0px 0px 12px; font-family: monospace, Courier; font-size: 14px; line-height: 1.3em; margin-left: 20px; padding: 1em; width: 1034.078125px;">/ip route<br />add dst-address=<b>Host1</b> gateway=GW1 scope=<b>10</b><br />add dst-address=<b>Host2</b> gateway=GW2 scope=<b>10</b></pre><br /><pre style="-webkit-box-shadow: rgb(192, 192, 192) 0px 0px 12px; background: rgba(255, 255, 238, 0.701961); border-radius: 5px; border: 1px solid rgb(170, 170, 170); box-shadow: rgb(192, 192, 192) 0px 0px 12px; font-family: monospace, Courier; font-size: 14px; line-height: 1.3em; margin-left: 20px; padding: 1em; width: 1034.078125px;">/ip route<br />add distance=1 gateway=<b>Host1</b> routing-mark=ISP1 check-gateway=ping<br />add distance=2 gateway=<b>Host2</b> routing-mark=ISP1 check-gateway=ping</pre><br /><pre style="-webkit-box-shadow: rgb(192, 192, 192) 0px 0px 12px; background: rgba(255, 255, 238, 0.701961); border-radius: 5px; border: 1px solid rgb(170, 170, 170); box-shadow: rgb(192, 192, 192) 0px 0px 12px; font-family: monospace, Courier; font-size: 14px; line-height: 1.3em; margin-left: 20px; padding: 1em; width: 1034.078125px;">/ip route<br />add distance=1 gateway=<b>Host2</b> routing-mark=ISP2 check-gateway=ping<br />add distance=2 gateway=<b>Host1</b> routing-mark=ISP2 check-gateway=ping</pre><br /><br />Я делаю немного по-другому: первые две строки точно такие же, а дальше:<br /><pre style="-webkit-box-shadow: rgb(192, 192, 192) 0px 0px 12px; background: rgba(255, 255, 238, 0.701961); border-radius: 5px; border: 1px solid rgb(170, 170, 170); box-shadow: rgb(192, 192, 192) 0px 0px 12px; font-family: monospace, Courier; font-size: 14px; line-height: 1.3em; margin-left: 20px; padding: 1em; width: 1034.078125px;">/ip route<br />add distance=1 gateway=<b>Host1</b> check-gateway=ping<br />add distance=2 gateway=<b>Host2</b> check-gateway=ping</pre><br /><pre style="-webkit-box-shadow: rgb(192, 192, 192) 0px 0px 12px; background: rgba(255, 255, 238, 0.701961); border-radius: 5px; border: 1px solid rgb(170, 170, 170); box-shadow: rgb(192, 192, 192) 0px 0px 12px; font-family: monospace, Courier; font-size: 14px; line-height: 1.3em; margin-left: 20px; padding: 1em; width: 1034.078125px;">/ip route<br />add distance=1 gateway=<b>GW1</b> routing-mark=ISP1<br />add distance=1 gateway=GW<b>2</b> routing-mark=ISP2</pre><br />В первом варианте мне непонятно зачем пускать трафик, маркированный ISP1 по второму каналу и аналогично с ISP2. Чтобы не рвалась сессия? Она все равно рвется. В общем, я делаю по своему варианту.<br /><br />Как оно работает?<br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="background-color: rgba(255, 255, 238, 0.701961); font-size: 14px; line-height: 1.3em;">add dst-address=</span><b style="font-size: 14px; line-height: 1.3em;">Host1</b><span style="background-color: rgba(255, 255, 238, 0.701961); font-size: 14px; line-height: 1.3em;"> gateway=GW1 scope=</span><b style="font-size: 14px; line-height: 1.3em;">10</b></span><b style="font-family: monospace, Courier; font-size: 14px; line-height: 1.3em;"> </b><span style="line-height: 1.3em;"><span style="font-family: inherit;">указываем, что трафик до Host1 будет ходить через провайдера ISP1. Аналогично со вторым.</span></span><br /><span style="line-height: 1.3em;"><span style="font-family: inherit;"><br /></span></span><span style="line-height: 20.7999992370605px;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add distance=1 gateway=Host1 check-gateway=ping</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"> </span><span style="font-family: inherit;">указывает шлюзом по умолчанию Host1. Тем самым создается рекурсивный маршрут через GW1. Проверяется доступность Host1 пингом. Если Host1 доступен, то шлюз - GW1, если не доступен, но доступен Host2, трафик идет через GW2.</span></span><br /><span style="line-height: 20.7999992370605px;"><span style="font-family: inherit;"><br /></span></span><span style="line-height: 20.7999992370605px;"><span style="font-family: inherit;">Маркировка маршрутов необходима для того, чтобы трафик, пришедший в один из интерфейсов не улетел во второй, если метрика второго ниже. Маркировка создается в таблице Mangle фаервола:</span></span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="line-height: 20.7999992370605px;">add chain=prerouting&nbsp;</span><span style="line-height: 20.7999992370605px;">in-interface=ISP1-int&nbsp;</span><span style="line-height: 20.7999992370605px;">action=mark-connection new-connection-mark=ISP1 passthrough=yes&nbsp;</span></span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="line-height: 20.7999992370605px;"><span style="line-height: 20.7999992370605px;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add chain=prerouting connection-mark=ISP1 action=mark-routing new-routing-mark=ISP1</span></span> </span></span><br /><span style="line-height: 20.7999992370605px;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add chain=output connection-mark=ISP1 action=mark-routing new-routing-mark=ISP1</span></span><br /><span style="line-height: 20.7999992370605px;"><span style="font-family: inherit;">Так же по второму провайдеру.</span></span><br /><br />Эта схема прекрасно работает при статическом IP. Но как быть с DHCP, PPP и т.д. А всё просто - в настройках DHCP/PPP-клиента отключаем Add Default Route. И добавляем необходимый маршрут руками. Единственная проблема - адрес шлюза может смениться. В таком случае необходимо применение скриптов. Я написал небольшой скрипт для работы с USB-модемом, который проверяет правильный ли шлюз указан в строке 8.8.4.4 gw GW2. PPP-интерфейс в моем случае называется modem.<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">:local testIP 8.8.4.4/32</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">:local modemGW [/ip address get [find interface="modem"] network]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">if ($modemGW!=([/ip route get [find dst-address=$testIP] gateway])) do={</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">[/ip route set [find dst-address=$testIP] gateway $modemGW]}</span><br /><br />В Scheduler добавляем расписание для этого скрипта, чтобы выполнялся раз в минуту. На основе моего скрипта можно создать свой для любого другого типа подключения.<br />Для нетерпеливых привожу полный список команд, необходимый для настройки модема в качестве резервного канала. Всё, что вам нужно - просто скопировать текст и вставить его в терминал. Основной придется отмаркировать и прописать в маршрутизации руками:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/ip firewall mangle</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add chain=input in-interface=modem action=mark-connection new-connection-mark=modem</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add chain=output connection-mark=modem action=mark-routing new-routing-mark=modem</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/ip route</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add dst-address=8.8.4.4/32 gateway=[/ip address get [find interface="modem"] network] distance=1 scope=10</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add distance=2 gateway=8.8.4.4 scope=10 check-gateway=ping</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add dst-address=0.0.0.0/0 gateway=[/ip address get [find interface="modem"] network] distance=1 scope=10 routing-mark=modem</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/interface ppp-client set modem dial-on-demand=no add-default-route=no</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/system script</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=modemGW source=":local testIP 8.8.4.4/32\r\n:local modemGW [/ip address get [find interface=\"modem\"] network]\r\nif (\$modemGW!=([/ip route get [find dst-address=\$testIP] gateway])) do={\r\n[/ip route set [find dst-address=\$testIP] gateway \$modemGW]}"</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/system scheduler</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=checkGW interval=00:01:00 on-event=modemGW</span><br /><br /><br />Есть ещё один способ фэйловера. Делается он только с помощью скриптов. Полное его описание <a href="http://habrahabr.ru/post/141785/">здесь</a>. Ниже скрипт для его мгновенного создания:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/system script</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=SetGlobalParameters source="#Main interface name\r\n:global MainIf [/interface get [find comment~\"MainINT\"] name]\r\n#Reserve interface name\r\n:global RsrvIf [/interface get [find comment~\"RsrvINT\"] name]\r\n#Main interface ip address\r\n:global MainIfAddress \"\"\r\n#Reserve interface ip address\r\n:global RsrvIfAddress \"\""</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=DefineMainIfIp source=":global MainIf\r\n:global MainIfAddress \"\"\r\n:set MainIfAddress [/ip address get [find interface=$MainIf] address]"</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=DefineReservedIfIp source=":global RsrvIf\r\n:global RsrvIfAddress \"\"\r\n:set RsrvIfAddress [/ip address get [find interface=$RsrvIf] address]"</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=ConnectionCheck source=":global MainIf\r\n:global RsrvIf\r\n:global MainIfAddress\r\n:global RsrvIfAddress\r\n\r\n:local PingCount 3\r\n\r\n#yandex DNS\r\n:local PingTarget1 77.88.8.8\r\n\r\n#OpenDNS\r\n:local PingTarget2 208.67.222.222\r\n\r\n#google dns\r\n:local PingTarget3 8.8.8.8\r\n\r\n#Check main internet connection\r\n\r\n:local MainIfInetOk false;\r\n\r\nif (\$MainIfAddress=\"\") do={delay 5}\r\n\r\nif (\$MainIfAddress!=\"\") do={\r\n\r\n:local PingResult1 [/ping \$PingTarget1 count=\$PingCount interface=\$MainIf]\r\n:local PingResult2 [/ping \$PingTarget2 count=\$PingCount interface=\$MainIf]\r\n:local PingResult3 [/ping \$PingTarget3 count=\$PingCount interface=\$MainIf]\r\n:set MainIfInetOk ((\$PingResult1 + \$PingResult2 + \$PingResult3) &gt;= (2 * \$PingCount))\r\n}\r\n\r\n#Check reserved internet connection\r\n:local RsrvIfInetOk false;\r\n\r\nif (\$RsrvIfAddress=\"\") do={delay 5}\r\n\r\nif (\$RsrvIfAddress!=\"\") do={\r\n:local PingResult1 [/ping \$PingTarget1 count=\$PingCount interface=\$RsrvIf]\r\n\r\n:local PingResult2 [/ping \$PingTarget2 count=\$PingCount interface=\$RsrvIf]\r\n:local PingResult3 [/ping \$PingTarget3 count=\$PingCount interface=\$RsrvIf]\r\n\r\n:set RsrvIfInetOk ((\$PingResult1 + \$PingResult2 + \$PingResult3) &gt;=(2 * \$PingCount))\r\n}\r\n\r\n:put \"MainIfInetOk=\$MainIfInetOk\"\r\n:put \"RsrvIfInetOk=\$RsrvIfInetOk\"\r\n\r\nif (!\$MainIfInetOk) do={\r\n/log error \"Main internet connection error\"\r\n}\r\n\r\nif (!\$RsrvIfInetOk) do={\r\n/log error \"Reserve internet connection error\"\r\n}\r\n\r\n:local MainGWDistance [/ip route get [find comment~\"MainGW\"] distance]\r\n:local RsrvGWDistance [/ip route get [find comment~\"RsrvGW\"] distance]\r\n:put \"MainGWDistance=\$MainGWDistance\"\r\n:put \"RsrvGWDistance=\$RsrvGWDistance\"\r\n\r\n#SetUp gateways\r\nif (\$MainIfInetOk &amp;&amp; (\$MainGWDistance &gt;= \$RsrvGWDistance)) do={\r\n/ip route set [find comment~\"MainGW\"] distance=1\r\n/ip route set [find comment~\"RsrvGW\"] distance=2\r\n/log info \"Switch to main internet connection\"\r\n}\r\n\r\nif (!\$MainIfInetOk &amp;&amp; \$RsrvIfInetOk &amp;&amp; (\$MainGWDistance &lt;= \$RsrvGWDistance)) do={\r\n/ip route set [find comment~\"MainGW\"] distance=2\r\n/ip route set [find comment~\"RsrvGW\"] distance=1\r\n/log warning \"Switch to reserve internet connection\"\r\n}"</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">run SetGlobalParameters</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/system scheduler</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=SetGlobalParameters start-time=startup on-event=SetGlobalParameters</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=DefineMainIfIp interval=00:00:27 on-event=DefineMainIfIp</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=DefineReservedIfIp interval=00:00:27 on-event=DefineReservedIfIp</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">add name=ConnectionCheck interval=00:01:00 on-event=ConnectionCheck</span><br /><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"><br /></span></div><br />
