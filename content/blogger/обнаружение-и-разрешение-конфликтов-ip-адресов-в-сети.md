+++
title = "Обнаружение и разрешение конфликтов IP адресов в сети"
date = 2011-03-22T23:36:00Z
updated = 2011-03-22T23:36:42Z
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Снова отсюда:&nbsp;<a href="http://vpodans.spaces.live.com/blog/cns!BB1419A2CFC1E008!138.entry">http://vpodans.spaces.live.com/blog/cns!BB1419A2CFC1E008!138.entry</a><br /><br /><a name='more'></a><span class="Apple-style-span" style="color: #444444; font-family: Verdana, Geneva, Arial, sans-serif; font-size: 13px; line-height: 17px;"><div style="line-height: 17px; margin-bottom: 1.35em; margin-left: 0px; margin-right: 0px; margin-top: 0px;">Единственная вещь, которая отвечает за&nbsp;контроль&nbsp;дублирования адресов в сети - протокол преобразования адресов&nbsp;<strong style="font-weight: bold; line-height: 17px;"><a href="http://www.faqs.org/rfcs/rfc826.html" style="color: #0066a7; cursor: pointer; font-weight: inherit; line-height: 17px; text-decoration: none;" target="_blank">ARP</a></strong>. В общем смысле картина выглядит так:</div><div style="line-height: 17px; margin-bottom: 1.35em; margin-left: 0px; margin-right: 0px; margin-top: 0px;">Узел&nbsp;<strong style="font-weight: bold; line-height: 17px;">A</strong>&nbsp;при получении нового IP-адреса отправляет специальный броадкаст&nbsp;<i style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">Gratuitous</strong></i>&nbsp;<em style="line-height: 17px;">(добровольный)</em>&nbsp;ARP-запрос. Запрос представляет собой ARP-запрос для собственного IP адреса, в котором поле&nbsp;<em style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">SPA</strong>&nbsp;(Source Protocol Address или IP адрес отправителя)</em>&nbsp;и&nbsp;<em style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">TPA</strong>&nbsp;(Target Protocol Address или IP адрес получателя)</em>&nbsp;содержит собственный адрес. Если ответ на запрос получен, то это означает, что в сети есть дублирующийся адрес. Если ответ не был получен, то, соответственно, можно считать, что данный адрес в сети уникальный. С отстутсвием ответа всё понятно как бы, "нет ножек, нет и мультиков"(c)точка. Гораздо интересней ситуация происходит при получении ответа на такой запрос. Что же происходит в сети в таком случае?<br style="line-height: 17px;" />Узел, который отправляет в сеть&nbsp;<i style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">Gratuitous</strong></i>&nbsp;запрос становится т.н.&nbsp;<i style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">Атакующим узлом (Offening Node)</strong></i>, а узел, который ответил на этот запрос становится т.н.&nbsp;<i style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">Атакуемым узлом (Defending Node)</strong></i>. Что происходит на каждом из узлов в процессе обнаружения конфликта:</div><ul style="line-height: 17px; list-style-type: disc; margin-bottom: 20px; margin-left: 1em; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 1em; padding-right: 0px; padding-top: 0px;"><li style="line-height: 17px; margin-bottom: 3px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><strong style="font-weight: bold; line-height: 17px;">на Атакующем узле</strong>. Если адрес настраивается вручную, то при получении ответа на&nbsp;<i style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">Gratuitous</strong></i>&nbsp;запрос инициализация адреса сбрасывается (т.е. узел не присвоит интерфейсу конфликтующий адрес). Об этом будет записано в системном журнале, ну и на экране появится ошибка. Если же адрес настраивается через&nbsp;<strong style="font-weight: bold; line-height: 17px;"><a href="http://www.faqs.org/rfcs/rfc2131.html" style="color: #0066a7; cursor: pointer; font-weight: inherit; line-height: 17px; text-decoration: none;" target="_blank">DHCP</a></strong>, то клиент проверяет на конфликт адрес, который клиент получил от DHCP-сервера в пакете&nbsp;<em style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">DHCPOFFER</strong></em>. Если адрес из&nbsp;<em style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">DHCPOFFER</strong></em>&nbsp;является дублирующим (не уникальным), то клиент получив ответ на&nbsp;<em style="line-height: 17px;">Gratuitous</em>&nbsp;запрос отправит DHCP-серверу пакет&nbsp;<em style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">DHCPDECLINE</strong></em>. Этот адрес в зависимости от реализации DHCP-сервера может помечаться как неисправный и будет удалён из пла свободных адресов. Клиент будет снова пробовать получить IP-адрес от DHCP-сервера отправкой в сеть пакета&nbsp;<em style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">DHCPDISCOVER</strong></em>.</li><li style="line-height: 17px; margin-bottom: 3px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><strong style="font-weight: bold; line-height: 17px;">на Атакуемом узле</strong>. Атакуемый узел определят конфликт очень просто - если поле&nbsp;<strong style="font-weight: bold; line-height: 17px;">SPA</strong>&nbsp;(Source Protocol Address или IP адрес отправителя), то узел констатирует конфликт. Этот факт будет так же зарегистрирован в журнале событий и пользователю будет выдана ошибка.&nbsp;<u style="line-height: 17px;">При этом, атакуемый узел не сбросит с себя конфликтный IP-адрес</u>&nbsp;(что сделает Атакующий узел).</li></ul><div style="line-height: 17px; margin-bottom: 1.35em; margin-left: 0px; margin-right: 0px; margin-top: 0px;">Когда конфликт констатирован, начинает работать механизм разрешения конфликта. Суть проблемы конфликта заключается в следующем:<br style="line-height: 17px;" />После отправки добровольного запроса по правилу работы ARP-протокола остальные клиенты сегмента обновят свои записи в ARP кэше&nbsp;со схемы: [<span style="color: green; line-height: normal;"><strong style="font-weight: bold; line-height: 17px;">Конфликтующий адрес:MAC атакуемого узла</strong></span>] (т.к. до этого момента IP-адрес атакуемого узла был уникален) будет заменён на схему: [<strong style="font-weight: bold; line-height: 17px;"><span style="color: green; line-height: normal;">Конфликтующий IP адрес:MAC атакующего узла</span></strong>]. Если атакуемый узел будет являться шлюзом по умолчанию, то все внешние запросы (которые идут на шлюз) будут перенаправлены с шлюза на атакующий узел (который проводит проверку своего адреса и на самом деле не является шлюзом). В такой ситуации сегмент потеряет связь с внешним миром, т.к. после запроса все машины перепишут новый MAC для шлюза.&nbsp;<u style="line-height: 17px;">Однако, ARP ответ атакуемого узла на добровольный запрос не обновляет/исправляет ошибочные записи в ARP кэшах остальных машин в сегменте</u>. Для этого атакуемый узел отправляет в сеть другой широкополосный ARP-запрос, как бы он сам проверял свой адрес на конфликт (атакуемый и атакующий узел меняются ролями). Этим запросом атакуемый узел обратно исправляет записи в кэшах ARP остальных машин в сегменте на правильные значения (ведь, атакующий узел не может использовать конфликтный IP). Но на этот запрос уже атакуемый (до этого он был атакующим) уже никто не ответит, т.к. изначально Атакующий узел к этому времени снимет с себя конфликтный IP-адрес.<br style="line-height: 17px;" />В итоге мы получаем картину из последовательного обмена тремя кадрами. Для наглядности привожу трассировку с Network Monitor:</div><ol style="line-height: 17px;"><li style="line-height: 17px; margin-bottom: 3px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><strong style="font-weight: bold; line-height: 17px;">добровольный запрос атакующего узла:</strong><br style="line-height: 17px;" />&nbsp;<span style="color: blue; line-height: normal;">&nbsp;Frame:&nbsp;<br style="line-height: 17px;" />- Ethernet: Etype = ARP<br style="line-height: 17px;" />&nbsp; + DestinationAddress: *BROADCAST<br style="line-height: 17px;" />&nbsp; + SourceAddress: Microsoft Corporation 55578E<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; EthernetType: ARP, 2054(0x806)<br style="line-height: 17px;" />- Arp: Request, 192.168.1.13 asks for 192.168.1.13<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; HardwareType: Ethernet<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; ProtocolType: Internet IP (IPv4)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; HardwareAddressLen: 6 (0x6)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; ProtocolAddressLen: 4 (0x4)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; OpCode: Request, 1(0x1)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: red; line-height: normal;">SendersMacAddress: 00-03-FF-55-57-8E<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; SendersIp4Address: 192.168.1.13<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; TargetMacAddress: 00-00-00-00-00-00<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; TargetIp4Address: 192.168.1.13</span></li><li style="line-height: 17px; margin-bottom: 3px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><strong style="font-weight: bold; line-height: 17px;">ответ атакуемого узла на добровольный запрос:</strong>&nbsp;<span style="color: blue; line-height: normal;">&nbsp;Frame:&nbsp;<br style="line-height: 17px;" />- Ethernet: Etype = ARP<br style="line-height: 17px;" />&nbsp; + DestinationAddress: *BROADCAST<br style="line-height: 17px;" />&nbsp; + SourceAddress: Intel Corporation 54578E<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; EthernetType: ARP, 2054(0x806)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; UnkownData: Binary Large Object (18 Bytes)<br style="line-height: 17px;" />- Arp: Response, 192.168.1.13 at 00-18-DE-54-57-8E<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; HardwareType: Ethernet<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; ProtocolType: Internet IP (IPv4)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; HardwareAddressLen: 6 (0x6)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; ProtocolAddressLen: 4 (0x4)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; OpCode: Response, 2(0x2)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: red; line-height: normal;">SendersMacAddress: 00-18-DE-54-57-8E<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; SendersIp4Address: 192.168.1.13<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; TargetMacAddress: 00-00-00-00-00-00<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; TargetIp4Address: 0.0.0.0</span></li><li style="line-height: 17px; margin-bottom: 3px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><strong style="font-weight: bold; line-height: 17px;">добровольный запрос уже атакуемого узла:</strong><br style="line-height: 17px;" />&nbsp;&nbsp;<span style="color: blue; line-height: normal;">Frame:&nbsp;<br style="line-height: 17px;" />- Ethernet: Etype = ARP<br style="line-height: 17px;" />&nbsp; + DestinationAddress: *BROADCAST<br style="line-height: 17px;" />&nbsp; + SourceAddress: Intel Corporation 54578E<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; EthernetType: ARP, 2054(0x806)<br style="line-height: 17px;" />- Arp: Request, 192.168.1.13 asks for 192.168.1.13<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; HardwareType: Ethernet<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; ProtocolType: Internet IP (IPv4)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; HardwareAddressLen: 6 (0x6)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; ProtocolAddressLen: 4 (0x4)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; OpCode: Request, 1(0x1)<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: red; line-height: normal;">SendersMacAddress: 00-18-DE-54-57-8E<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; SendersIp4Address: 192.168.1.13<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; TargetMacAddress: 00-00-00-00-00-00<br style="line-height: 17px;" />&nbsp;&nbsp;&nbsp; TargetIp4Address: 192.168.1.13</span></li></ol><div style="line-height: 17px; margin-bottom: 1.35em; margin-left: 0px; margin-right: 0px; margin-top: 0px;">Небольшое пояснение к трассировке: MAC=00-03-FF-55-57-8E - это MAC-адрес атакующего узла, который пытается присвоить себе конфликтный адрес (192.168.1.13). MAC=00-18-DE-54-57-8E - это MAC-адрес атакуемого узла, который уже находится в сети и ему присвоен конфликтный адрес (192.168.1.13).<br style="line-height: 17px;" />Последним кадром заново переписываются таблицы ARP-кэшей остальных узлов в сегменте на правильные значения.<br style="line-height: 17px;" />Однако, хочу добавить, что обмен&nbsp;<i style="line-height: 17px;"><strong style="font-weight: bold; line-height: 17px;">Gratuitous-</strong></i>запросами и ответами происходит только при инициализации адреса. Если, например, узел будет сконфигурирован на конфликтный адрес до подключения узла в сеть, то после включения узла с конфликтным адресом обмен такими добровольными запросами-ответами происходить не будет. Поэтому оба узла будут продолжать использовать один конфликтный адрес, но при каждом ARP запросе оба узла будут генерировать ошибки о конфликте адресов.</div></span>
