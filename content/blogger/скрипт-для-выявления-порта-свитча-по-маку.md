+++
title = "Скрипт для выявления порта свитча по маку"
date = 2015-02-25T03:40:00Z
updated = 2015-02-25T03:40:55Z
tags = ["MAC-Port", "PowerShell", "коммутатор", "коммутация", "скрипт"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Имеем сеть с кучей управляемых свитчей, подключенных к одному корневому и друг к другу с включенным STP. Необходимо найти порт, к которому подключено устройство с известным нам MAC-адресом. Бегать по web-интерфейсам свитчей крайне напряжно, если маков больше 5. <br /><a name='more'></a>Я использую систему мониторинга The Dude, которая умеет обходить устройства по SNMP и вываливать необходимую инфу в csv. Поэтому с каждого свитча сливаем в csv таблицу FDB. Получаем подобное:<br /><span style="font-family: Courier New, Courier, monospace;">Flag,MAC,Port,Status</span><br /><span style="font-family: Courier New, Courier, monospace;">,00:03:0F:18:F1:6A,D-Link DGS-3120-48TC R3.10.B01 Port 43 on Unit 1 (43),learned</span><br /><span style="font-family: Courier New, Courier, monospace;">,00:0B:82:3E:27:C6,D-Link DGS-3120-48TC R3.10.B01 Port 2 on Unit 1 (2),learned</span><br /><span style="font-family: Courier New, Courier, monospace;">,00:0B:82:3E:27:C9,D-Link DGS-3120-48TC R3.10.B01 Port 10 on Unit 2 (74),learned</span><br /><span style="font-family: Courier New, Courier, monospace;">,00:0C:29:BD:81:53,D-Link DGS-3120-48TC R3.10.B01 Port 5 on Unit 1 (5),learned</span><br /><span style="font-family: Courier New, Courier, monospace;">,00:11:BE:00:0F:34,D-Link DGS-3120-48TC R3.10.B01 Port 13 on Unit 1 (13),learned</span><br /><br />У меня один корневой свитч (его FDB я обозвал FDB21.csv) и несколько коммутаторов на уровне доступа (все остальные .csv). Я знаю к каким портам корневого подключены остальные коммутаторы. Писал на PowerShell, так как считаю его довольно удобным и мощным и хочу научиться использовать его. Собственно скрипт:<br /><br /><span style="font-family: Courier New, Courier, monospace;">$path = "d:\scripts\FDB\"</span><br /><span style="font-family: Courier New, Courier, monospace;">$rootDB = "FDB21.csv"</span><br /><span style="font-family: Courier New, Courier, monospace;">$sport = ("D-Link DGS-3120-48TC R3.10.B01 Port 1 on Unit 1 (1)", "D-Link DGS-3120-48TC R3.10.B01 Port 2 on Unit 1 (2)", "D-Link DGS-3120-48TC R3.10.B01 Port 5 on Unit 1 (1)", "D-Link DGS-3120-48TC R3.10.B01 Port 12 on Unit 1 (12)", "D-Link DGS-3120-48TC R3.10.B01 Port 13 on Unit 1 (13)", "D-Link DGS-3120-48TC R3.10.B01 Port 14 on Unit 1 (14)", "D-Link DGS-3120-48TC R3.10.B01 Port 43 on Unit 1 (43)", "D-Link DGS-3120-48TC R3.10.B01 Port 44 on Unit 1 (44)", "D-Link DGS-3120-48TC R3.10.B01 Port 1 on Unit 2 (65)", "D-Link DGS-3120-48TC R3.10.B01 Port 2 on Unit 2 (66)", "D-Link DGS-3120-48TC R3.10.B01 Port 10 on Unit 2 (74)", "D-Link DGS-3120-48TC R3.10.B01 Port 43 on Unit 2 (107)")</span><br /><span style="font-family: Courier New, Courier, monospace;">$swDB = ("FDB42.csv", "FDB44.csv", "FDB61.csv", "FDB52.csv", "FDB51.csv", "FDB12.csv", "FDB33.csv", "FDB32.csv", "FDB41.csv", "FDB43.csv", "FDB11.csv", "FDB34.csv")</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">function findinarr ($array, $value) {</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; for ($i=0; $i -lt $array.count;$i++) {&nbsp;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; if($array[$i] -eq $value){$i}</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; }</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">$dataRoot = Import-CSV -path $path$rootDB | Select-Object MAC, Port</span><br /><span style="font-family: Courier New, Courier, monospace;">$mac = Read-Host "Enter MAC"</span><br /><span style="font-family: Courier New, Courier, monospace;">foreach ($S in $dataRoot)</span><br /><span style="font-family: Courier New, Courier, monospace;">{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>if ($mac -eq $s.mac)</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>$portRoot = $s.port</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>}</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">$A = findinarr $sport $portRoot</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">$datasw = Import-CSV -path $path$swDB[$A] | Select-Object MAC, Port</span><br /><span style="font-family: Courier New, Courier, monospace;">foreach ($S in $datasw)</span><br /><span style="font-family: Courier New, Courier, monospace;">{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>if ($mac -eq $s.mac)</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>$port = $s.port</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>}</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;">Write-Host $mac on $port</span><br /><div><br /></div><div>Разбор по строкам:</div><div>$path = "d:\scripts\FDB\" - указываем путь к папке с .csv</div><div><br /></div><div>$rootDB = "FDB21.csv" - FDB с корневого коммутатора. По нему ищем с самого начала и на основе найденного порта переходим к следующему коммутатору.</div><div><br /></div><div>$sport - строковый массив из названий портов в csv.</div><div><br /></div><div>$swDB - массив из названий файлов, содержащих информацию о соответствии MAC-порт. <b>Массивы sport и swDB должны иметь однозначное соответствие!</b> В моем случае к&nbsp;Port 1 on Unit 1 подключен коммутатор sw42, следовательно, если нашли MAC на первом порту первого юнита, то дальше будем искать в файле FDB42.csv, где находится база sw42. И так далее.</div><div><br /></div><div>function findinarr позаимствована у <a href="http://www.sysadmins.lv/PermaLink,guid,f388c990-e016-4585-8926-dbf2b70ac187.aspx">Вадима Поданса</a>, который в свою очередь позаимствовал её у <a href="https://xaegr.wordpress.com/">Василия Гусева</a>. Это матерые пауэршэльщики, советую почитать их блоги. Функция находит индекс искомого элемента в массиве.</div><div><br /></div><div>В переменную&nbsp;$dataRoot считываем csv с корневого коммутатора. Причем забираем только параметры MAC и Port - остальные нас не интересуют.</div><div><br /></div><div>$mac = Read-Host "Enter MAC" - вводим искомый мак.</div><div><br /></div><div>foreach ($S in $dataRoot) - ищем в массиве MAC-Port наш MAC-адрес. Если находим, то запоминаем порт.</div><div><br /></div><div>$A = findinarr $sport $portRoot - ищем индекс найденного порта в массиве sport.</div><div><br /></div><div>$datasw = Import-CSV -path $path$swDB[$A] | Select-Object MAC, Port - полученный в предыдущем шаге индекс подставляем в swDB и находим в нем имя следующего обрабатываемого файла. Этот файл считываем в переменную datasw, которую далее обрабатываем точно так же, как и dataRoot.</div><div><br /></div><div><br /></div><div>Не претендую на правильность скрипта, но у меня оно работает. Написал за неполный рабочий день будучи полнейшим нулем в PowerShell и 0,1 в программировании. Теперь нужно избавиться от csv и прикрутить опрос свитчей по SNMP прямо из скрипта.</div>
