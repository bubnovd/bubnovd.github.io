+++
title = "Запрет сайтов в Mikrotik"
date = 2015-12-13T20:28:00Z
updated = 2015-12-13T20:28:35Z
draft = true
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Часто возникает задача запретить посещение определенного списка сайтов, например, социальных сетей. Казалось бы, проблемы нет - запрещай трафик на http порт определенного айпишника, но потом оказывается, что многие сайты имеют далеко не один сервер, да ещё и кучу поддоменов, которые тоже необходимо фильтровать. И тут-то возникают различные нетривиальные решения.<br />&nbsp;В этом посте мы сможем фильтровать весь трафик на определенные домены и их поддомены, включая шифрованный https трафик.<br /><br /><br /><a name='more'></a>Сначала мне пришла в голову идея перенаправлять все DNS-запросы от клиентов на Mikrotik, тем самым вычисляя поддомены и блокировать передачу определенных DNS-ответов, а заодно и фильтровать нужные домены фаерволом. Но в ходе написания скрипта возникли некоторые вопросы, и я наткнулся на <a href="http://habrahabr.ru/post/242143/" target="_blank">хабр</a>, в котором разбиралась нужная мне задача.<br />Что выполняет данный скрипт? Он резолвит заданные имена на DNS-серверах, заданных в Mikrotik и добавляет их в адрес-лист. Не буду подробно описывать его работу - всё уже написано в оригинальной статье. Я лишь убрал строку удаления адрес-листов.<br /><br /><span style="color: #333333; font-family: &quot;menlo&quot; , &quot;monaco&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;">:local DNSList {"goog";"yandex";"ggpht";"youtube";"whatbrowser";"gmodules";"466453";"ytimg";"youtu";"waze";"urchin";"sketchup";"picasa";"panoramio";"madewithcode";"keyhole";"gmail";"froogle";"foofle";"doubleclick";"feedburner";"cobrasearch";"chrome";"chromium";"blogspot";"blogger";"adwords";"android";"adsense";"admob";"gstatic";"yastatic"} :local ListName "blocksites" :local DNSServers ( [ip dns get dynamic-servers], [ip dns get servers ], 8.8.8.8 )  /ip dns cache all  :foreach i in=[find type="A"] do={     :local bNew true     :local cacheName [get $i name]     :local match false     :foreach addr in=$DNSList do={        :if (:typeof [:find $cacheName $addr] &gt;= 0) do={            :set $match true        }     }        :if ( $match ) do={         :local tmpAddress [/ip dns cache get $i address]         :if ( [/ip firewall address-list find ] = "") do={             :log debug ("added entry: $[/ip dns cache get $i name] IP $tmpAddress")             /ip firewall address-list add address=$tmpAddress list=$ListName comment=$cacheName         } else={             :foreach j in=[/ip firewall address-list find ] do={                 :if ( [/ip firewall address-list get $j address] = $tmpAddress ) do={                     :set bNew false                 }             }             :if ( $bNew ) do={                 :log debug ("added entry: $[/ip dns cache get $i name] IP $tmpAddress")                 /ip firewall address-list add address=$tmpAddress list=$ListName comment=$cacheName             }         }     } }</span></span><br /><span style="color: #333333; font-family: &quot;menlo&quot; , &quot;monaco&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;"><br /></span></span><span style="color: #333333; font-family: &quot;menlo&quot; , &quot;monaco&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;"><br /></span></span><span style="color: #333333; font-family: &quot;menlo&quot; , &quot;monaco&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;"><span style="font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 22.4px; white-space: pre-wrap;">Приведенный скрипт добавляет запрещенные адреса в блок лист. Но первое соединение все равно будет происходить, т.к. соединение может произойти раньше, чем выполнится скрипт. Значит, нам нужно ещё и блокировать доставку контента со стоп словами на клиента. Это можно реализовать с помощью L7-protocols.</span></span></span><br /><span style="color: #333333; font-family: &quot;menlo&quot; , &quot;monaco&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;"><span style="font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 22.4px; white-space: pre-wrap;"> </span><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;"><span style="font-family: Courier New, Courier, monospace;">/ip firewall layer7-protocol add name=black_dns regexp=mail|ya</span><span style="font-family: Arial, Helvetica, sans-serif;"></span></span></span></span><span style="color: #333333; font-family: &quot;menlo&quot; , &quot;monaco&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;"><br /></span></span><br /><span style="color: #333333; font-family: menlo, monaco, courier new, monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;">/ip firewall filter</span></span><br /><span style="color: #333333; font-family: menlo, monaco, courier new, monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;">add action=drop chain=forward dst-address=192.168.32.84 layer7-protocol=\</span></span><br /><span style="color: #333333; font-family: &quot;menlo&quot; , &quot;monaco&quot; , &quot;courier new&quot; , monospace;"><span style="color: #333333; font-family: menlo, monaco, courier new, monospace; font-size: 12px; line-height: 22.4px; white-space: pre-wrap;"></span></span><br /><span style="color: #333333; font-family: menlo, monaco, courier new, monospace;"><span style="font-size: 12px; line-height: 22.4px; white-space: pre-wrap;">&nbsp; &nbsp; black_dns protocol=udp src-port=53</span></span><br /><div><br /></div>
