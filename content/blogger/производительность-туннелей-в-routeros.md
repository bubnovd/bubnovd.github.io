+++
title = "Производительность туннелей в RouterOS"
date = 2015-08-20T06:01:00Z
updated = 2015-08-23T21:53:06Z
tags = ["VPN", "openvpn", "гигабит", "l2tp", "производительность", "ipip", "ipsec", "gre", "стабильность", "routeros", "Mikrotik", "PPTP", "sstp", "eoip", "Gbps"]
draft = true
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

<br /><div><div>Имеем два CCR1009-8G-1S-1S+ с RouterOS 6.30.2 на борту. На обеих сторонах включен FastPath. Первый Mikrotik имеет выход в мир через sfp со скоростью 1Gbps, его будем называть сервером. Второй - клиент - &nbsp;имеет выход в мир через два gigabit ethernet интерфейса, завернутых в бондинг для отказоустойчивости.<br /><br /><a name='more'></a><br /></div><div>Параметры интерфейсов следующие:&nbsp;</div><div>1. Сервер.&nbsp;</div><div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp;</span><span style="font-family: Courier New, Courier, monospace;"> name="sfp1" default-name="sfp1" mtu=1500 l2mtu=1580&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; mac-address=4C:5E:0C:AA:AA:AA orig-mac-address=4C:5E:0C:AA:AA:AA&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; arp=enabled auto-negotiation=yes advertise=10M-full,100M-full,1000M-full&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; full-duplex=yes tx-flow-control=off rx-flow-control=off speed=1Gbps&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; master-port=none bandwidth=unlimited/unlimited sfp-rate-select=high</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span></div></div><div>2. Клиент.</div><div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; name="ether7" default-name="ether7" mtu=1500 l2mtu=1580&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; mac-address=E4:8D:8C:BB:BB:BB orig-mac-address=E4:8D:8C:BB:BB:BB&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; arp=enabled auto-negotiation=yes advertise=10M-full,100M-full,1000M-full&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; full-duplex=yes tx-flow-control=off rx-flow-control=off speed=100Mbps&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; master-port=none bandwidth=unlimited/unlimited&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp;</span><span style="font-family: Courier New, Courier, monospace;"> name="ether8" default-name="ether8" mtu=1500 l2mtu=1580&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; mac-address=E4:8D:8C:CC:CC:CC orig-mac-address=E4:8D:8C:CC:CC:CC&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; arp=enabled auto-negotiation=yes advertise=10M-full,100M-full,1000M-full&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; full-duplex=yes tx-flow-control=off rx-flow-control=off speed=100Mbps&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; master-port=none bandwidth=unlimited/unlimited&nbsp;</span></div></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; name="bonding-inet" mtu=1500 mac-address=E4:8D:8C:BB:BB:BB arp=enabled&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; slaves=ether7,ether8 mode=802.3ad primary=none link-monitoring=mii&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; arp-interval=100ms arp-ip-targets="" mii-interval=100ms down-delay=0ms&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; up-delay=0ms lacp-rate=30secs transmit-hash-policy=layer-2&nbsp;</span></div></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Тестирование проводится встроенным Bandwidth Test Mikrotik'a по протоколу TCP в обе стороны (transmit, recieve). Длительность тестирования - 2 минуты. Проверяем загрузку процессора и памяти с обеих сторон. Графики привожу с микротика-клиента.</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Тест №1. PPTP с шифрованием MPPE128, без сжатия. MTU на туннелях 1450, аутентификация MSCHAP2, change TCP MSS to 1410.</span></div><div><span style="font-family: inherit;">Туннель не падал. Общая загрузка CPU низкая, одно ядро постоянно загружено на 100%, средняя скорость - 75 Mbps. По загрузка CPU сервера видим такую же картину - 1 ядро на 100%.&nbsp;</span>Потерь пакетов нет.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-clOrbfGTZAQ/VdWwtb5vvtI/AAAAAAAAAl8/wNyr-tdytY8/s1600/pptp_encr.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="355" src="http://3.bp.blogspot.com/-clOrbfGTZAQ/VdWwtb5vvtI/AAAAAAAAAl8/wNyr-tdytY8/s400/pptp_encr.JPG" width="400" /></a></div></div><div class="separator" style="clear: both; text-align: center;"></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">Тест №2.&nbsp;</span>PPTP без шифрования, без сжатия. MTU на туннелях 1450, аутентификация MSCHAP2, change TCP MSS to 1410.</div><div>Туннель не падал. Общая загрузка CPU низкая,&nbsp;одно ядро постоянно загружено на 100%, средняя скорость - 120 Mbps. Нагрузка на CPU сервера такая же. Потерь пакетов нет.</div><div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-QKRPXYckaLs/VdWwLcdeEbI/AAAAAAAAAl0/VLU2OSbeXEA/s1600/pptp_noencr.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="381" src="http://1.bp.blogspot.com/-QKRPXYckaLs/VdWwLcdeEbI/AAAAAAAAAl0/VLU2OSbeXEA/s400/pptp_noencr.JPG" width="400" /></a></div></div><div class="separator" style="clear: both; text-align: center;"></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;"><br /></span></div><div>Тест №3.&nbsp;PPTP без шифрования, со сжатием. MTU на туннелях 1450, аутентификация MSCHAP2, change TCP MSS to 1410. При активации профиля со сжатием на клиенте или сервере наблюдаем kernel panic и перезагрузку роутера.</div></div><div><br /></div><div><br /></div><div>Тест №4. GRE.&nbsp;</div><div>Туннель не падал.&nbsp;Общая загрузка CPU низкая,&nbsp;одно ядро постоянно загружено на 100%,&nbsp;&nbsp;средняя скорость - 130 Mbps. Нагрузка на CPU сервера такая же.&nbsp;Потерь пакетов нет.</div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-DRC4K5lWDKM/VdWxlOAvdlI/AAAAAAAAAmQ/lQXFhFexxS8/s1600/gre.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="397" src="http://1.bp.blogspot.com/-DRC4K5lWDKM/VdWxlOAvdlI/AAAAAAAAAmQ/lQXFhFexxS8/s400/gre.JPG" width="400" /></a></div><div><br /></div><div><br /></div><div><div>Тест №4. GRE с шифрованием IPSec. IPSec включен "простым способом" - банальным вводом ключа в параметр туннеля GRE.</div><div>Туннель не падал. Загрузка CPU низкая, средняя скорость - 30 Mbps. Нагрузка на CPU сервера такая же - 1 ядро в полку. Потерь пакетов нет.</div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-f3o36prZ-oo/VdWydO726SI/AAAAAAAAAmY/WGcH1A1zBMc/s1600/gre_ipsec.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="370" src="http://1.bp.blogspot.com/-f3o36prZ-oo/VdWydO726SI/AAAAAAAAAmY/WGcH1A1zBMc/s400/gre_ipsec.JPG" width="400" /></a></div><div><br /></div><div><br /></div><div>Тест №5. IP-IP туннель без шифрования. Картина с CPU не меняется - одно ядро до сих пор в полке.&nbsp;</div><div>Скорость около 140 Mbps. Надо заметить, что тестирование скорости делаем в обе стороны, что не всегда нужно. При потоке в одну сторону замеренную скорость можно смело увеличивать вдвое.</div><div>Дальнейшие тесты буду проводить только на нешифрованных туннелях, так как видим, что производительность процессора не дает нам желаемой скорости даже без шифрования.</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-zfKnngScO7c/VdWz3Pzb4UI/AAAAAAAAAmk/tpurio0aOOc/s1600/ip-ip.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="397" src="http://1.bp.blogspot.com/-zfKnngScO7c/VdWz3Pzb4UI/AAAAAAAAAmk/tpurio0aOOc/s400/ip-ip.JPG" width="400" /></a></div><div><br /></div><div>Тест №6. EoIP туннель без шифрования.&nbsp;</div><div>Одно ядро загружено полностью на обеих сторонах. Скорость - 130 Mbps с прыжками до 170. В одну сторону сервер-клиент (тест с клиента на receive) производительность держится на уровне 300-330 Mbps. На обеих сторонах одно ядро работает на полную.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-Nw314tH-Cqw/VdW2wLrl7dI/AAAAAAAAAmw/BZ1mHTBQMV8/s1600/eoip.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="391" src="http://4.bp.blogspot.com/-Nw314tH-Cqw/VdW2wLrl7dI/AAAAAAAAAmw/BZ1mHTBQMV8/s400/eoip.JPG" width="400" /></a></div><div><br /><br /><br />Для чистоты эксперимента проведем ещё несколько тестов.<br />Тест №7. OpenVPN. Аутентификация md5, шифрование aes128. Шифрование выбрано таким, т.к. оно достаточно надежное и самое нетребовательное к ресурсам. Тип туннеля - ip. OpenVPN работает на userspace, поэтому сразу скажу - скорости здесь будут черепашьи, по сравнению с остальными, т.к. нагрузка ложится не на ядро системы, а на дополнительные модули, приоритет работы которых ниже, чем ядра.<br />Одно ядро сразу встало в полку. Производительность - 20 Mbps.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-CWG9Xq0rOWk/VdamTBVwQsI/AAAAAAAAAnE/uDibNjWTaAE/s1600/ovpn.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="315" src="http://4.bp.blogspot.com/-CWG9Xq0rOWk/VdamTBVwQsI/AAAAAAAAAnE/uDibNjWTaAE/s400/ovpn.JPG" width="400" /></a></div><br /><br />Тест №8. OpenVPN. Аутентификация md5, без шифрования.<br />Ситуация немногим лучше приведенной выше. Скорость 35 Mbps.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-RHqvTrv_Nlo/Vdam3qm6FAI/AAAAAAAAAnM/M70Yd9FiOnk/s1600/ovpn_null.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="325" src="http://3.bp.blogspot.com/-RHqvTrv_Nlo/Vdam3qm6FAI/AAAAAAAAAnM/M70Yd9FiOnk/s400/ovpn_null.JPG" width="400" /></a></div><br /><br /></div><div>Тест №9. SSTP. Аутентификация MSCHAP2. Шифрование AES-256.<br />Тут всё очень плохо. Даже при небольшой нагрузке туннель рвется. Работает 20-30 секунд, скорость доходит до 5, максимум 10 Mbps, нагрузка на одно из ядер максимальна и туннель падает. Возможно, это связано с тем, что я не учел какого-то параметра.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-dJ8yAavNv40/Vdaorg68NRI/AAAAAAAAAnY/ngGVlEaCXJU/s1600/sstp.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="326" src="http://2.bp.blogspot.com/-dJ8yAavNv40/Vdaorg68NRI/AAAAAAAAAnY/ngGVlEaCXJU/s400/sstp.JPG" width="400" /></a></div><br /><br /><br /></div><div>Дальнейшие эксперименты с одним туннелем бессмысленны, т.к. видим, что производительности 1,2 ГГц 8-ядерного процессора tile в CCR1009 не хватает для обеспечения скорости выше 300-350 Mbps в одну сторону. Нужно пытаться распараллелить нагрузку между ядрами. Для этого выберем самый производительный из вышеприведенных туннелей и попробуем создать несколько таких туннелей и посмотреть, насколько RouterOS умеет их параллелить.</div><div><br /></div><div><br /></div><div>Дальнейшее тестирование проводилось на таком же оборудовании с той же версией ПО.<br /><br />С использованием ppp-bridge скорость при нешифрованном pptp составляет до 400 Mbps. С шифрованным - 150 Mbps.<br /><br /></div><div>Пока самое производительное, измеренное iperf'ом с двух хостов по разные стороны микротиков &nbsp;- чистый GRE. Дает 250 Mbps</div><div><br /></div><div><b><i>Продолжение следует.....</i></b></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div>
