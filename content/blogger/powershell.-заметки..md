+++
title = "PowerShell. Заметки."
date = 2013-06-11T20:32:00Z
updated = 2013-06-17T23:46:35Z
tags = ["PowerShell", "MS", "Автоматизация", "скрипт"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Начал использовать PowerShell. Инструмент очень мощный. По мощности сравним с шеллом никсов. Не буду утверждать что круче - не разбираюсь ни в том, ни в другом. Решил сделать в качестве памятки несколько заметок по использованию этого инструмента.<br /><br /><h3><span style="font-weight: normal;">1.</span> Заметка номер раз. Простейшие регулярные выражения в PS.</h3>^ - начало строки<br />$ - конец строки<br />. - один любой символ<br /><br />Удалить подстроку или заменить её - -replace . Простейший способ редактирования строк без вникания в код и написания "нормальных" регэкспов - тупо удалить нужное кол-во символов.<br /><br /><i><span style="color: #990000;">&nbsp;(Get-Content .\list.txt) &nbsp;-replace "^...................................." | Set-Content list1.txt</span></i><br /><br />Получили содержание файла, прошли по строкам, в каждой строке удалили какое-то количество первых символов, записали в файл.<br /><br /><h3>2. Получить список файлов, открывавшихся определенным пользователем в определенную дату.</h3><i><span style="color: #990000;">Get-EventLog security -after (Get-Date -hour 0 -minute 0 -second 0) | ?{$_.eventid -eq 560} | ?{$_.username -eq "username"}</span></i><br /><br />Здесь мы получаем события журнала безопасности за текущую дату с 0 часов, 0 минут, 0 секунд с eventid равным 560 (аудит успеха. открытие объекта. Эта информация здесь:&nbsp;<a href="http://support.microsoft.com/kb/174074">Описание событий системы безопасности</a>) и именем пользователя username.<br />Но для того, чтобы эта команда сработала, необходимо чтобы велся аудит доступа к файловой системе. Об этом можно почитать <a href="http://how-it.ru/public/root/236-vklyuchaem_audit_dostupa_k_failam_v_windows__logi_sozdaniya__izmeneniya_i_udaleniya_failov_.html">тут</a>. Позже сам напишу подобный мануал.<br /><br />Дальше больше<br /><br /><a name='more'></a><br /><br /><h3>3. Теперь скрипт по мотивам предыдущей заметки. Назначение: получить список пользователей, пытавшихся открыть файлы на ФС. Получаем время доступа, имя файла и имя пользователя.</h3><br /><i><span style="color: #990000;">$Events = Get-EventLog security | ?{$_.eventid -eq 560}</span></i><br /><i><span style="color: #990000;">$Data = New-Object System.Management.Automation.PSObject</span></i><br /><i><span style="color: #990000;">$Data | Add-Member NoteProperty Time ($null)</span></i><br /><i><span style="color: #990000;">$Data | Add-Member NoteProperty UserName ($null)</span></i><br /><i><span style="color: #990000;">$Data | Add-Member NoteProperty File ($null)</span></i><br /><i><span style="color: #990000;"><br /></span></i><i><span style="color: #990000;">$Events | %{</span></i><br /><i><span style="color: #990000;"><br /></span></i><i><span style="color: #990000;">$Data.time = $_.TimeGenerated</span></i><br /><i><span style="color: #990000;"><br /></span></i><i><span style="color: #990000;">$message = $_.message.split("`n") | %{$_.trimstart()} | %{$_.trimend()}</span></i><br /><i><span style="color: #990000;"><br /></span></i><i><span style="color: #990000;">$Data.UserName = ($message | ?{$_ -like "Пользователь-клиент:*"} | %{$_ -replace "^.+:."} )&nbsp;</span></i><br /><i><span style="color: #990000;">$Data.File = ($message | ?{$_ -like "Имя объекта:*"} | %{$_ -replace "^.+:."})&nbsp;</span></i><br /><i><span style="color: #990000;"><br /></span></i><i><span style="color: #990000;"><br /></span></i><i><span style="color: #990000;">$data | Out-File F:\Docs\fs1.txt -Append</span></i><br /><i><span style="color: #990000;">}&nbsp;</span></i><br /><br />Разберем по строкам.<br /><br />Первая строка получает события типа "безопасность" с кодом 560 (Get-Eventlog - получить данные журнала событий, security - данные журнала "безопасность", где свойство eventid каждого (|) события ($_) эквивалентно (-eq) 560).<br /><br />Вторая строка создает объект PSObject. 3-5 строки добавляют в объект поля Time, UserName и File.<br /><br />Затем пробегаемся по событиям следующим способом.<br />В поле time объекта Data записываем время создания строки с сообщением (время доступа к файлу).<br /><br />&nbsp;Строкой&nbsp;<i><span style="color: #990000;">$message = $_.message.split("`n") | %{$_.trimstart()} | %{$_.trimend()}&nbsp;</span></i>— в переменную message заносим массив строк, которые разделяются символом переноса строки ('n), функции trimstart(), trimend() убирают все лишние символы в конце и в начале строки, функция split разделяет строку.<br /><br />Далее во вновь образовавшемся массиве мы ищем совпадения по строке «Пользователь-клиент:» и «Имя объекта:», а -replace в дальнейшем удаляет эти регулярные выражения, оставляя саму информацию.<br /><br />&nbsp;И последней строкой записываем то, что получилось в итоге в файл.<br />&nbsp;Получается что-то типа этого:<br /><span style="color: #0b5394;">Time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UserName &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;File &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><br /><span style="color: #0b5394;">---- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-------- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><br /><span style="color: #0b5394;">13.06.2013 16:52:22 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Seti &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Docs\Сети\Общая папка\Реестры счет</span><br /><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;"><br /></span><span style="color: #0b5394;">Time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UserName &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;File &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><br /><span style="color: #0b5394;">---- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-------- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><br /><span style="color: #0b5394;">13.06.2013 16:52:22 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Seti &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Docs\Сети\Общая папка\Реестры счет</span><br /><br />Скрипт создан при помощи этих постов: <a href="http://habrahabr.ru/post/118644/">хабр</a>, <a href="http://www.sysadmins.lv/PermaLink,guid,f3a9a181-0eac-45d0-8b2d-5943337d2c6a.aspx">Поданс</a>.
