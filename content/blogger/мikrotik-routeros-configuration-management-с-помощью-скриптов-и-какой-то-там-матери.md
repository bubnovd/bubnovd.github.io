+++
title = "Мikrotik RouterOS Configuration Management с помощью скриптов и какой-то там матери"
date = 2017-11-20T09:56:00Z
updated = 2017-11-20T23:37:01Z
tags = ["configuration management", "routeros", "Mikrotik", "script"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

Жизненный цикл сети часто переживает закономерный рост. В это время начинают появляться десятки и сотни устройств, конфигурация которых однотипна. Например, это могут быть маршрутизаторы в филиалах, которые имеют одинаковые настройки и отличаются только IP адресами, паролями на VPN и Wi-Fi. Внесение даже незначительных изменений на десяток устройств потребует значительного времени и концентрации.<br /><br />Для управления сотнями и тысячами устройств весь цивилизованный мир уже давно использует специальные системы менеджмента конфигураций: <a href="https://www.ansible.com/" target="_blank">Ansible</a>, <a href="https://www.chef.io/chef/" target="_blank">Chef</a>, <a href="https://puppet.com/" target="_blank">Puppet</a>. Каждая из них имеет свои плюсы и минусы.<br /><br /><br />Но для десяти-двадцати устройств не каждый захочет выделять отдельный сервер с такой системой. Поэтому в ход идут скрипты, SSH, FTP и куча матов, когда всё это поделие роняет сразу все филиалы.<br /><br />Видео для привлечения внимания<br /><iframe allowfullscreen="" frameborder="0" height="480" src="//vk.com/video_ext.php?oid=2493048&amp;id=456239035&amp;hash=9b157f5cacd5fd63&amp;hd=2" width="853"></iframe> Это визуализация запросов от роутеров к системе, о которой идет речь в этом посте. <br /><br /><a name='more'></a><br /><br />Я тоже накостылил подобную систему в соответствии со своими потребностями и расскажу о ней.<br /><br />Мои требования к системе централизованного управления:<br /><ul><li>Надежность.&nbsp; Система должна работать независимо от скорости соединения или после месячного оффлайна</li><li>Приемлемая скорость актуализации конфигурации. Если девайс месяц не включался, то свежий конфиг он должен применить за обозримое время</li><li>Низкая нагрузка на каналы связи и ресурсы сервера. Обновление конфигурации не должно положить интернет в ЦОДе и процессор машины</li><li>Масштабируемость. Систему можно увеличить в 5-10 раз</li><li>Разделение устройств по группам. Применение разных настроек к разным группам</li><li>Обратная связь о применении конфигурации&nbsp;</li><li>Постараться не использовать Flash память микротика по причине её износа</li></ul><br /><br />Из требований родились идеи к реализации:<br /><ul><li>Чтобы обеспечить применение всех изменений, роутер должен сам обращаться за конфигурацией</li><li>Актуализация обеспечивается за счет опроса сервера раз в час</li><li>Чтобы не нагружать ресурсы и каналы, роутеры должны обращаться за обновлениями в разное время</li><li>Для оповещений использовать Telegram </li><li>Следование принципу <a href="https://ru.wikipedia.org/wiki/KISS_(%D0%BF%D1%80%D0%B8%D0%BD%D1%86%D0%B8%D0%BF)" target="_blank">KISS</a></li></ul><br />Для работы системы понадобится только web сервер. В моем случае apache. Как его <a href="http://www.bubnovd.net/2011/03/debian.html" target="_blank">установить</a> и <a href="http://www.bubnovd.net/2011/08/linux-server-2-iptables.html" target="_blank">настроить</a> я <a href="http://www.bubnovd.net/2011/10/blog-post.html" target="_blank">рассказывать</a> не буду, к тому же необязательно это должен быть апач.<br /><br />Логика такая: на веб сервере лежат RouterOS скрипты, с определенным именованием. Имя скрипта указывает на его версию и группу устройств, для которой должна примениться конфигурация. Маршрутизаторы с периодичностью раз в час обращаются к серверу за новым конфигом. Если новый конфиг есть, то он скачивается на роутер и выполняется. Если конфига нет - ничего не скачивается, что позволяет не дергать лишний раз быстроубиваемую память.<br /><br /><br />Чтобы начать применять подобную систему, надо привести конфиги всех роутеров к одному стандарту. К примеру, не так давно в RouterOS появилась новая фича: Interface List. Теперь можно одним правилом в фаерволе заменить несколько правил, если их надо применить к разным интерфейсам. Наш скрипт должен добавить в интерфейс-лист интерфейс, который "смотрит" к провайдеру. На одном роутере это может быть eth1, на другом PPPoE, на третьем - вообще wlan1.<br /><br />Как в таком случае поступить? Надо как-то выделить внешние интерфейсы. Например, добавить к ним комментарий "WAN".<br />Также стОит привести к одному виду фаервол, Queues - вообще всё, что есть на роутерах. И создать отдельную учетную запись,&nbsp; с правами которой будут выполняться скрипты. Как создать скрипт для быстрой настройки роутеров я расскажу в следующем посте.<br /><br /><br />Принцип именования скриптов: A000, где А - группа устройств, а номер - версия скрипта.<br /><br />Каждому роутеру в планировщик добавляем такие строки:<br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/system scheduler</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/tool fetch url="http://rbconf.bubnovd.net/A001" user=mikrotik-ninja password=mikrotik-ninja.ru<br /><br />/import A001</span><br /><br />Это задание скачивает с сервера скрипт и выполняет его. Для обеспечения хоть какой-то безопасности, доступ к серверу только по паролю, который указан в задании.<br /><br /><br />Сами скрипты лежат на сервере и выглядят примерно так:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/log info message=".....................Autoconfiguration started....................."<br />#Версия внедряемой конфигурации<br />#Описание задачи, которую выполняет скрипт: Удаление пользователя</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#Первая часть скрипта нужна для только для определения&nbsp; версии конфига, который нужно применить следующим</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">:local ver<br />:set $ver A001<br />#Версия следующей конфигурации<br />:local verNext<br />#Версия предыдущей конфигурации<br />:local verPrev<br />:set $verNext ("A" . [tostr ([tonum [pick $ver 1 4]] + 1)])<br />:set $verPrev ("A" . [tostr ([tonum [pick $ver 1 4]] - 1)])<br />#Добавляем нули, если надо<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ([:len $verNext] =2) do={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :set $verNext ([pick $verNext 0 1] . "00" . [pick $verNext ([len $verNext] -1) ([len $verNext])])} else={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ([:len $verNext] =3) do={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :set $verNext ([pick $verNext 0 1] . "0" . [pick $verNext ([len $verNext] -2) ([len $verNext])])} else={}}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ([:len $verPrev] =2) do={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :set $verPrev ([pick $verPrev 0 1] . "00" . [pick $verPrev ([len $verPrev] -1) ([len $verPrev])])} else={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ([:len $verPrev] =3) do={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :set $verPrev ([pick $verPrev 0 1] . "0" . [pick $verPrev ([len $verPrev] -2) ([len $verPrev])])} else={}}</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Вторая часть скрипта - наша рабочая конфигурация </span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#####<br />#####Тут код конфигурации<br />#####<br />if ([len [/user find name="prosvirnin"]]&gt;0) do={/user remove [find name="</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">prosvirnin</span>"]} else={/log info message="User not exist"}<br />#####<br />#/log info message="Creating script $ver"<br />#/system script add name=$ver source="/log info message=done"<br />#/log info message="Script $ver created. Starting"<br />#/system script run $ver<br />#/log info message="Removing script $ver"<br />#/system script remove $ver<br />##### Или в скрипте выше</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Третья часть - настройка планировщика для следующего изменения, оповещение и чистка файлов<br />/system scheduler set autoconf on-event="/tool fetch url=\"http://rbconf.bubnovd.net/$verNext\" user=mikrotik-ninja password=mikrotik-ninja.ru\r\n<br />/import $verNext"<br />/log info message="...................Autoconfiguration complete..................."<br />/delay 3<br />#Удаляем остатки предыдущих скриптов, если не удалились<br />if ([:len [/file find name~"sendMessage"]] &gt;0) do={/file remove [/file find name~"sendMessage"]} else={/log info message="No item for delete"}<br />if ([:len [/file find name="$verPrev"]] &gt;0) do={/file remove [/file find name="$verPrev"]} else={/log info message="No item for delete"}<br />/delay 3<br />#Отправляем уведомление о выполнении<br />:local name [/system identity get name]<br />/tool fetch keep-result=no url="https://api.telegram.org/bot-nomer-bota:tut-vasha-ssylka/sendMessage\?chat_id=-12345678&amp;text=$ver is complete on $name"<br />/delay 3<br />if ([:len [/file find name~"sendMessage"]] &gt;0) do={/file remove [/file find name~"sendMessage"]} else={/log info message="No item for delete"}<br />/delay 3<br />/file remove $ver</span><br /><br /><br />Сначала описывается версия конфига и каким будет следующая версия. Затем после комментария "<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#####Тут код конфигурации</span>" перечисляются команды, которые должен выполнить роутер. Иногда роутер должен выполнить сложный скрипт. На этот случай есть закомментированный блок кода со скриптом. Сам сложный скрипт нужно описать в поле source="tut_sam_script"<br /><br />После выполнения команд меняется задание в планировщике - указываем следующую версию скрипта, который надо применить. С этого момента роутер будет пытаться скачать его с сервера. Дальше шлём уведомление и удаляем файлы, которые могли создастся в ходе выполнения задания. Как слать оповещения в Telegram описано на <a href="https://1spla.ru/blog/telegram_bot_for_mikrotik" target="_blank">бескрайних </a><a href="https://habrahabr.ru/post/314108/" target="_blank">просторах </a>интернета и повторяться я не буду.<br /><br /><br />Очень важно предусмотреть в скрипте всё возможное и невозможное и каждая команда должна начинаться с проверки&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">if (...) do={ </span>, а заканчиваться <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">} else={/log info message="User not exist"}</span> . У одного из моих роутеров был баг, из-за которого не отображался wireless интерфейс. И без проверки его существования, скрипт просто вываливался с ошибкой. А значит, не менялась запись в планировщике и следующий скрипт тоже не выполнялся.<br /><br />Перед применением конфигурации на всю сеть нужно проверить правильность написания скрипта - даже опытный скриптописатель может чего-то не учесть и хорошо, если это какая-то мелочь и она не положит всю сеть. Поэтому перед созданием нового файла конфигурации, я проверяю&nbsp; команды на работающем в продакшене роутере. А затем использую отдельную группу из 20 разнотипных роутеров (в основном это разный тип подключения к сети, остальные настройки везде идентичны) для тестирования скрипта. Эти роутеры опрашивают сервер чаще, чем остальные и после применения настроек я какое-то время наблюдаю за их поведением, а затем распространяю нововведения на остальную сеть.<br /><br /><br /><br />Чего не хватает в моём подходе:<br /><ul><li><b>Безопасность</b>. Хоть доступ на сервер со скриптами ограничен  паролем, но этот пароль в открытом виде хранится на роутерах. Вся  конфигурация передается по сети в открытом виде. У меня всё это летает  внутри шифрованного VPN и я <span style="color: red;">запрещаю вам использовать это на нешифрованных публичных каналах</span>! Внутреннего нарушителя тоже никто не отменял и внутри VPN это не очень безопасно. <strike>Можно</strike> Нужно! использовать https вместо http.</li><li><b>Информативные оповещения</b>. При возникновении ошибки, неплохо было бы сообщать о ней</li><li><b>Возможны только изменения</b>. Хочется ещё и читать конфиги и выделять места, отличные от стандарта. Но это задача уже другого класса систем</li></ul><br /><br />Через полгода после внедрения этой системы, на <a href="https://mum.mikrotik.com/2016/RU/agenda/EN" target="_blank">встрече пользователей Mikrotik</a> Михаил Москалев &nbsp; рассказал об аналогичном подходе. Михаил продвинулся дальше и применил модульный подход к конфигурации. Его презентацию можно посмотреть по <a href="https://mum.mikrotik.com//presentations/RU16/presentation_3759_1475646696.pdf" target="_blank">ссылке</a>.<br />Такой же подход использует система блокировки рекламы для Mikrotik <a href="https://stopad.cgood.ru/" target="_blank">https://stopad.cgood.ru/ </a>.&nbsp; <br />Постоянный докладчик нашей <a href="https://sysadminka.org/" target="_blank">#Sysadminka</a> написал свою систему управления конфигурациями. Она доступна на <a href="https://github.com/xoma9/ops-tool" target="_blank">github</a>. Посмотреть можно на <a href="https://www.youtube.com/watch?v=ZOOsY4r6qks" target="_blank">YouTube</a>.<br /><br /><br />В следующем посте я опишу ещё один свой скриптик с использованием Excel, который помогает младшим админам настраивать первичную конфигурацию роутеров без вникания в WinBox и настройки RouterOS.<br /><br /><br />P.S.: Видео в посте создано с помощью <a href="http://www.bubnovd.net/2017/06/grep.html" target="_blank">grep </a>и <a href="http://logstalgia.io/" target="_blank">logstalgia</a>.
