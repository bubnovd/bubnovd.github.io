+++
title = "Top-10 ошибок настройки/дизайна СПД в ISP"
date = 2016-08-17T00:03:00Z
updated = 2016-08-17T00:03:13Z
tags = ["internet", "ISP"]
blogimport = true 
[author]
	name = "devi1"
	uri = "https://www.blogger.com/profile/05777499482649623616"
+++

<div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">1. Вся сеть (или большие сегменты) в одном VLAN. Аналогично и с управлением оборудованием. Совсем печальный случай, когда и управление и data-трафик находятся в одном единственном default VLAN. Такие схемы нормально не работают, проблемы практически не поддаются траблшутингу. Совсем хорошо, когда между абонентами нет L2-взаимодействия, а в идеале, когда они не могут влиять друг на друга по мак-таблице.</div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;"></div><a name='more'></a><br /><br /><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">2. Анонс своей сети, не имея её в таблице маршрутизации (популярные в небольших ISP Quagga и Mikrotik RouterOS это позволяют). Эффект этого очевиден для любого грамотного инженера – петля маршрутизации. Обычно такое происходит при совмещении ASBR и BRAS в одной железке, про роут сети в NULL0/blackhole забывают.</div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">3. Использование слишком сложных схем резервирования на L2. Кольца доступа+кольца агрегационных свитчей, да ещё и замыкание колец доступа на различных узлах агрегации и всё это с использованием какой-либо вариации STP или его аналога ни к чему хорошему не приводят. Аварий из-за слишком сложной топологии становится больше, чем пользы от такого резервирования.<br /><span id="more-913" style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;"></span></div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">4. Включение (точнее, невыключение) PIM/OSPF/прочего в сторону абонента. К чему это может привести догадаться не сложно. На деле, абоненты редко анализируют что к ним приходит и проводят попытки это как-то использовать с вредоносными целями. Однако, практика показывает, что любая потенциальная проблема дизайна или настройки рано или поздно превращается в аварию или проблему. Ниже пример(<a href="http://www.tiktube.com/video/CnhI3imFiKJKIKJKGICrFrlsDlHomFpq=" style="border: 0px; color: #9f9f9f; margin: 0px; outline: none; padding: 0px; vertical-align: baseline;" target="_blank">оригинал</a>) (докладчик – широко известный в узких кругах Saab95), как на на конференции пользователей оборудования Mikrotik рассказывают о том как неправильно настраивать OSPF<br /><span class="embed-youtube" style="border: 0px; display: block; margin: 0px; padding: 0px; text-align: center; vertical-align: baseline;"><iframe allowfullscreen="true" class="youtube-player" height="382" src="https://www.youtube.com/embed/V6nmk1ra9TA?version=3&amp;rel=1&amp;fs=1&amp;autohide=2&amp;showsearch=0&amp;showinfo=1&amp;iv_load_policy=1&amp;wmode=transparent" style="border-style: initial; border-width: 0px; margin: 0px 0px 1.71429rem; max-width: 100%; padding: 0px; vertical-align: baseline;" type="text/html" width="625"></iframe></span></div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">5. Включение (точнее, невыключение) десктопных и сервисных функций на софтроутерах, что приводит к деградации производительности (packet drops). Наиболее часто это энергосбережение (<a href="http://sourceforge.net/p/e1000/mailman/message/27791177/" style="border: 0px; color: #9f9f9f; margin: 0px; outline: none; padding: 0px; vertical-align: baseline;">пример</a>,&nbsp;<a href="http://web.archive.org/web/20150711092710/http://sourceforge.net/p/e1000/mailman/message/27791177/" style="border: 0px; color: #9f9f9f; margin: 0px; outline: none; padding: 0px; vertical-align: baseline;">архив</a>), некоторые offload-ы сетевых карт, предназначенные для увеличения производительности локальных сервисов (а не софтроутера). Здесь лидер это TSO (tcp segmentation offload). Относительно TSO можно найти тысячи радостных постов на просторах интернета о том как его выключение повышает производительность. Ещё одно большое зло для софтроутеров это IOMMU(VT-d), см.&nbsp;<a href="http://sourceforge.net/p/e1000/mailman/message/30128349/" style="border: 0px; color: #9f9f9f; margin: 0px; outline: none; padding: 0px; vertical-align: baseline;">здесь</a>(<a href="http://web.archive.org/web/20150711094536/http://sourceforge.net/p/e1000/mailman/message/30128349/" style="border: 0px; color: #9f9f9f; margin: 0px; outline: none; padding: 0px; vertical-align: baseline;">архив</a>). Очень много информации о том как правильно готовить софтроутеры имеется на форуме&nbsp;<span class="skimlinks-unlinked" style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">nag.ru</span>.</div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">6. Политики безопасности ниже плинтуса. Например, оставить L3-связность между абонентом и интерфейсом управления оборудования, поставить пароль на CLI/web/прочее и больше ничего не делать. Так нельзя, некоторые D-Link’и убивались даже специально сформированным icmp-пакетом. Управление должно быть спрятано в VRF или защищено пакетным фаерволом, а не просто access-list’ом, который используется самим сервисом (пример такой&nbsp;<a href="https://net-labs.in/2014/07/31/telnet-access-list-%D0%BD%D0%B0-cisco-ios-xr-asr9k-xrv-crs/" style="border: 0px; color: #9f9f9f; margin: 0px; outline: none; padding: 0px; vertical-align: baseline;">разницы</a>&nbsp;для IOS-XR). Каждый день в базах уязвимостей ПО появляются новые записи, поэтому всё, что можно закрыть на L3 нужно закрывать на L3, тем самым минимизировать взаимодействие untrusted трафика с сервисами управления. Сюда же стоит добавить рекурсивный DNS-сервис, открытый всему интернету и ntp. Относительно DNS фаервол уже мало спасёт и нужно осуществлять регулярные обновления безопасности ПО.<br />Особо печальный случай, что мне приходилось видеть это БД биллинга, доступная с любого хоста интернет, при этом логин, пароль и название базы данных было очень простым словарным словом (типа admin/admin/admin). В одном абзаце про политики безопасности в ISP не расскажешь, но надеюсь, что идея в целом понятная.</div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">7. Отсутствие ограничений на NAT per-customer и слишком большое количество абонентов за одним внешним IPv4-адресом. Первое может привести к тому, что закончится таблица xlat, что вызовет почти полную деградацию сервиса, второе к появлению регулярных “капч” на различных сайтах или даже блокировка доступа со стороны каких-либо ресурсов. 50-100 абонентов за одним внешним адресом это нормально, можно и больше, но дальше уже появляются различные проблемы, иногда они существенные, иногда нет.</div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">8. Классика жанра – ebgp без out-фильтров. Поднимаем 2 аплинка, прописываем свои сети и тупиковая AS становится потенциально транзитной. Об этом написано практически в любом курсе по BGP, но “мы сами с усами, а курсы от вендоров это лишь пропаганда их оборудования”. Любой нормальный аплинк, конечно же, зафильтрует то, что вы анонсируете не по делу, но сейчас и небольшие операторы, настраивающие OSFP по советам из видеоролика выше, могут продавать IP-транзит и не иметь нормальных фильтров на in в bgp в сторону тех, кто забывает фильтры на out.</div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">9. Игнорирование проблемы микробёрствов. В ШПД это не так критично(до поры до времени), а вот для реалтайм-сервисов очень даже. Известный мне пример – использование свитчей Cisco 3560G, 3750E/X и т.п.(оборудование с маленьким пакетным буфером) для включения оборудования ЦТВ/КТВ, при этом трафика на даунлинк портах довольно много и аплинк 2G, так делать нельзя, если трафик сверху приходит не идеально равномерный (без бёрстов). Подробнее см.&nbsp;<a href="https://net-labs.in/2014/04/26/burst-vs-%D0%B1%D1%83%D1%84%D0%B5%D1%80-%D0%BA%D0%BE%D0%BC%D0%BC%D1%83%D1%82%D0%B0%D1%86%D0%B8%D0%B8/" style="border: 0px; color: #9f9f9f; margin: 0px; outline: none; padding: 0px; vertical-align: baseline;">здесь</a>.</div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">10.&nbsp;<a href="https://blog.yandex.ru/post/38521/" style="border: 0px; color: #9f9f9f; margin: 0px; outline: none; padding: 0px; vertical-align: baseline;">redistribute bgp fv в ospf</a>. Здесь должна была быть шикарная картинка, показывающая как это проиcходит, но не опубликована по просьбе главной героини этого коллажа.</div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;"><br /></div><div style="background-color: white; border: 0px; color: #444444; font-family: &quot;Open Sans&quot;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 24px; margin-bottom: 1.71429rem; padding: 0px; vertical-align: baseline;">Наглая копипаста <a href="https://net-labs.in/2015/07/11/top-10-%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8%D0%B4%D0%B8%D0%B7%D0%B0%D0%B9%D0%BD%D0%B0-%D1%81%D0%BF%D0%B4-%D0%B2-isp/" target="_blank">отсюда</a></div>
