<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>MAC-Port on Bubnovd</title><link>https://bubnovd.github.io/tags/mac-port/</link><description>Recent content in MAC-Port on Bubnovd</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 25 Feb 2015 03:40:00 +0000</lastBuildDate><atom:link href="https://bubnovd.github.io/tags/mac-port/index.xml" rel="self" type="application/rss+xml"/><item><title>Скрипт для выявления порта свитча по маку</title><link>https://bubnovd.github.io/blogger/%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82-%D0%B4%D0%BB%D1%8F-%D0%B2%D1%8B%D1%8F%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BF%D0%BE%D1%80%D1%82%D0%B0-%D1%81%D0%B2%D0%B8%D1%82%D1%87%D0%B0-%D0%BF%D0%BE-%D0%BC%D0%B0%D0%BA%D1%83/</link><pubDate>Wed, 25 Feb 2015 03:40:00 +0000</pubDate><guid>https://bubnovd.github.io/blogger/%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82-%D0%B4%D0%BB%D1%8F-%D0%B2%D1%8B%D1%8F%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BF%D0%BE%D1%80%D1%82%D0%B0-%D1%81%D0%B2%D0%B8%D1%82%D1%87%D0%B0-%D0%BF%D0%BE-%D0%BC%D0%B0%D0%BA%D1%83/</guid><description>Имеем сеть с кучей управляемых свитчей, подключенных к одному корневому и друг к другу с включенным STP. Необходимо найти порт, к которому подключено устройство с известным нам MAC-адресом. Бегать по web-интерфейсам свитчей крайне напряжно, если маков больше 5. Я использую систему мониторинга The Dude, которая умеет обходить устройства по SNMP и вываливать необходимую инфу в csv. Поэтому с каждого свитча сливаем в csv таблицу FDB. Получаем подобное:Flag,MAC,Port,Status,00:03:0F:18:F1:6A,D-Link DGS-3120-48TC R3.10.B01 Port 43 on Unit 1 (43),learned,00:0B:82:3E:27:C6,D-Link DGS-3120-48TC R3.</description><content>&lt;p>Имеем сеть с кучей управляемых свитчей, подключенных к одному корневому и друг к другу с включенным STP. Необходимо найти порт, к которому подключено устройство с известным нам MAC-адресом. Бегать по web-интерфейсам свитчей крайне напряжно, если маков больше 5. &lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Я использую систему мониторинга The Dude, которая умеет обходить устройства по SNMP и вываливать необходимую инфу в csv. Поэтому с каждого свитча сливаем в csv таблицу FDB. Получаем подобное:&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Flag,MAC,Port,Status&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->,00:03:0F:18:F1:6A,D-Link DGS-3120-48TC R3.10.B01 Port 43 on Unit 1 (43),learned&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->,00:0B:82:3E:27:C6,D-Link DGS-3120-48TC R3.10.B01 Port 2 on Unit 1 (2),learned&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->,00:0B:82:3E:27:C9,D-Link DGS-3120-48TC R3.10.B01 Port 10 on Unit 2 (74),learned&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->,00:0C:29:BD:81:53,D-Link DGS-3120-48TC R3.10.B01 Port 5 on Unit 1 (5),learned&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->,00:11:BE:00:0F:34,D-Link DGS-3120-48TC R3.10.B01 Port 13 on Unit 1 (13),learned&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->У меня один корневой свитч (его FDB я обозвал FDB21.csv) и несколько коммутаторов на уровне доступа (все остальные .csv). Я знаю к каким портам корневого подключены остальные коммутаторы. Писал на PowerShell, так как считаю его довольно удобным и мощным и хочу научиться использовать его. Собственно скрипт:&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$path = &amp;ldquo;d:\scripts\FDB&amp;quot;&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$rootDB = &amp;ldquo;FDB21.csv&amp;rdquo;&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$sport = (&amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 1 on Unit 1 (1)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 2 on Unit 1 (2)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 5 on Unit 1 (1)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 12 on Unit 1 (12)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 13 on Unit 1 (13)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 14 on Unit 1 (14)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 43 on Unit 1 (43)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 44 on Unit 1 (44)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 1 on Unit 2 (65)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 2 on Unit 2 (66)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 10 on Unit 2 (74)&amp;rdquo;, &amp;ldquo;D-Link DGS-3120-48TC R3.10.B01 Port 43 on Unit 2 (107)&amp;rdquo;)&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$swDB = (&amp;ldquo;FDB42.csv&amp;rdquo;, &amp;ldquo;FDB44.csv&amp;rdquo;, &amp;ldquo;FDB61.csv&amp;rdquo;, &amp;ldquo;FDB52.csv&amp;rdquo;, &amp;ldquo;FDB51.csv&amp;rdquo;, &amp;ldquo;FDB12.csv&amp;rdquo;, &amp;ldquo;FDB33.csv&amp;rdquo;, &amp;ldquo;FDB32.csv&amp;rdquo;, &amp;ldquo;FDB41.csv&amp;rdquo;, &amp;ldquo;FDB43.csv&amp;rdquo;, &amp;ldquo;FDB11.csv&amp;rdquo;, &amp;ldquo;FDB34.csv&amp;rdquo;)&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->function findinarr ($array, $value) {&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->    for ($i=0; $i -lt $array.count;$i++) { &lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->        if($array[$i] -eq $value){$i}&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->    }&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->}&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$dataRoot = Import-CSV -path $path$rootDB | Select-Object MAC, Port&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$mac = Read-Host &amp;ldquo;Enter MAC&amp;rdquo;&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->foreach ($S in $dataRoot)&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->{&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> &lt;!-- raw HTML omitted -->if ($mac -eq $s.mac)&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> &lt;!-- raw HTML omitted -->{&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> &lt;!-- raw HTML omitted -->$portRoot = $s.port&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> &lt;!-- raw HTML omitted -->}&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->}&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$A = findinarr $sport $portRoot&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$datasw = Import-CSV -path $path$swDB[$A] | Select-Object MAC, Port&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->foreach ($S in $datasw)&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->{&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> &lt;!-- raw HTML omitted -->if ($mac -eq $s.mac)&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> &lt;!-- raw HTML omitted -->{&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> &lt;!-- raw HTML omitted -->$port = $s.port&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> &lt;!-- raw HTML omitted -->}&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->}&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Write-Host $mac on $port&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Разбор по строкам:&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$path = &amp;ldquo;d:\scripts\FDB&amp;quot; - указываем путь к папке с .csv&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$rootDB = &amp;ldquo;FDB21.csv&amp;rdquo; - FDB с корневого коммутатора. По нему ищем с самого начала и на основе найденного порта переходим к следующему коммутатору.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$sport - строковый массив из названий портов в csv.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$swDB - массив из названий файлов, содержащих информацию о соответствии MAC-порт. &lt;!-- raw HTML omitted -->Массивы sport и swDB должны иметь однозначное соответствие!&lt;!-- raw HTML omitted --> В моем случае к Port 1 on Unit 1 подключен коммутатор sw42, следовательно, если нашли MAC на первом порту первого юнита, то дальше будем искать в файле FDB42.csv, где находится база sw42. И так далее.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->function findinarr позаимствована у &lt;!-- raw HTML omitted -->Вадима Поданса&lt;!-- raw HTML omitted -->, который в свою очередь позаимствовал её у &lt;!-- raw HTML omitted -->Василия Гусева&lt;!-- raw HTML omitted -->. Это матерые пауэршэльщики, советую почитать их блоги. Функция находит индекс искомого элемента в массиве.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->В переменную $dataRoot считываем csv с корневого коммутатора. Причем забираем только параметры MAC и Port - остальные нас не интересуют.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$mac = Read-Host &amp;ldquo;Enter MAC&amp;rdquo; - вводим искомый мак.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->foreach ($S in $dataRoot) - ищем в массиве MAC-Port наш MAC-адрес. Если находим, то запоминаем порт.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$A = findinarr $sport $portRoot - ищем индекс найденного порта в массиве sport.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->$datasw = Import-CSV -path $path$swDB[$A] | Select-Object MAC, Port - полученный в предыдущем шаге индекс подставляем в swDB и находим в нем имя следующего обрабатываемого файла. Этот файл считываем в переменную datasw, которую далее обрабатываем точно так же, как и dataRoot.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Не претендую на правильность скрипта, но у меня оно работает. Написал за неполный рабочий день будучи полнейшим нулем в PowerShell и 0,1 в программировании. Теперь нужно избавиться от csv и прикрутить опрос свитчей по SNMP прямо из скрипта.&lt;!-- raw HTML omitted -->&lt;/p></content></item></channel></rss>