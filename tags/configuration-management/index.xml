<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>configuration management on Админская фамилия</title><link>https://bubnovd.net/tags/configuration-management/</link><description>Recent content in configuration management on Админская фамилия</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 20 Nov 2017 09:56:00 +0000</lastBuildDate><atom:link href="https://bubnovd.net/tags/configuration-management/index.xml" rel="self" type="application/rss+xml"/><item><title>Мikrotik RouterOS Configuration Management с помощью скриптов и какой-то там матери</title><link>https://bubnovd.net/blogger/%D0%BCikrotik-routeros-configuration-management-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B2-%D0%B8-%D0%BA%D0%B0%D0%BA%D0%BE%D0%B9-%D1%82%D0%BE-%D1%82%D0%B0%D0%BC-%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8/</link><pubDate>Mon, 20 Nov 2017 09:56:00 +0000</pubDate><guid>https://bubnovd.net/blogger/%D0%BCikrotik-routeros-configuration-management-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B2-%D0%B8-%D0%BA%D0%B0%D0%BA%D0%BE%D0%B9-%D1%82%D0%BE-%D1%82%D0%B0%D0%BC-%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8/</guid><description>Жизненный цикл сети часто переживает закономерный рост. В это время начинают появляться десятки и сотни устройств, конфигурация которых однотипна. Например, это могут быть маршрутизаторы в филиалах, которые имеют одинаковые настройки и отличаются только IP адресами, паролями на VPN и Wi-Fi. Внесение даже незначительных изменений на десяток устройств потребует значительного времени и концентрации.Для управления сотнями и тысячами устройств весь цивилизованный мир уже давно использует специальные системы менеджмента конфигураций: Ansible, Chef, Puppet. Каждая из них имеет свои плюсы и минусы.</description><content>&lt;p>Жизненный цикл сети часто переживает закономерный рост. В это время начинают появляться десятки и сотни устройств, конфигурация которых однотипна. Например, это могут быть маршрутизаторы в филиалах, которые имеют одинаковые настройки и отличаются только IP адресами, паролями на VPN и Wi-Fi. Внесение даже незначительных изменений на десяток устройств потребует значительного времени и концентрации.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Для управления сотнями и тысячами устройств весь цивилизованный мир уже давно использует специальные системы менеджмента конфигураций: &lt;!-- raw HTML omitted -->Ansible&lt;!-- raw HTML omitted -->, &lt;!-- raw HTML omitted -->Chef&lt;!-- raw HTML omitted -->, &lt;!-- raw HTML omitted -->Puppet&lt;!-- raw HTML omitted -->. Каждая из них имеет свои плюсы и минусы.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Но для десяти-двадцати устройств не каждый захочет выделять отдельный сервер с такой системой. Поэтому в ход идут скрипты, SSH, FTP и куча матов, когда всё это поделие роняет сразу все филиалы.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Видео для привлечения внимания&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --> Это визуализация запросов от роутеров к системе, о которой идет речь в этом посте. &lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Я тоже накостылил подобную систему в соответствии со своими потребностями и расскажу о ней.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Мои требования к системе централизованного управления:&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Надежность.  Система должна работать независимо от скорости соединения или после месячного оффлайна&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Приемлемая скорость актуализации конфигурации. Если девайс месяц не включался, то свежий конфиг он должен применить за обозримое время&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Низкая нагрузка на каналы связи и ресурсы сервера. Обновление конфигурации не должно положить интернет в ЦОДе и процессор машины&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Масштабируемость. Систему можно увеличить в 5-10 раз&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Разделение устройств по группам. Применение разных настроек к разным группам&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Обратная связь о применении конфигурации &lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Постараться не использовать Flash память микротика по причине её износа&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Из требований родились идеи к реализации:&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Чтобы обеспечить применение всех изменений, роутер должен сам обращаться за конфигурацией&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Актуализация обеспечивается за счет опроса сервера раз в час&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Чтобы не нагружать ресурсы и каналы, роутеры должны обращаться за обновлениями в разное время&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Для оповещений использовать Telegram &lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Следование принципу &lt;!-- raw HTML omitted -->KISS&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Для работы системы понадобится только web сервер. В моем случае apache. Как его &lt;!-- raw HTML omitted -->установить&lt;!-- raw HTML omitted --> и &lt;!-- raw HTML omitted -->настроить&lt;!-- raw HTML omitted --> я &lt;!-- raw HTML omitted -->рассказывать&lt;!-- raw HTML omitted --> не буду, к тому же необязательно это должен быть апач.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Логика такая: на веб сервере лежат RouterOS скрипты, с определенным именованием. Имя скрипта указывает на его версию и группу устройств, для которой должна примениться конфигурация. Маршрутизаторы с периодичностью раз в час обращаются к серверу за новым конфигом. Если новый конфиг есть, то он скачивается на роутер и выполняется. Если конфига нет - ничего не скачивается, что позволяет не дергать лишний раз быстроубиваемую память.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Чтобы начать применять подобную систему, надо привести конфиги всех роутеров к одному стандарту. К примеру, не так давно в RouterOS появилась новая фича: Interface List. Теперь можно одним правилом в фаерволе заменить несколько правил, если их надо применить к разным интерфейсам. Наш скрипт должен добавить в интерфейс-лист интерфейс, который &amp;ldquo;смотрит&amp;rdquo; к провайдеру. На одном роутере это может быть eth1, на другом PPPoE, на третьем - вообще wlan1.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Как в таком случае поступить? Надо как-то выделить внешние интерфейсы. Например, добавить к ним комментарий &amp;ldquo;WAN&amp;rdquo;.&lt;!-- raw HTML omitted -->Также стОит привести к одному виду фаервол, Queues - вообще всё, что есть на роутерах. И создать отдельную учетную запись,  с правами которой будут выполняться скрипты. Как создать скрипт для быстрой настройки роутеров я расскажу в следующем посте.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Принцип именования скриптов: A000, где А - группа устройств, а номер - версия скрипта.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Каждому роутеру в планировщик добавляем такие строки:&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->/system scheduler&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->/tool fetch url=&amp;ldquo;&lt;a href="http://rbconf.bubnovd.net/A001%22">http://rbconf.bubnovd.net/A001&amp;quot;&lt;/a> user=mikrotik-ninja password=mikrotik-ninja.ru&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->/import A001&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Это задание скачивает с сервера скрипт и выполняет его. Для обеспечения хоть какой-то безопасности, доступ к серверу только по паролю, который указан в задании.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Сами скрипты лежат на сервере и выглядят примерно так:&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->/log info message=&amp;rdquo;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;Autoconfiguration started&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;quot;&lt;!-- raw HTML omitted -->#Версия внедряемой конфигурации&lt;!-- raw HTML omitted -->#Описание задачи, которую выполняет скрипт: Удаление пользователя&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->#Первая часть скрипта нужна для только для определения  версии конфига, который нужно применить следующим&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->:local ver&lt;!-- raw HTML omitted -->:set $ver A001&lt;!-- raw HTML omitted -->#Версия следующей конфигурации&lt;!-- raw HTML omitted -->:local verNext&lt;!-- raw HTML omitted -->#Версия предыдущей конфигурации&lt;!-- raw HTML omitted -->:local verPrev&lt;!-- raw HTML omitted -->:set $verNext (&amp;ldquo;A&amp;rdquo; . [tostr ([tonum [pick $ver 1 4]] + 1)])&lt;!-- raw HTML omitted -->:set $verPrev (&amp;ldquo;A&amp;rdquo; . [tostr ([tonum [pick $ver 1 4]] - 1)])&lt;!-- raw HTML omitted -->#Добавляем нули, если надо&lt;!-- raw HTML omitted -->        if ([:len $verNext] =2) do={&lt;!-- raw HTML omitted -->                :set $verNext ([pick $verNext 0 1] . &amp;ldquo;00&amp;rdquo; . [pick $verNext ([len $verNext] -1) ([len $verNext])])} else={&lt;!-- raw HTML omitted -->                if ([:len $verNext] =3) do={&lt;!-- raw HTML omitted -->                        :set $verNext ([pick $verNext 0 1] . &amp;ldquo;0&amp;rdquo; . [pick $verNext ([len $verNext] -2) ([len $verNext])])} else={}}&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->        if ([:len $verPrev] =2) do={&lt;!-- raw HTML omitted -->                :set $verPrev ([pick $verPrev 0 1] . &amp;ldquo;00&amp;rdquo; . [pick $verPrev ([len $verPrev] -1) ([len $verPrev])])} else={&lt;!-- raw HTML omitted -->                if ([:len $verPrev] =3) do={&lt;!-- raw HTML omitted -->                        :set $verPrev ([pick $verPrev 0 1] . &amp;ldquo;0&amp;rdquo; . [pick $verPrev ([len $verPrev] -2) ([len $verPrev])])} else={}}&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --># Вторая часть скрипта - наша рабочая конфигурация &lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->#####&lt;!-- raw HTML omitted -->#####Тут код конфигурации&lt;!-- raw HTML omitted -->#####&lt;!-- raw HTML omitted -->if ([len [/user find name=&amp;ldquo;prosvirnin&amp;rdquo;]]&amp;gt;0) do={/user remove [find name=&amp;quot;&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->prosvirnin&lt;!-- raw HTML omitted -->&amp;quot;]} else={/log info message=&amp;ldquo;User not exist&amp;rdquo;}&lt;!-- raw HTML omitted -->#####&lt;!-- raw HTML omitted -->#/log info message=&amp;ldquo;Creating script $ver&amp;rdquo;&lt;!-- raw HTML omitted -->#/system script add name=$ver source=&amp;quot;/log info message=done&amp;quot;&lt;!-- raw HTML omitted -->#/log info message=&amp;ldquo;Script $ver created. Starting&amp;rdquo;&lt;!-- raw HTML omitted -->#/system script run $ver&lt;!-- raw HTML omitted -->#/log info message=&amp;ldquo;Removing script $ver&amp;rdquo;&lt;!-- raw HTML omitted -->#/system script remove $ver&lt;!-- raw HTML omitted -->##### Или в скрипте выше&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted --># Третья часть - настройка планировщика для следующего изменения, оповещение и чистка файлов&lt;!-- raw HTML omitted -->/system scheduler set autoconf on-event=&amp;quot;/tool fetch url=&amp;quot;http://rbconf.bubnovd.net/$verNext&amp;quot; user=mikrotik-ninja password=mikrotik-ninja.ru\r\n&lt;!-- raw HTML omitted -->/import $verNext&amp;quot;&lt;!-- raw HTML omitted -->/log info message=&amp;quot;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;.Autoconfiguration complete&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;&amp;hellip;.&amp;quot;&lt;!-- raw HTML omitted -->/delay 3&lt;!-- raw HTML omitted -->#Удаляем остатки предыдущих скриптов, если не удалились&lt;!-- raw HTML omitted -->if ([:len [/file find name~&amp;ldquo;sendMessage&amp;rdquo;]] &amp;gt;0) do={/file remove [/file find name~&amp;ldquo;sendMessage&amp;rdquo;]} else={/log info message=&amp;ldquo;No item for delete&amp;rdquo;}&lt;!-- raw HTML omitted -->if ([:len [/file find name=&amp;quot;$verPrev&amp;quot;]] &amp;gt;0) do={/file remove [/file find name=&amp;quot;$verPrev&amp;quot;]} else={/log info message=&amp;ldquo;No item for delete&amp;rdquo;}&lt;!-- raw HTML omitted -->/delay 3&lt;!-- raw HTML omitted -->#Отправляем уведомление о выполнении&lt;!-- raw HTML omitted -->:local name [/system identity get name]&lt;!-- raw HTML omitted -->/tool fetch keep-result=no url=&amp;ldquo;&lt;a href="https://api.telegram.org/bot-nomer-bota:tut-vasha-ssylka/sendMessage">https://api.telegram.org/bot-nomer-bota:tut-vasha-ssylka/sendMessage&lt;/a>?chat_id=-12345678&amp;amp;text=$ver is complete on $name&amp;rdquo;&lt;!-- raw HTML omitted -->/delay 3&lt;!-- raw HTML omitted -->if ([:len [/file find name~&amp;ldquo;sendMessage&amp;rdquo;]] &amp;gt;0) do={/file remove [/file find name~&amp;ldquo;sendMessage&amp;rdquo;]} else={/log info message=&amp;ldquo;No item for delete&amp;rdquo;}&lt;!-- raw HTML omitted -->/delay 3&lt;!-- raw HTML omitted -->/file remove $ver&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Сначала описывается версия конфига и каким будет следующая версия. Затем после комментария &amp;ldquo;&lt;!-- raw HTML omitted -->#####Тут код конфигурации&lt;!-- raw HTML omitted -->&amp;rdquo; перечисляются команды, которые должен выполнить роутер. Иногда роутер должен выполнить сложный скрипт. На этот случай есть закомментированный блок кода со скриптом. Сам сложный скрипт нужно описать в поле source=&amp;ldquo;tut_sam_script&amp;rdquo;&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->После выполнения команд меняется задание в планировщике - указываем следующую версию скрипта, который надо применить. С этого момента роутер будет пытаться скачать его с сервера. Дальше шлём уведомление и удаляем файлы, которые могли создастся в ходе выполнения задания. Как слать оповещения в Telegram описано на &lt;!-- raw HTML omitted -->бескрайних &lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->просторах &lt;!-- raw HTML omitted -->интернета и повторяться я не буду.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Очень важно предусмотреть в скрипте всё возможное и невозможное и каждая команда должна начинаться с проверки &lt;!-- raw HTML omitted -->if (&amp;hellip;) do={ &lt;!-- raw HTML omitted -->, а заканчиваться &lt;!-- raw HTML omitted -->} else={/log info message=&amp;ldquo;User not exist&amp;rdquo;}&lt;!-- raw HTML omitted --> . У одного из моих роутеров был баг, из-за которого не отображался wireless интерфейс. И без проверки его существования, скрипт просто вываливался с ошибкой. А значит, не менялась запись в планировщике и следующий скрипт тоже не выполнялся.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Перед применением конфигурации на всю сеть нужно проверить правильность написания скрипта - даже опытный скриптописатель может чего-то не учесть и хорошо, если это какая-то мелочь и она не положит всю сеть. Поэтому перед созданием нового файла конфигурации, я проверяю  команды на работающем в продакшене роутере. А затем использую отдельную группу из 20 разнотипных роутеров (в основном это разный тип подключения к сети, остальные настройки везде идентичны) для тестирования скрипта. Эти роутеры опрашивают сервер чаще, чем остальные и после применения настроек я какое-то время наблюдаю за их поведением, а затем распространяю нововведения на остальную сеть.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Чего не хватает в моём подходе:&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Безопасность&lt;!-- raw HTML omitted -->. Хоть доступ на сервер со скриптами ограничен паролем, но этот пароль в открытом виде хранится на роутерах. Вся конфигурация передается по сети в открытом виде. У меня всё это летает внутри шифрованного VPN и я &lt;!-- raw HTML omitted -->запрещаю вам использовать это на нешифрованных публичных каналах&lt;!-- raw HTML omitted -->! Внутреннего нарушителя тоже никто не отменял и внутри VPN это не очень безопасно. &lt;!-- raw HTML omitted -->Можно&lt;!-- raw HTML omitted --> Нужно! использовать https вместо http.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Информативные оповещения&lt;!-- raw HTML omitted -->. При возникновении ошибки, неплохо было бы сообщать о ней&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Возможны только изменения&lt;!-- raw HTML omitted -->. Хочется ещё и читать конфиги и выделять места, отличные от стандарта. Но это задача уже другого класса систем&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->Через полгода после внедрения этой системы, на &lt;!-- raw HTML omitted -->встрече пользователей Mikrotik&lt;!-- raw HTML omitted --> Михаил Москалев   рассказал об аналогичном подходе. Михаил продвинулся дальше и применил модульный подход к конфигурации. Его презентацию можно посмотреть по &lt;!-- raw HTML omitted -->ссылке&lt;!-- raw HTML omitted -->.&lt;!-- raw HTML omitted -->Такой же подход использует система блокировки рекламы для Mikrotik &lt;!-- raw HTML omitted -->&lt;a href="https://stopad.cgood.ru/">https://stopad.cgood.ru/&lt;/a> &lt;!-- raw HTML omitted -->.  &lt;!-- raw HTML omitted -->Постоянный докладчик нашей &lt;!-- raw HTML omitted -->#Sysadminka&lt;!-- raw HTML omitted --> написал свою систему управления конфигурациями. Она доступна на &lt;!-- raw HTML omitted -->github&lt;!-- raw HTML omitted -->. Посмотреть можно на &lt;!-- raw HTML omitted -->YouTube&lt;!-- raw HTML omitted -->.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->В следующем посте я опишу ещё один свой скриптик с использованием Excel, который помогает младшим админам настраивать первичную конфигурацию роутеров без вникания в WinBox и настройки RouterOS.&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->&lt;!-- raw HTML omitted -->P.S.: Видео в посте создано с помощью &lt;!-- raw HTML omitted -->grep &lt;!-- raw HTML omitted -->и &lt;!-- raw HTML omitted -->logstalgia&lt;!-- raw HTML omitted -->.&lt;/p></content></item></channel></rss>